# دليل إدارة الجلسات المحسن

## نظرة عامة

تم تحسين نظام إدارة الجلسات لحل المشاكل التالية:
- فقدان الاتصال عند إعادة تحديث الصفحة
- عدم العودة التلقائية للغرفة السابقة
- مشاكل التمييز بين تسجيل الخروج الصريح وإعادة التحميل
- عدم استمرارية الزوار بشكل مناسب

## الميزات الجديدة

### 1. إدارة التخزين الذكية
- **الأعضاء المسجلون**: يستخدمون `localStorage` للاستمرارية عبر الجلسات
- **الزوار**: يستخدمون `sessionStorage` مع استثناءات ذكية
- **النسخ الاحتياطية**: حفظ في كلا النوعين للتوافق

### 2. تسجيل الخروج الذكي
- **تسجيل خروج صريح**: يمسح جميع البيانات ويضع علامة زمنية
- **إعادة التحميل**: لا يمسح بيانات الأعضاء المسجلين
- **انتهاء الصلاحية**: 7 أيام للأعضاء، 24 ساعة للزوار

### 3. إعادة الاتصال المحسنة
- إعادة اتصال تلقائية عند عودة الشبكة
- إعادة انضمام تلقائية للغرفة السابقة
- مؤشر حالة الاتصال في الواجهة
- زر إعادة اتصال يدوي عند الحاجة

### 4. مراقبة النشاط
- تحديث تلقائي لوقت النشاط
- تقييد التحديثات لتوفير الأداء
- حفظ دوري للجلسة

## الاستخدام

### للمطورين

```typescript
import { 
  saveSession, 
  getSession, 
  clearSession, 
  validateCurrentSession,
  getSessionStats 
} from '@/lib/session';

// حفظ جلسة جديدة
saveSession({
  userId: user.id,
  username: user.username,
  userType: user.userType,
  roomId: 'general'
});

// استرجاع الجلسة
const session = getSession();

// تسجيل خروج صريح
clearSession(true);

// فحص صحة الجلسة
const validation = validateCurrentSession();
if (validation.valid) {
  // الجلسة صحيحة
} else {
  console.log('سبب عدم صحة الجلسة:', validation.reason);
}
```

### للتشخيص

في وحدة التحكم بالمتصفح:

```javascript
// فحص حالة الجلسة
chatSession.stats()

// فحص صحة الجلسة
chatSession.validate()

// مسح الجلسة
chatSession.clear()

// إجبار إعادة الاتصال
chatSession.reconnect()

// فحص حالة Socket
window.isSocketConnected()
```

## التدفق الجديد

### عند تحميل الصفحة
1. فحص وجود جلسة محفوظة
2. التحقق من عدم وجود تسجيل خروج صريح حديث
3. فحص صلاحية الجلسة (انتهاء الوقت)
4. جلب بيانات المستخدم من الخادم للتأكد
5. إعادة الاتصال بـ Socket
6. إعادة الانضمام للغرفة السابقة

### عند تسجيل الخروج
1. وضع علامة تسجيل خروج صريح
2. مسح جميع بيانات الجلسة
3. قطع اتصال Socket
4. إعادة توجيه لشاشة الترحيب

### عند انقطاع الشبكة
1. اكتشاف انقطاع الاتصال
2. عرض مؤشر حالة الاتصال
3. محاولة إعادة الاتصال التلقائية عند عودة الشبكة
4. إعادة المصادقة والانضمام للغرفة

## الملفات المحدثة

- `client/src/lib/socket.ts` - إدارة Socket والجلسات
- `client/src/lib/session.ts` - واجهة موحدة وأدوات تشخيص
- `client/src/pages/chat.tsx` - منطق الاستعادة المحسن
- `client/src/hooks/useChat.ts` - تحسينات الاتصال
- `client/src/hooks/useConnectionStatus.ts` - مراقبة حالة الاتصال
- `client/src/components/ui/ConnectionStatus.tsx` - مؤشر الاتصال
- `client/src/components/chat/ChatInterface.tsx` - إضافة مؤشر الحالة

## الاختبار

### سيناريوهات الاختبار
1. **إعادة التحميل**: تحديث الصفحة والتأكد من العودة للغرفة
2. **تسجيل خروج**: التأكد من مسح البيانات وعدم الإعادة التلقائية
3. **انقطاع الشبكة**: قطع الإنترنت وإعادة تشغيله
4. **تبديل التبويبات**: فتح عدة تبويبات والتنقل بينها
5. **أنواع المستخدمين**: اختبار الأعضاء والزوار بشكل منفصل

### أوامر التشخيص
```javascript
// في وحدة التحكم
chatSession.stats() // عرض إحصائيات مفصلة
chatSession.validate() // فحص صحة الجلسة
window.isSocketConnected() // حالة Socket
```

## الملاحظات المهمة

- الزوار يحتفظون بجلساتهم لمدة 24 ساعة فقط
- الأعضاء المسجلون يحتفظون بجلساتهم لمدة 7 أيام
- تسجيل الخروج الصريح يمسح جميع البيانات فوراً
- النظام يدعم إعادة الاتصال التلقائي عند عودة الشبكة
- مؤشر حالة الاتصال يظهر فقط عند وجود مشاكل