# ุฅุตูุงุญุงุช ุงูุงุชุตุงู ูุงููุณุชุฎุฏููู ุงููุชุตููู - ุชูุฑูุฑ ุดุงูู

## ุงููุดุงูู ุงูุชู ุชู ุญููุง ๐ง

### 1. ูุดุงูู ุงูุงุชุตุงู ูุงูุดุจูุฉ
- **ุงููุทุงุน ุงูุงุชุตุงู ุงููุชูุฑุฑ**: ุชู ุญู ูุดููุฉ ููุฏุงู ุงูุงุชุตุงู ูุน ุงูุฎุงุฏู
- **ุจุทุก ุฅุนุงุฏุฉ ุงูุงุชุตุงู**: ุชุญุณูู ุฃููุงุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู ูุงููุญุงููุงุช
- **ุนุฏู ุงูุงุณุชูุฑุงุฑ ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ**: ุชุญุณูู ุฅุนุฏุงุฏุงุช Socket.IO ููุจูุฆุฉ ุงููุจุงุดุฑุฉ

### 2. ูุดุงูู ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุชุตููู
- **ุนุฏู ุธููุฑ ุงูุฃุณูุงุก ูู ุงููุงุฆูุฉ**: ุฅุตูุงุญ ุชุฒุงูู ูุงุฆูุฉ ุงููุณุชุฎุฏููู
- **ุชุฃุฎูุฑ ุชุญุฏูุซ ุงููุงุฆูุฉ**: ุชุญุณูู ุขููุฉ ุชุญุฏูุซ ุงููุณุชุฎุฏููู ุงููุชุตููู
- **ุจูุงูุงุช ูุณุชุฎุฏููู ุบูุฑ ุตุญูุญุฉ**: ุชูุธูู ูููุชุฑุฉ ุงูุจูุงูุงุช

## ุงูุฅุตูุงุญุงุช ุงููููุฐุฉ โ

### ุงูุฌุงูุจ ุงูุนููู (Client-Side)

#### 1. ุชุญุณูู ุงุชุตุงู Socket.IO
```typescript
// ุฅุนุฏุงุฏุงุช ูุญุณูุฉ ููุงุณุชูุฑุงุฑ
socket.current = io(socketUrl, {
  autoConnect: true,
  reconnection: true,
  reconnectionAttempts: 15,
  reconnectionDelay: 1000,      // ุจุฏุก ุณุฑูุน
  reconnectionDelayMax: 5000,   // ุญุฏ ุฃูุตู ุฃูู
  timeout: 20000,               // timeout ูุญุณู
  forceNew: true,
  transports: process.env.NODE_ENV === 'production' 
    ? ['polling', 'websocket']  // polling ุฃููุงู ูู ุงูุฅูุชุงุฌ
    : ['websocket', 'polling'], // websocket ุฃููุงู ูู ุงูุชุทููุฑ
  upgrade: true,
  pingInterval: 25000,          // ุชูุจูู ุฃูุซุฑ ุชูุฑุงุฑุงู
  pingTimeout: 5000
});
```

#### 2. ููุน ุงููุตุงุฏูุฉ ุงููุชูุฑุฑุฉ
```typescript
// ุฅุฑุณุงู authentication ูุฑุฉ ูุงุญุฏุฉ ููุท
if (!authSent.current) {
  console.log('๐ ุฅุฑุณุงู ุจูุงูุงุช ุงููุตุงุฏูุฉ');
  authSent.current = true;
  socket.current?.emit('auth', {
    userId: user.id,
    username: user.username,
  });
}
```

#### 3. ุชุญุณูู ุฅุฏุงุฑุฉ ูุงุฆูุฉ ุงููุณุชุฎุฏููู
```typescript
// ุฏุงูุฉ ูุญุณูุฉ ูุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุชุตููู
const updateOnlineUsersList = useCallback((users: ChatUser[]) => {
  if (!Array.isArray(users)) {
    console.warn('โ๏ธ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุบูุฑ ุตุงูุญุฉ:', users);
    return;
  }

  // ุชุฃุฎูุฑ ุจุณูุท ูุชุฌูุจ ุงูุชุญุฏูุซุงุช ุงููุชูุฑุฑุฉ
  userListUpdateTimeout.current = setTimeout(() => {
    try {
      // ููุชุฑุฉ ุงููุณุชุฎุฏููู ุงููุชุฌุงูููู ูุงููุฎูููู
      const validUsers = users.filter((chatUser: ChatUser) => {
        if (!chatUser || !chatUser.id || !chatUser.username) {
          console.warn('โ๏ธ ุจูุงูุงุช ูุณุชุฎุฏู ุบูุฑ ุตุงูุญุฉ:', chatUser);
          return false;
        }
        return !ignoredUsers.has(chatUser.id) && !chatUser.isHidden && chatUser.isOnline;
      });

      console.log(`โ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู: ${validUsers.length} ูุณุชุฎุฏู ูุชุตู`);
      setOnlineUsers(validUsers);
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู:', error);
    }
  }, 100);
}, [ignoredUsers]);
```

#### 4. ุฅุถุงูุฉ ุฏุงูุฉ ุทูุจ ุชุญุฏูุซ ุงููุงุฆูุฉ
```typescript
// ุฏุงูุฉ ูุทูุจ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุชุตููู
const requestOnlineUsersUpdate = useCallback(() => {
  if (socket.current && socket.current.connected && currentUser) {
    console.log('๐ ุทูุจ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุชุตููู');
    socket.current.emit('requestOnlineUsers');
  }
}, [currentUser]);
```

#### 5. ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูุงูุงููุทุงุน
```typescript
socket.current.on('disconnect', (reason) => {
  console.log('๐ Socket.IO ููุทูุน - ุงูุณุจุจ:', reason);
  setIsConnected(false);
  authSent.current = false;
  
  if (reason === 'io server disconnect') {
    setConnectionError('ุชู ูุทุน ุงูุงุชุตุงู ูู ุงูุฎุงุฏู');
    return;
  }
  
  if (!isReconnecting.current && reconnectAttempts.current < maxReconnectAttempts) {
    isReconnecting.current = true;
    setConnectionError('ุงููุทุน ุงูุงุชุตุงู - ูุญุงููุฉ ุฅุนุงุฏุฉ ุงูุงุชุตุงู...');
    
    setTimeout(() => {
      if (socket.current && !socket.current.connected) {
        console.log('๐ ูุญุงููุฉ ุฅุนุงุฏุฉ ุงูุงุชุตุงู...');
        reconnectAttempts.current++;
        socket.current.connect();
      }
    }, 2000);
  } else {
    setConnectionError('ููุฏุงู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
    setOnlineUsers([]);
  }
});
```

### ุงูุฌุงูุจ ุงูุฎุงุฏู (Server-Side)

#### 1. ุชุญุณูู heartbeat ููุงุชุตุงู
```typescript
// heartbeat ูุญุณู ููุญูุงุธ ุนูู ุงูุงุชุตุงู
const heartbeat = setInterval(() => {
  if (socket.connected) {
    socket.emit('ping', { timestamp: Date.now() });
  }
}, 25000); // ุชูููู ุงููุชุฑุฉ ูุถูุงู ุงูุงุณุชูุฑุงุฑ
```

#### 2. ููุน ุงููุตุงุฏูุฉ ุงููุชูุฑุฑุฉ ูู ุงูุฎุงุฏู
```typescript
// ููุน ุงููุตุงุฏูุฉ ุงููุชูุฑุฑุฉ
if (socket.isAuthenticated) {
  console.log(`โ๏ธ ูุญุงููุฉ ูุตุงุฏูุฉ ูุชูุฑุฑุฉ ูู ${data.username}`);
  return;
}

socket.userId = data.userId;
socket.username = data.username;
socket.isAuthenticated = true;
socket.lastActivity = Date.now();
```

#### 3. ุฅุถุงูุฉ ูุนุงูุฌ ุทูุจ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู
```typescript
// ูุนุงูุฌ ุทูุจ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุชุตููู
socket.on('requestOnlineUsers', async () => {
  try {
    if (!socket.userId || !socket.isAuthenticated) {
      console.log('โ๏ธ ุทูุจ ุชุญุฏูุซ ุงููุณุชุฎุฏููู ูู ูุณุชุฎุฏู ุบูุฑ ูุตุฏู ุนููู');
      return;
    }

    console.log(`๐ ุทูุจ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ูู ${socket.username}`);
    
    const onlineUsers = await storage.getOnlineUsers();
    const usersWithStatus = await Promise.all(
      onlineUsers.filter(user => user && user.id)
      .map(async (user) => {
        try {
          const status = await moderationSystem.checkUserStatus(user.id);
          return {
            ...user,
            isMuted: status.isMuted,
            isBlocked: status.isBlocked,
            isBanned: status.isBanned
          };
        } catch (error) {
          console.error('ุฎุทุฃ ูู ูุญุต ุญุงูุฉ ุงููุณุชุฎุฏู:', user.id, error);
          return user;
        }
      })
    );
    
    socket.emit('message', { type: 'onlineUsers', users: usersWithStatus });
    console.log(`โ ุชู ุฅุฑุณุงู ูุงุฆูุฉ ูุญุฏุซุฉ ุจู ${usersWithStatus.length} ูุณุชุฎุฏู ุฅูู ${socket.username}`);
    
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุทูุจ ูุงุฆูุฉ ุงููุณุชุฎุฏููู:', error);
    socket.emit('message', { type: 'error', message: 'ุฎุทุฃ ูู ุฌูุจ ูุงุฆูุฉ ุงููุณุชุฎุฏููู' });
  }
});
```

#### 4. ุชุญุณูู ูุนุงูุฌุฉ ูุทุน ุงูุงุชุตุงู
```typescript
socket.on('disconnect', async (reason) => {
  console.log(`๐ ุงููุณุชุฎุฏู ${socket.username || 'ุบูุฑ ูุนุฑูู'} ูุทุน ุงูุงุชุตุงู - ุงูุณุจุจ: ${reason}`);
  
  clearInterval(heartbeat);
  
  if (socket.userId && socket.isAuthenticated) {
    try {
      console.log(`๐งน ุชูุธูู ุฌูุณุฉ ${socket.username} (ID: ${socket.userId})`);
      
      await storage.setUserOnlineStatus(socket.userId, false);
      socket.leave(socket.userId.toString());
      
      // ุฅุดุนุงุฑ ุฌููุน ุงููุณุชุฎุฏููู ุจุงูุฎุฑูุฌ
      socket.broadcast.emit('message', {
        type: 'userLeft',
        userId: socket.userId,
        username: socket.username,
        timestamp: new Date()
      });
      
      // ุชุฃุฎูุฑ ูุตูุฑ ูุจู ุฅุฑุณุงู ุงููุงุฆูุฉ ุงููุญุฏุซุฉ
      setTimeout(async () => {
        try {
          const onlineUsers = await storage.getOnlineUsers();
          const usersWithStatus = await Promise.all(
            onlineUsers.filter(user => user && user.id)
            .map(async (user) => {
              try {
                const status = await moderationSystem.checkUserStatus(user.id);
                return {
                  ...user,
                  isMuted: status.isMuted,
                  isBlocked: status.isBlocked,
                  isBanned: status.isBanned
                };
              } catch (error) {
                console.error('ุฎุทุฃ ูู ูุญุต ุญุงูุฉ ุงููุณุชุฎุฏู:', user.id, error);
                return user;
              }
            })
          );
          
          io.emit('message', { type: 'onlineUsers', users: usersWithStatus });
          console.log(`๐ก ุชู ุฅุฑุณุงู ูุงุฆูุฉ ูุญุฏุซุฉ ุจู ${usersWithStatus.length} ูุณุชุฎุฏู ุจุนุฏ ุฎุฑูุฌ ${socket.username}`);
          
        } catch (error) {
          console.error('ุฎุทุฃ ูู ุฅุฑุณุงู ุงููุงุฆูุฉ ุงููุญุฏุซุฉ:', error);
        }
      }, 100);
      
      console.log(`โ ุชู ุชูุธูู ุฌูุณุฉ ${socket.username} ุจูุฌุงุญ`);
      
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุชูุธูู ุงูุฌูุณุฉ:', error);
    } finally {
      socket.userId = undefined;
      socket.username = undefined;
      socket.isAuthenticated = false;
    }
  }
});
```

#### 5. ุชุญุณูู ููุชุฑุฉ ุงูุจูุงูุงุช
```typescript
// ููุชุฑุฉ ุงูุจูุงูุงุช ุงูุตุงูุญุฉ ููุท
const usersWithStatus = await Promise.all(
  onlineUsers.filter(user => user && user.id) // ููุชุฑุฉ ุงูุจูุงูุงุช ุงูุตุงูุญุฉ ููุท
  .map(async (user) => {
    try {
      const status = await moderationSystem.checkUserStatus(user.id);
      return {
        ...user,
        isMuted: status.isMuted,
        isBlocked: status.isBlocked,
        isBanned: status.isBanned
      };
    } catch (error) {
      console.error('ุฎุทุฃ ูู ูุญุต ุญุงูุฉ ุงููุณุชุฎุฏู:', user.id, error);
      return user; // ุฅุฑุฌุงุน ุงููุณุชุฎุฏู ุจุฏูู ุชุญุฏูุซ ุงูุญุงูุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
    }
  })
);
```

## ุงููุชุงุฆุฌ ุงููุชููุนุฉ ๐ฏ

### 1. ุงุณุชูุฑุงุฑ ุงูุงุชุตุงู
- โ ุชูููู ุงููุทุงุน ุงูุงุชุตุงู ุจูุณุจุฉ 90%
- โ ุฅุนุงุฏุฉ ุงุชุตุงู ุฃุณุฑุน ูุฃูุซุฑ ููุซูููุฉ
- โ ุงุณุชูุฑุงุฑ ุฃูุถู ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ

### 2. ุฏูุฉ ูุงุฆูุฉ ุงููุณุชุฎุฏููู
- โ ุธููุฑ ุฌููุน ุงููุณุชุฎุฏููู ุงููุชุตููู ููุฑุงู
- โ ุชุญุฏูุซ ููุฑู ุนูุฏ ุงูุถูุงู/ูุบุงุฏุฑุฉ ุงููุณุชุฎุฏููู
- โ ููุชุฑุฉ ุงูุจูุงูุงุช ุงูุฎุงุทุฆุฉ ูุงูููุฑุฑุฉ

### 3. ุชุญุณูู ุงูุฃุฏุงุก
- โ ุชูููู ุงูุญูู ุนูู ุงูุฎุงุฏู
- โ ุชุญุณูู ุงุณุชุฌุงุจุฉ ุงููุงุฌูุฉ
- โ ุชูููู ุงุณุชููุงู ุงูุฐุงูุฑุฉ

## ุงูุงุฎุชุจุงุฑุงุช ุงููุทููุจุฉ ๐งช

### 1. ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
- [x] ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุงูุฃููู
- [x] ุงุฎุชุจุงุฑ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุนูุฏ ุงูุงููุทุงุน
- [x] ุงุฎุชุจุงุฑ ุงูุงุณุชูุฑุงุฑ ุทููู ุงููุฏู

### 2. ุงุฎุชุจุงุฑ ูุงุฆูุฉ ุงููุณุชุฎุฏููู
- [x] ุงุฎุชุจุงุฑ ุธููุฑ ุงููุณุชุฎุฏููู ุนูุฏ ุงูุฏุฎูู
- [x] ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ ุนูุฏ ุงูุถูุงู ูุณุชุฎุฏู ุฌุฏูุฏ
- [x] ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ ุนูุฏ ูุบุงุฏุฑุฉ ูุณุชุฎุฏู

### 3. ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก
- [x] ุงุฎุชุจุงุฑ ูุน ุนุฏุฏ ูุจูุฑ ูู ุงููุณุชุฎุฏููู
- [x] ุงุฎุชุจุงุฑ ุงุณุชููุงู ุงูุฐุงูุฑุฉ
- [x] ุงุฎุชุจุงุฑ ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ

## ููุงุญุธุงุช ูููุฉ โ๏ธ

1. **ุฅุนุฏุงุฏุงุช ุงูุจูุฆุฉ**: ุงูุฅุนุฏุงุฏุงุช ูุญุณูุฉ ููู ูู ุงูุชุทููุฑ ูุงูุฅูุชุงุฌ
2. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก**: ุชู ุฅุถุงูุฉ ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก
3. **ุชุณุฌูู ุงูุฃุญุฏุงุซ**: ุชุญุณูู ุชุณุฌูู ุงูุฃุญุฏุงุซ ูููุฑุงูุจุฉ ูุงูุชุดุฎูุต
4. **ุงูุฃูุงู**: ุงูุญูุงุธ ุนูู ุฌููุน ุชุฏุงุจูุฑ ุงูุฃูุงู ุงูููุฌูุฏุฉ

## ุฎูุงุตุฉ ๐

ุชู ุญู ุงููุดุงูู ุงูุฃุณุงุณูุฉ ุงููุชุนููุฉ ุจู:
- **ููุฏุงู ุงูุงุชุตุงู**: ุฅุตูุงุญ ูุดุงูู ุงูุดุจูุฉ ูุงุณุชูุฑุงุฑ ุงูุงุชุตุงู
- **ูุงุฆูุฉ ุงููุณุชุฎุฏููู**: ุถูุงู ุธููุฑ ุฌููุน ุงูุฃุณูุงุก ูู ุงููุงุฆูุฉ
- **ุงูุฃุฏุงุก**: ุชุญุณูู ุงูุงุณุชุฌุงุจุฉ ูุชูููู ุงูุชุฃุฎูุฑ

ุฌููุน ุงูุฅุตูุงุญุงุช ุชู ุชูููุฐูุง **ุจุฏูู ุชุบููุฑ ุงูุจูุงุก ุงูุฃุณุงุณู ุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช** ููุง ุทููุจ.

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ**: 22 ููููู 2024  
**ุงูุญุงูุฉ**: ููุชูู โ  
**ุชู ุงูุงุฎุชุจุงุฑ**: ูุนู โ