<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>اختبار التيجان المُحسّنة - نظام عالمي احترافي</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 20px;
      min-height: 100vh;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }
    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .tile { 
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .tile:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .label { 
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      background: rgba(255,255,255,0.2);
      padding: 8px 15px;
      border-radius: 20px;
      width: 100%;
    }
    .sizes-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
    .size-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .size-label {
      font-size: 11px;
      opacity: 0.8;
      font-weight: 500;
    }
    .avatar-container { 
      position: relative;
      display: inline-block;
    }
    .img { 
      display: block;
      border-radius: 50%;
      object-fit: cover;
      background: #1a1a2e;
      border: 3px solid rgba(255,255,255,0.3);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .frame-container {
      position: relative;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      padding: 5px;
    }
    .frame { 
      position: absolute;
      inset: 0;
      border-radius: 50%;
      pointer-events: none;
      z-index: 2;
    }
    .tag { 
      position: absolute;
      left: 50%;
      pointer-events: none;
      z-index: 4;
      background: transparent;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
    }
    .note { 
      text-align: center;
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      backdrop-filter: blur(10px);
    }
    .legend {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 15px;
      margin-top: 30px;
      backdrop-filter: blur(10px);
    }
    .legend h3 {
      margin-bottom: 15px;
      font-size: 1.3em;
    }
    .legend ul {
      list-style: none;
      padding: 0;
    }
    .legend li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .legend li:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>👑 نظام التيجان الاحترافي</h1>
    <p>اختبار شامل لجميع التيجان الـ12 - نظام عالمي مثل المواقع الكبرى</p>
  </div>

  <div class="note">
    ✨ <strong>النظام الجديد المُحسّن:</strong> كل تاج يلبس على الصورة بشكل مثالي - القاعدة تدخل 8-18% في الصورة حسب التصميم
  </div>

  <div id="app" class="grid"></div>

  <div class="legend">
    <h3>📊 معلومات النظام</h3>
    <ul>
      <li><strong>anchorY:</strong> نسبة من التاج تدخل في الصورة (0.08 = 8% إلى 0.18 = 18%)</li>
      <li><strong>autoAnchor:</strong> يزيل الشفافية السفلية تلقائياً ✓</li>
      <li><strong>yAdjustPx:</strong> ضبط نهائي يدوي (سالب = رفع للأعلى)</li>
      <li><strong>widthRatio:</strong> نسبة عرض التاج (0.58 إلى 0.68)</li>
    </ul>
  </div>

  <script>
    // التكوين الجديد المُحسّن - مطابق 100% للكود الفعلي
    const TAG_LAYOUTS = {
      1:  { widthRatio: 1.10, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.12, autoAnchor: true },
      2:  { widthRatio: 1.08, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.12, autoAnchor: true },
      3:  { widthRatio: 1.06, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.11, autoAnchor: true },
      4:  { widthRatio: 1.10, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.13, autoAnchor: true },
      5:  { widthRatio: 1.07, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.12, autoAnchor: true },
      6:  { widthRatio: 1.12, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.15, autoAnchor: true },
      7:  { widthRatio: 1.10, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.13, autoAnchor: true },
      8:  { widthRatio: 1.08, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.12, autoAnchor: true },
      9:  { widthRatio: 1.11, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.14, autoAnchor: true },
      10: { widthRatio: 1.06, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.11, autoAnchor: true },
      11: { widthRatio: 1.07, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.12, autoAnchor: true },
      12: { widthRatio: 1.10, xAdjustPx: 0, yAdjustPx: 0,  anchorY: 0.15, autoAnchor: true },
    };

    const sizes = [36, 56, 72];
    const withFrame = [false, true];

    function frameSrc(idx) { return `/frames/frame${idx}.webp`; }

    // محاكاة autoAnchor - كشف الشفافية السفلية
    function detectBottomGap(img, scale) {
      try {
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        if (!ctx) return 0;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        
        const alphaThreshold = 12;
        for (let y = canvas.height - 1; y >= 0; y--) {
          const row = ctx.getImageData(0, y, canvas.width, 1).data;
          let opaque = false;
          for (let x = 0; x < canvas.width; x++) {
            if (row[x * 4 + 3] > alphaThreshold) {
              opaque = true;
              break;
            }
          }
          if (opaque) {
            return (canvas.height - 1 - y) * scale;
          }
        }
        return 0;
      } catch {
        return 0;
      }
    }

    const app = document.getElementById('app');

    for (let tag = 1; tag <= 12; tag++) {
      const tile = document.createElement('div');
      tile.className = 'tile';

      const label = document.createElement('div');
      label.className = 'label';
      const cfg = TAG_LAYOUTS[tag];
      label.innerHTML = `تاج ${tag}<br>
        <small>anchorY: ${(cfg.anchorY * 100).toFixed(0)}% | 
        yAdj: ${cfg.yAdjustPx}px | 
        width: ${(cfg.widthRatio * 100).toFixed(0)}%</small>`;
      tile.appendChild(label);

      const sizesContainer = document.createElement('div');
      sizesContainer.className = 'sizes-container';

      for (const px of sizes) {
        const sizeBox = document.createElement('div');
        sizeBox.className = 'size-box';

        const sizeLabel = document.createElement('div');
        sizeLabel.className = 'size-label';
        sizeLabel.textContent = `${px}px`;
        sizeBox.appendChild(sizeLabel);

        // بدون إطار
        const avatar1 = createAvatar(tag, px, false, cfg);
        sizeBox.appendChild(avatar1);

        sizesContainer.appendChild(sizeBox);
      }

      tile.appendChild(sizesContainer);
      app.appendChild(tile);
    }

    function createAvatar(tag, px, hasFrame, cfg) {
      const container = document.createElement('div');
      container.className = 'avatar-container';
      
      if (hasFrame) {
        const containerSize = Math.round(px * 1.35);
        container.style.width = containerSize + 'px';
        container.style.height = containerSize + 'px';
        
        const frameContainer = document.createElement('div');
        frameContainer.className = 'frame-container';
        frameContainer.style.width = containerSize + 'px';
        frameContainer.style.height = containerSize + 'px';
        
        const img = document.createElement('img');
        img.src = '/default_avatar.svg';
        img.className = 'img';
        img.style.width = px + 'px';
        img.style.height = px + 'px';
        img.style.position = 'absolute';
        img.style.left = '50%';
        img.style.transform = 'translateX(-50%)';
        img.style.top = Math.round((containerSize - px) / 2) + 'px';
        
        const frame = document.createElement('img');
        frame.src = frameSrc(1);
        frame.className = 'frame';
        
        const tagImg = createTagElement(tag, px, cfg, Math.round((containerSize - px) / 2));
        
        frameContainer.appendChild(img);
        frameContainer.appendChild(frame);
        frameContainer.appendChild(tagImg);
        container.appendChild(frameContainer);
      } else {
        container.style.width = px + 'px';
        container.style.height = px + 'px';
        
        const img = document.createElement('img');
        img.src = '/default_avatar.svg';
        img.className = 'img';
        img.style.width = px + 'px';
        img.style.height = px + 'px';
        
        const tagImg = createTagElement(tag, px, cfg, 0);
        
        container.appendChild(img);
        container.appendChild(tagImg);
      }
      
      return container;
    }

    function createTagElement(tag, basePx, cfg, overlayTopPx) {
      const tagImg = document.createElement('img');
      tagImg.src = `/tags/tag${tag}.webp`;
      tagImg.className = 'tag';
      
      const minCoverRatio = 1.06;
      const maxCoverRatio = 1.18;
      const targetRatio = cfg.widthRatio || minCoverRatio;
      const clampedRatio = Math.min(Math.max(targetRatio, minCoverRatio), maxCoverRatio);
      const overlayWidthPx = Math.round(basePx * clampedRatio);
      tagImg.style.width = overlayWidthPx + 'px';
      tagImg.style.top = overlayTopPx + 'px';
      tagImg.style.marginLeft = (cfg.xAdjustPx || 0) + 'px';
      
      // الحساب الصحيح الجديد
      tagImg.onload = function() {
        const scale = overlayWidthPx / tagImg.naturalWidth;
        const tagRenderedHeight = tagImg.naturalHeight * scale;
        
        let bottomGapPx = 0;
        if (cfg.autoAnchor) {
          bottomGapPx = detectBottomGap(tagImg, scale);
        }
        
        const anchorFromLayout = (cfg.anchorY || 0) * tagRenderedHeight;
        
        // المعادلة المصححة
        const totalOffset = Math.max(0, tagRenderedHeight - bottomGapPx + (cfg.yAdjustPx || 0) + anchorFromLayout);
        
        tagImg.style.transform = `translate(-50%, calc(-100% + ${totalOffset}px))`;
      };
      
      return tagImg;
    }
  </script>
</body>
</html>
