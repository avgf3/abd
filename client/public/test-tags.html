<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>اختبار بصري — تاج 1، 8، 10، 21، 28، 34</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2e;
      --muted: #9bb0d3;
      --text: #e6ecff;
      --accent: #54a0ff;
    }
    html, body { margin:0; padding:0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Cairo, Noto Naskh Arabic UI, sans-serif; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    p { color: var(--muted); margin: 8px 0 16px; line-height: 1.8; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: var(--panel); border-radius: 12px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
    .title { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; }
    .title h2 { margin: 0; font-size: 16px; }
    .title .meta { color: var(--muted); font-size: 12px; }

    .row { display: flex; align-items: center; gap: 16px; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.06); }
    .row:first-of-type { border-top: none; }

    .avatar-wrap { position: relative; contain: layout style; isolation: isolate; overflow: visible; display: inline-block; }
    .pic { display:block; border-radius: 9999px; object-fit: cover; background: #0b1220; box-shadow: 0 1px 2px rgba(0,0,0,0.2) inset; }

    /* مطابق لـ index.css .profile-tag-overlay */
    .profile-tag-overlay {
      position: absolute;
      left: 50%;
      height: auto;
      z-index: 4;
      pointer-events: none;
      background: transparent !important;
      background-color: transparent !important;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      -webkit-backface-visibility: hidden; backface-visibility: hidden;
      will-change: auto; transform: translateZ(0);
      contain: layout style paint;
      transform-origin: 50% 100%;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      transition: none !important;
    }

    .info { min-width: 220px; font-size: 12px; color: var(--muted); }
    .kv { display:grid; grid-template-columns: auto 1fr; gap: 6px 10px; }
    .kv b { color: var(--text); font-weight: 600; }
    .badge { display:inline-block; padding: 2px 6px; border-radius: 9999px; background: rgba(84,160,255,0.15); color: #cfe3ff; font-size: 11px; }
    .note { color: #ffd68a; font-size: 12px; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>اختبار بصري — ضبط تاج 1، 8، 10، 21، 28، 34</h1>
    <p>
      هذه الصفحة تطبّق نفس معادلة التموضع من الكود الفعلي، لعرض نتيجة التيجان <b>1</b>، <b>8</b>، <b>10</b>، <b>21</b>، <b>28</b> و <b>34</b> على ثلاث قياسات للصورة: 36/56/72 بكسل.
      الهدف: التأكد أن التيجان تلبس الصورة بشكل طبيعي كـ "طوق رأس" وقياس نزول إضافي خاص للبروفايل لتيجان 21–34.
    </p>

    <div class="grid">
      <div class="card" id="card-1">
        <div class="title">
          <h2>تاج 1 <span class="badge">tag1.webp</span></h2>
          <span class="meta" id="meta-1"></span>
        </div>
        <div id="rows-1"></div>
      </div>
      <div class="card" id="card-8">
        <div class="title">
          <h2>تاج 8 <span class="badge">tag8.webp</span></h2>
          <span class="meta" id="meta-8"></span>
        </div>
        <div id="rows-8"></div>
      </div>
    </div>
    
    <div class="grid" style="margin-top: 16px;">
      <div class="card" id="card-10">
        <div class="title">
          <h2>تاج 10 <span class="badge">tag10.webp</span></h2>
          <span class="meta" id="meta-10"></span>
        </div>
        <div id="rows-10"></div>
      </div>
      <div class="card" id="card-21">
        <div class="title">
          <h2>تاج 21 <span class="badge">tag21.webp</span></h2>
          <span class="meta" id="meta-21"></span>
        </div>
        <div id="rows-21"></div>
      </div>
      <div class="card" id="card-28">
        <div class="title">
          <h2>تاج 28 <span class="badge">tag28.webp</span></h2>
          <span class="meta" id="meta-28"></span>
        </div>
        <div id="rows-28"></div>
      </div>
      <div class="card" id="card-34">
        <div class="title">
          <h2>تاج 34 <span class="badge">tag34.webp</span></h2>
          <span class="meta" id="meta-34"></span>
        </div>
        <div id="rows-34"></div>
      </div>
    </div>

    <p class="note">ملاحظة: يتم حساب هامش الشفافية السفلي تلقائياً من صورة التاج (autoAnchor) عبر Canvas، تماماً مثل التطبيق.</p>
  </div>

  <script>
    // نفس الحسبة المستخدمة داخل ProfileImage.tsx مع تبسيط العرض
    const SIZES = [36, 56, 72];

    // استنساخ مبسّط لتخطيطات tagLayouts.ts (القيم المُصححة)
    const TAG_LAYOUTS = {
      1:  { widthRatio: 1.10, xAdjustPx: 0, yAdjustPx: 4, anchorY: 0.54, autoAnchor: true },
      8:  { widthRatio: 1.10, xAdjustPx: 0, yAdjustPx: 4, anchorY: 0.54, autoAnchor: true },
      10: { widthRatio: 1.10, xAdjustPx: 0, yAdjustPx: 3, anchorY: 0.42, autoAnchor: true },
      // 21–30: anchorY 0.37, yAdjust 1
      21: { widthRatio: 1.10, xAdjustPx: 0, yAdjustPx: 1, anchorY: 0.37, autoAnchor: true },
      28: { widthRatio: 1.10, xAdjustPx: 0, yAdjustPx: 1, anchorY: 0.37, autoAnchor: true },
      // 31–40: anchorY 0.40, yAdjust 1, widthRatio 1.11
      34: { widthRatio: 1.11, xAdjustPx: 0, yAdjustPx: 1, anchorY: 0.40, autoAnchor: true },
    };

    const AVATAR_SRC = '/default_avatar.svg';
    const TAG_SRC = {
      1: '/tags/tag1.webp',
      8: '/tags/tag8.webp',
      10: '/tags/tag10.webp',
      21: '/tags/tag21.webp',
      28: '/tags/tag28.webp',
      34: '/tags/tag34.webp',
    };

    function createRow(tagNumber, px, layout, bottomGapRatio, naturalTagSize) {
      const containerSize = Math.round(px * 1.35);
      const imageTopWithinContainer = Math.round((containerSize - px) / 2);
      const basePx = Math.round(px * layout.widthRatio);

      // حساب anchorFromImagePx بنفس المنطق
      const scale = basePx / Math.max(1, naturalTagSize.w);
      const heightPx = naturalTagSize.h * scale;
      const bottomGapPx = (layout.autoAnchor ? Math.round(bottomGapRatio * heightPx) : 0);
      const isTouchTop = false; // لم نعد نحتاج touchTop مع الإعدادات الجديدة
      const anchor = isTouchTop ? bottomGapPx : Math.round(heightPx * (layout.anchorY ?? 0.08));
      // تطبيق نزول إضافي خاص بالبروفايل لتيجان 21–34 لمضاهاة الكود الفعلي
      const extraProfileDownshift = (tagNumber >= 21 && tagNumber <= 34)
        ? Math.min(18, Math.max(6, Math.round(px * 0.12)))
        : 0;
      const anchorFromImagePx = Math.round(anchor + (layout.yAdjustPx || 0) + extraProfileDownshift - bottomGapPx);

      const row = document.createElement('div');
      row.className = 'row';

      const avatarWrap = document.createElement('div');
      avatarWrap.className = 'avatar-wrap';
      avatarWrap.style.width = containerSize + 'px';
      avatarWrap.style.height = containerSize + 'px';

      const img = document.createElement('img');
      img.src = AVATAR_SRC;
      img.className = 'pic';
      img.alt = 'avatar';
      img.width = px; img.height = px;
      img.style.width = px + 'px'; img.style.height = px + 'px';
      img.style.position = 'absolute';
      img.style.top = imageTopWithinContainer + 'px';
      img.style.left = (containerSize - px)/2 + 'px';

      const tag = document.createElement('img');
      tag.src = TAG_SRC[tagNumber];
      tag.className = 'profile-tag-overlay';
      tag.alt = 'tag';
      tag.style.top = imageTopWithinContainer + 'px';
      tag.style.width = basePx + 'px';
      tag.style.transform = `translate(-50%, calc(-100% + ${anchorFromImagePx}px))`;
      tag.style.marginLeft = (layout.xAdjustPx || 0) + 'px';

      const info = document.createElement('div');
      info.className = 'info';
      info.innerHTML = `
        <div class="kv">
          <span>حجم الصورة</span><b>${px}px</b>
          <span>container</span><b>${containerSize}px</b>
          <span>basePx</span><b>${basePx}px</b>
          <span>anchorY</span><b>${(layout.anchorY * 100).toFixed(1)}%</b>
          <span>yAdjustPx</span><b>${layout.yAdjustPx || 0}px</b>
          <span>bottomGap</span><b>${(bottomGapRatio * 100).toFixed(1)}%</b>
          <span>translateY</span><b>-100% + ${anchorFromImagePx}px</b>
        </div>
      `;

      avatarWrap.appendChild(img);
      avatarWrap.appendChild(tag);
      row.appendChild(avatarWrap);
      row.appendChild(info);
      return row;
    }

    async function measureBottomGapRatio(src) {
      // مسح سريع لاستخراج نسبة الشفافية السفلية (مثل الكود الفعلي)
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          try {
            const maxW = 96;
            const scale = Math.min(1, maxW / img.naturalWidth);
            const cw = Math.max(1, Math.floor(img.naturalWidth * scale));
            const ch = Math.max(1, Math.floor(img.naturalHeight * scale));
            const canvas = document.createElement('canvas');
            canvas.width = cw; canvas.height = ch;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, cw, ch);
            const { data } = ctx.getImageData(0, 0, cw, ch);
            let gapRows = 0; const stride = 4; const stepX = Math.max(1, Math.floor(cw / 24));
            const tagNum = window.currentTagNumber || 0;
            const centerRatio = (tagNum === 1 || tagNum === 8) ? 0.6 : 1;
            const xStart = Math.floor(((1 - centerRatio) / 2) * cw);
            const xEnd = Math.ceil(cw - xStart);
            scan: for (let y = ch - 1; y >= 0; y--) {
              let rowTransparent = true;
              for (let x = xStart; x < xEnd; x += stepX) {
                const alpha = data[(y * cw + x) * stride + 3];
                if (alpha > 8) { rowTransparent = false; break; }
              }
              if (rowTransparent) gapRows++; else break scan;
            }
            const ratio = gapRows / ch;
            resolve(Number.isFinite(ratio) ? Math.max(0, Math.min(0.5, ratio)) : 0);
          } catch (e) {
            resolve(0);
          }
        };
        img.onerror = () => resolve(0);
        img.src = src;
      });
    }

    async function main() {
      // حمّل صور التاجين لاستخراج أبعادهم الطبيعية أيضاً
      const naturalSizes = {};
      const bottomRatios = {};

      await Promise.all([1,8,10,21,28,34].map(tagNumber => new Promise((resolve) => {
        const img = new Image();
        img.onload = async () => {
          naturalSizes[tagNumber] = { w: img.naturalWidth, h: img.naturalHeight };
          // اجعل رقم التاج متاحاً لوظيفة القياس لتطبيق center scan
          window.currentTagNumber = tagNumber;
          bottomRatios[tagNumber] = await measureBottomGapRatio(TAG_SRC[tagNumber]);
          resolve();
        };
        img.onerror = () => { naturalSizes[tagNumber] = { w: 600, h: 400 }; bottomRatios[tagNumber] = 0; resolve(); };
        img.src = TAG_SRC[tagNumber];
      })));

      // تعبئة البطاقات
      [1,8,10,21,28,34].forEach((tagNumber) => {
        const layout = TAG_LAYOUTS[tagNumber];
        const metaEl = document.getElementById('meta-' + tagNumber);
        metaEl.textContent = `widthRatio ${layout.widthRatio} • anchorY ${(layout.anchorY*100).toFixed(1)}% • yAdjust ${layout.yAdjustPx||0}px`;

        const rowsEl = document.getElementById('rows-' + tagNumber);
        rowsEl.innerHTML = '';
        SIZES.forEach((px) => {
          const row = createRow(tagNumber, px, layout, bottomRatios[tagNumber], naturalSizes[tagNumber]);
          rowsEl.appendChild(row);
        });
      });
    }

    main();
  </script>
</body>
</html>
