import { useState, useEffect } from 'react';
import UserSidebarWithWalls from './UserSidebarWithWalls';
import MessageArea from './MessageArea';
import BroadcastRoomInterface from './BroadcastRoomInterface';
import ProfileModal from './ProfileModal';
import PrivateMessageBox from './PrivateMessageBox';
import UserPopup from './UserPopup';
import SettingsMenu from './SettingsMenu';
import ReportModal from './ReportModal';
import AdminReportsPanel from './AdminReportsPanel';
import NotificationPanel from './NotificationPanel';
import FriendsPanel from './FriendsPanelSimple';
import FriendRequestBadge from './FriendRequestBadge';
import MessagesPanel from './MessagesPanel';
import MessageAlert from './MessageAlert';
import ModerationPanel from './ModerationPanel';
import ReportsLog from '../moderation/ReportsLog';
import ActiveModerationLog from '../moderation/ActiveModerationLog';
import KickNotification from '../moderation/KickNotification';
import BlockNotification from '../moderation/BlockNotification';
import PromoteUserPanel from '../moderation/PromoteUserPanel';
import OwnerAdminPanel from './OwnerAdminPanel';
import ProfileImage from './ProfileImage';
import StealthModeToggle from './StealthModeToggle';
import WelcomeNotification from './WelcomeNotification';
import ThemeSelector from './ThemeSelector';
import RoomsPanel from './RoomsPanel';

import { Button } from '@/components/ui/button';
import { useToast } from '@/hooks/use-toast';
import { apiRequest } from '@/lib/queryClient';
import type { useChat } from '@/hooks/useChat';
import type { ChatUser, ChatRoom } from '@/types/chat';

interface ChatInterfaceProps {
  chat: ReturnType<typeof useChat>;
  onLogout: () => void;
}

export default function ChatInterface({ chat, onLogout }: ChatInterfaceProps) {
  const [showProfile, setShowProfile] = useState(false);
  const [profileUser, setProfileUser] = useState<ChatUser | null>(null);
  const [showSettings, setShowSettings] = useState(false);
  const [selectedPrivateUser, setSelectedPrivateUser] = useState<ChatUser | null>(null);
  const [showReportModal, setShowReportModal] = useState(false);
  const [showAdminReports, setShowAdminReports] = useState(false);
  const [activeView, setActiveView] = useState<'hidden' | 'users' | 'walls' | 'rooms'>('users'); // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã
  
  // ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∫ÿ±ŸÅ
  const [rooms, setRooms] = useState<ChatRoom[]>([]);
  const [roomsLoading, setRoomsLoading] = useState(true);

  // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ currentRoomId ŸÖŸÜ chat hook ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
  const currentRoomId = chat.currentRoomId;

  // ÿ¨ŸÑÿ® ÿßŸÑÿ∫ÿ±ŸÅ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ
  const fetchRooms = async () => {
    try {
      console.log('üîÑ ÿ¨ŸÑÿ® ÿßŸÑÿ∫ÿ±ŸÅ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ...');
      setRoomsLoading(true);
      
      const data = await apiRequest('/api/rooms');
      console.log('üìä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑŸÖŸèÿ≥ÿ™ŸÑŸÖÿ©:', data);
      
      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿµÿ≠Ÿäÿ≠
      const roomsData = data.rooms || data.data || data;
      
      if (roomsData && Array.isArray(roomsData)) {
        const formattedRooms = roomsData.map((room: any) => ({
          id: room.id,
          name: room.name,
          description: room.description || '',
          isDefault: room.isDefault || room.is_default || false,
          createdBy: room.createdBy || room.created_by,
          createdAt: new Date(room.createdAt || room.created_at),
          isActive: room.isActive || room.is_active || true,
          userCount: room.userCount || room.user_count || 0,
          icon: room.icon || '',
          isBroadcast: room.isBroadcast || room.is_broadcast || false,
          hostId: room.hostId || room.host_id,
          speakers: room.speakers ? (typeof room.speakers === 'string' ? JSON.parse(room.speakers) : room.speakers) : [],
          micQueue: room.micQueue ? (typeof room.micQueue === 'string' ? JSON.parse(room.micQueue) : room.micQueue) : []
        }));
        
        console.log('‚úÖ ÿ™ŸÖ ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ∫ÿ±ŸÅ:', formattedRooms.length, 'ÿ∫ÿ±ŸÅÿ©');
        setRooms(formattedRooms);
        
        // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        const currentRoomExists = formattedRooms.some((room: any) => room.id === chat.currentRoomId);
        if (!currentRoomExists && chat.currentRoomId !== 'general') {
          console.warn(`‚ö†Ô∏è ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ${chat.currentRoomId} ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©ÿå ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿπÿßŸÖÿ©`);
          chat.joinRoom('general');
        }
      } else {
        console.warn('‚ö†Ô∏è ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∫ÿ±ŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©:', data);
        throw new Error('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∫ÿ±ŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
      }
    } catch (error) {
      console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑÿ∫ÿ±ŸÅ:', error);
      // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ∫ÿ±ŸÅ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£
      console.log('üîÑ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©...');
      const defaultRooms = [
        { id: 'general', name: 'ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ÿßŸÑÿπÿßŸÖÿ©', description: 'ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸÑŸÑÿØÿ±ÿØÿ¥ÿ©', isDefault: true, createdBy: 1, createdAt: new Date(), isActive: true, userCount: 0, icon: '', isBroadcast: false, hostId: null, speakers: [], micQueue: [] },
        { id: 'broadcast', name: 'ÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ®ÿ´ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±', description: 'ÿ∫ÿ±ŸÅÿ© ÿÆÿßÿµÿ© ŸÑŸÑÿ®ÿ´ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ± ŸÖÿπ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿßŸäŸÉ', isDefault: false, createdBy: 1, createdAt: new Date(), isActive: true, userCount: 0, icon: '', isBroadcast: true, hostId: 1, speakers: [], micQueue: [] },
        { id: 'music', name: 'ÿ£ÿ∫ÿßŸÜŸä Ÿàÿ≥Ÿáÿ±', description: 'ÿ∫ÿ±ŸÅÿ© ŸÑŸÑŸÖŸàÿ≥ŸäŸÇŸâ ŸàÿßŸÑÿ™ÿ±ŸÅŸäŸá', isDefault: false, createdBy: 1, createdAt: new Date(), isActive: true, userCount: 0, icon: '', isBroadcast: false, hostId: null, speakers: [], micQueue: [] }
      ];
      setRooms(defaultRooms);
      
      // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿπÿßŸÖÿ©
      if (chat.currentRoomId !== 'general') {
        chat.joinRoom('general');
      }
    } finally {
      setRoomsLoading(false);
    }
  };

  // ÿ¨ŸÑÿ® ÿßŸÑÿ∫ÿ±ŸÅ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÉŸàŸÜ
  useEffect(() => {
    fetchRooms();
  }, []);

  // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∫ÿ±ŸÅ
  const handleRoomChange = async (roomId: string) => {
    if (!roomId || roomId.trim() === '') {
      console.error('‚ùå ŸÖÿπÿ±ŸÅ ÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
      return;
    }

    if (roomId === chat.currentRoomId) {
      console.log('‚ÑπÔ∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿ∫ÿ±ŸÅÿ©');
      return;
    }

    console.log(`üîÑ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸÖŸÜ ${chat.currentRoomId} ÿ•ŸÑŸâ ${roomId}`);
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
    const targetRoom = rooms.find(room => room.id === roomId);
    if (!targetRoom && roomId !== 'general') {
      console.error(`‚ùå ÿßŸÑÿ∫ÿ±ŸÅÿ© ${roomId} ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©`);
      toast({
        title: "ÿÆÿ∑ÿ£",
        description: "ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©",
        variant: "destructive",
      });
      return;
    }

    try {
      chat.joinRoom(roomId);
      
      // ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇÿµŸäÿ± ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÜÿ∂ŸÖÿßŸÖ ÿßŸÑÿ∫ÿ±ŸÅÿ©
      setTimeout(() => {
        console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ•ŸÑŸâ: ${roomId}`);
      }, 100);
    } catch (error) {
      console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ∫ÿ±ŸÅÿ©:', error);
      toast({
        title: "ÿÆÿ∑ÿ£",
        description: "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ∫ÿ±ŸÅÿ©",
        variant: "destructive",
      });
    }
  };

  // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∫ÿ±ŸÅ
  const handleRefreshRooms = async () => {
    console.log('üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∫ÿ±ŸÅ...');
    await fetchRooms();
  };

  const handleAddRoom = async (roomData: { name: string; description: string; image: File | null }) => {
    if (!chat.currentUser) return;
    
    try {
      const formData = new FormData();
      formData.append('name', roomData.name);
      formData.append('description', roomData.description);
      formData.append('userId', chat.currentUser.id.toString());
      if (roomData.image) {
        formData.append('image', roomData.image);
      }

      const response = await fetch('/api/rooms', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const data = await response.json();
        const newRoom = {
          id: data.room.id,
          name: data.room.name,
          description: data.room.description || '',
          isDefault: data.room.is_default,
          createdBy: data.room.created_by,
          createdAt: new Date(data.room.created_at),
          isActive: data.room.is_active,
          userCount: 0,
          icon: data.room.icon || ''
        };
        setRooms(prev => [...prev, newRoom]);
        toast({
          title: "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©",
          description: `ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© "${roomData.name}" ÿ®ŸÜÿ¨ÿßÿ≠`,
        });
      } else {
        const error = await response.json();
        throw new Error(error.error || 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©');
      }
    } catch (error) {
      toast({
        title: "ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©",
        description: error instanceof Error ? error.message : "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©",
        variant: "destructive",
      });
    }
  };

  const handleDeleteRoom = async (roomId: string) => {
    if (!chat.currentUser) return;
    
    try {
      const response = await apiRequest(`/api/rooms/${roomId}`, {
        method: 'DELETE',
        body: { userId: chat.currentUser.id }
      });

      if (response.ok) {
        setRooms(prev => prev.filter(room => room.id !== roomId));
        if (currentRoomId === roomId) {
          chat.joinRoom('general'); // ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        }
        toast({
          title: "ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©",
          description: "ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ®ŸÜÿ¨ÿßÿ≠",
        });
      } else {
        const error = await response.json();
        throw new Error(error.error || 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©');
      }
    } catch (error) {
      toast({
        title: "ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©",
        description: error instanceof Error ? error.message : "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©",
        variant: "destructive",
      });
    }
  };

  const [showNotifications, setShowNotifications] = useState(false);
  const [showFriends, setShowFriends] = useState(false);
  const [showMessages, setShowMessages] = useState(false);
  const [showModerationPanel, setShowModerationPanel] = useState(false);
  const [showOwnerPanel, setShowOwnerPanel] = useState(false);
  const [showReportsLog, setShowReportsLog] = useState(false);
  const [showActiveActions, setShowActiveActions] = useState(false);
  const [showPromotePanel, setShowPromotePanel] = useState(false);
  const [showThemeSelector, setShowThemeSelector] = useState(false);


  const [newMessageAlert, setNewMessageAlert] = useState<{
    show: boolean;
    sender: ChatUser | null;
  }>({
    show: false,
    sender: null,
  });

  // ÿ¨ŸÑÿ® ÿßŸÑÿ∫ÿ±ŸÅ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÉŸàŸÜ
  useEffect(() => {
    console.log('üöÄ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÉŸàŸÜ ChatInterface - ÿ¨ŸÑÿ® ÿßŸÑÿ∫ÿ±ŸÅ...');
    fetchRooms();
    
    // ÿ•ÿπÿßÿØÿ© ÿ¨ŸÑÿ® ÿßŸÑÿ∫ÿ±ŸÅ ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ© ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
    const interval = setInterval(() => {
      console.log('üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ±Ÿä ŸÑŸÑÿ∫ÿ±ŸÅ...');
      fetchRooms();
    }, 30000);
    
    return () => clearInterval(interval);
  }, []);

  // ÿ•ÿ∂ÿßŸÅÿ© useEffect ŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿßŸÑÿ∫ÿ±ŸÅ
  useEffect(() => {
    console.log('üìä ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∫ÿ±ŸÅ:', rooms.length, 'ÿ∫ÿ±ŸÅÿ©');
    rooms.forEach((room, index) => {
      console.log(`  ${index + 1}. ${room.name} (${room.id}) - ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ: ${room.userCount}`);
    });
  }, [rooms]);

  // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸá ÿπŸÜÿØ ŸàÿµŸàŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ©
  useEffect(() => {
    if (chat.newMessageSender) {
      setNewMessageAlert({
        show: true,
        sender: chat.newMessageSender,
      });
    }
  }, [chat.newMessageSender]);
  const [reportedUser, setReportedUser] = useState<ChatUser | null>(null);
  const [reportedMessage, setReportedMessage] = useState<{ content: string; id: number } | null>(null);
  const [userPopup, setUserPopup] = useState<{
    show: boolean;
    user: ChatUser | null;
    x: number;
    y: number;
  }>({
    show: false,
    user: null,
    x: 0,
    y: 0,
  });
  const { toast } = useToast();

  const handleUserClick = (event: React.MouseEvent, user: ChatUser) => {
    event.stopPropagation();
    setUserPopup({
      show: true,
      user,
      x: event.clientX,
      y: event.clientY,
    });
  };

  const closeUserPopup = () => {
    setUserPopup(prev => ({ ...prev, show: false }));
  };

  const handlePrivateMessage = (user: ChatUser) => {
    setSelectedPrivateUser(user);
    closeUserPopup();
  };

  const closePrivateMessage = () => {
    setSelectedPrivateUser(null);
  };

  const handleAddFriend = async (user: ChatUser) => {
    if (!chat.currentUser) return;
    
    try {
      const response = await apiRequest('/api/friend-requests', {
        method: 'POST',
        body: {
          senderId: chat.currentUser.id,
          receiverId: user.id,
        }
      });
      
      toast({
        title: "ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©",
        description: `ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿµÿØÿßŸÇÿ© ÿ•ŸÑŸâ ${user.username}`,
      });
    } catch (error) {
      console.error('Friend request error:', error);
      toast({
        title: "ÿÆÿ∑ÿ£",
        description: error instanceof Error ? error.message : "ŸÑŸÖ ŸÜÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©",
        variant: "destructive",
      });
    }
    closeUserPopup();
  };

  const handleIgnoreUser = (user: ChatUser) => {
    chat.ignoreUser(user.id);
    toast({
      title: "ÿ™ŸÖ ÿßŸÑÿ™ÿ¨ÿßŸáŸÑ",
      description: `ÿ™ŸÖ ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${user.username} - ŸÑŸÜ ÿ™ÿ±Ÿâ ÿ±ÿ≥ÿßÿ¶ŸÑŸá ÿ®ÿπÿØ ÿßŸÑÿ¢ŸÜ`,
    });
    closeUserPopup();
  };



  const handleViewProfile = (user: ChatUser) => {
    setProfileUser(user);
    setShowProfile(true);
    closeUserPopup();
  };

  // ŸÖÿπÿßŸÑÿ¨ ŸÑŸÑÿ±Ÿàÿßÿ®ÿ∑ ÿßŸÑÿ¥ÿÆÿµŸäÿ©
  const handleProfileLink = (userId: number) => {
    const user = chat.onlineUsers.find(u => u.id === userId);
    if (user) {
      setProfileUser(user);
      setShowProfile(true);
    } else {
      toast({
        title: "ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ",
        description: "ŸÑŸÖ ŸÜÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ",
        variant: "destructive"
      });
    }
  };

  // ÿ™ŸÅÿπŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑ ÿßŸÑÿ¥ÿÆÿµŸäÿ©
  useEffect(() => {
    const handleHashChange = () => {
      const hash = window.location.hash;
      const match = hash.match(/#id(\d+)/);
      if (match) {
        const userId = parseInt(match[1]);
        handleProfileLink(userId);
        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸáÿßÿ¥ ŸÖŸÜ ÿßŸÑÿπŸÜŸàÿßŸÜ
        window.history.replaceState(null, '', window.location.pathname);
      }
    };

    // ŸÅÿ≠ÿµ ÿßŸÑŸáÿßÿ¥ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    handleHashChange();
    
    // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿßŸÑŸáÿßÿ¥
    window.addEventListener('hashchange', handleHashChange);
    
    return () => {
      window.removeEventListener('hashchange', handleHashChange);
    };
  }, [chat.onlineUsers]);

  const handleReportUser = (user: ChatUser, messageContent?: string, messageId?: number) => {
    setReportedUser(user);
    setReportedMessage(messageContent && messageId ? { content: messageContent, id: messageId } : null);
    setShowReportModal(true);
    closeUserPopup();
  };

  const closeReportModal = () => {
    setShowReportModal(false);
    setReportedUser(null);
    setReportedMessage(null);
  };

  return (
      <div className="h-screen flex flex-col" onClick={closeUserPopup}>
      {/* Header */}
      <header className="bg-secondary py-4 px-6 flex justify-between items-center shadow-2xl border-b border-accent">
        <div className="flex items-center gap-3">
          {/* ÿ≤ÿ± ÿßŸÑÿ≠Ÿàÿßÿ¶ÿ∑ ŸÅŸä ÿßŸÑÿ≤ÿßŸàŸäÿ© ÿßŸÑŸäÿ≥ÿ±Ÿâ */}
          <Button 
            className={`glass-effect px-3 py-2 rounded-lg transition-all duration-200 flex items-center gap-2 ${
              activeView === 'walls' ? 'bg-primary text-primary-foreground' : 'hover:bg-accent'
            }`}
            onClick={() => setActiveView(activeView === 'walls' ? 'hidden' : 'walls')}
            title="ÿßŸÑÿ≠Ÿàÿßÿ¶ÿ∑"
          >
            <div className="flex flex-col gap-0.5">
              <div className="w-4 h-0.5 bg-current"></div>
              <div className="w-4 h-0.5 bg-current"></div>
              <div className="w-4 h-0.5 bg-current"></div>
            </div>
            ÿßŸÑÿ≠Ÿàÿßÿ¶ÿ∑
          </Button>
          
          {/* ÿ≤ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ */}
          <Button 
            className={`glass-effect px-3 py-2 rounded-lg transition-all duration-200 flex items-center gap-2 ${
              activeView === 'users' ? 'bg-primary text-primary-foreground' : 'hover:bg-accent'
            }`}
            onClick={() => setActiveView(activeView === 'users' ? 'hidden' : 'users')}
            title="ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ÿßŸÑŸÖÿ™ÿµŸÑŸàŸÜ"
          >
            <span>üë•</span>
                          ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ({chat.onlineUsers.length})
          </Button>

          {/* ÿ≤ÿ± ÿßŸÑÿ∫ÿ±ŸÅ */}
          <Button 
            className={`glass-effect px-3 py-2 rounded-lg transition-all duration-200 flex items-center gap-2 ${
              activeView === 'rooms' ? 'bg-primary text-primary-foreground' : 'hover:bg-accent'
            }`}
            onClick={() => setActiveView(activeView === 'rooms' ? 'hidden' : 'rooms')}
            title="ÿßŸÑÿ∫ÿ±ŸÅ"
          >
            <span>üè†</span>
            ÿßŸÑÿ∫ÿ±ŸÅ
          </Button>

          <div className="text-2xl">üí¨</div>
          <div className="text-2xl font-bold text-white">
            Arabic<span className="text-primary">Chat</span>
          </div>
        </div>
        <div className="flex gap-3">
          <Button 
            className="glass-effect px-4 py-2 rounded-lg hover:bg-accent transition-all duration-200 flex items-center gap-2 relative"
            onClick={() => setShowNotifications(true)}
          >
            <span>üîî</span>
            ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
          </Button>
          
          <Button 
            className="glass-effect px-4 py-2 rounded-lg hover:bg-accent transition-all duration-200 flex items-center gap-2 relative"
            onClick={() => setShowFriends(true)}
          >
            <span>üë•</span>
            ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°
            {/* ÿ™ŸÜÿ®ŸäŸá ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿµÿØÿßŸÇÿ© */}
            <FriendRequestBadge currentUser={chat.currentUser} />
          </Button>

          <Button 
            className="glass-effect px-4 py-2 rounded-lg hover:bg-accent transition-all duration-200 flex items-center gap-2"
            onClick={() => setShowMessages(true)}
            title="ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ"
          >
            <span style={{ display: 'flex', alignItems: 'center' }}>
              <svg width="24" height="18" viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg">
                <rect x="5" y="20" width="110" height="60" fill="white" stroke="#444" strokeWidth="1.5"/>
                <polygon points="5,20 60,55 115,20" fill="white" stroke="#444" strokeWidth="1.5"/>
                <line x1="5" y1="20" x2="60" y2="55" stroke="#555" strokeWidth="1"/>
                <line x1="115" y1="20" x2="60" y2="55" stroke="#555" strokeWidth="1"/>
              </svg>
            </span>
            ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
          </Button>
          
          {/* ÿ≤ÿ± ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ© ŸÑŸÑŸÖÿ¥ÿ±ŸÅŸäŸÜ */}
          {chat.currentUser && (chat.currentUser.userType === 'owner' || chat.currentUser.userType === 'admin') && (
            <>
              <Button 
                className="glass-effect px-4 py-2 rounded-lg hover:bg-accent transition-all duration-200 flex items-center gap-2"
                onClick={() => setShowModerationPanel(true)}
              >
                <span>üõ°Ô∏è</span>
                ÿ•ÿØÿßÿ±ÿ©
              </Button>
              
              <StealthModeToggle currentUser={chat.currentUser} />
              
              <Button 
                className="glass-effect px-4 py-2 rounded-lg hover:bg-red-600 transition-all duration-200 flex items-center gap-2 border border-red-400 relative"
                onClick={() => setShowReportsLog(true)}
              >
                <span>‚ö†Ô∏è</span>
                ÿ≥ÿ¨ŸÑ ÿßŸÑÿ®ŸÑÿßÿ∫ÿßÿ™
              </Button>
              
              <Button 
                className="glass-effect px-4 py-2 rounded-lg hover:bg-yellow-600 transition-all duration-200 flex items-center gap-2 border border-yellow-400"
                onClick={() => setShowActiveActions(true)}
              >
                <span>üîí</span>
                ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ©
              </Button>

              {/* ÿ≤ÿ± ÿ™ÿ±ŸÇŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ - ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑ */}
              {chat.currentUser?.userType === 'owner' && (
                <Button 
                  className="glass-effect px-4 py-2 rounded-lg hover:bg-blue-600 transition-all duration-200 flex items-center gap-2"
                  onClick={() => setShowPromotePanel(true)}
                >
                  <span>üëë</span>
                  ÿ™ÿ±ŸÇŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
                </Button>
              )}
            </>
          )}

          {/* ÿ≤ÿ± ÿÆÿßÿµ ÿ®ÿßŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑ */}
          {chat.currentUser && chat.currentUser.userType === 'owner' && (
            <Button 
              className="glass-effect px-4 py-2 rounded-lg hover:bg-purple-600 transition-all duration-200 flex items-center gap-2 border border-purple-400"
              onClick={() => setShowOwnerPanel(true)}
            >
              <span>üëë</span>
              ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿßŸÑŸÉ
            </Button>
          )}
          
          <Button 
            className="glass-effect px-4 py-2 rounded-lg hover:bg-accent transition-all duration-200 flex items-center gap-2"
            onClick={() => setShowSettings(!showSettings)}
          >
            <span>‚öôÔ∏è</span>
            ÿ•ÿπÿØÿßÿØÿßÿ™
          </Button>



        </div>
      </header>
      
      {/* Main Content */}
      <main className="flex flex-1 overflow-hidden">
        {/* ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä - Ÿäÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ÿπŸÜÿØŸÖÿß ŸäŸÉŸàŸÜ activeView ŸÑŸäÿ≥ 'hidden' */}
        {activeView !== 'hidden' && (
          <div className={`${activeView === 'walls' ? 'w-96' : 'w-64'} transition-all duration-300`}>
            <UserSidebarWithWalls 
              users={chat.onlineUsers}
              onUserClick={handleUserClick}
              currentUser={chat.currentUser}
              activeView={activeView}
              rooms={rooms}
              currentRoomId={chat.currentRoomId}
              onRoomChange={handleRoomChange}
              onAddRoom={handleAddRoom}
              onDeleteRoom={handleDeleteRoom}
              onRefreshRooms={fetchRooms}
            />
          </div>
        )}
        {(() => {
          const currentRoom = rooms.find(room => room.id === chat.currentRoomId);
          
          // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸÖŸÜ ŸÜŸàÿπ broadcastÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ BroadcastRoomInterface
          if (currentRoom?.isBroadcast) {
            return (
              <BroadcastRoomInterface
                currentUser={chat.currentUser}
                room={currentRoom}
                onlineUsers={chat.onlineUsers}
                onSendMessage={(content) => chat.sendRoomMessage(content, chat.currentRoomId)}
                onTyping={chat.handleTyping}
                typingUsers={Array.from(chat.typingUsers)}
                onReportMessage={handleReportUser}
                onUserClick={handleUserClick}
              />
            );
          }
          
          // Ÿàÿ•ŸÑÿß ÿßÿ≥ÿ™ÿÆÿØŸÖ MessageArea ÿßŸÑÿπÿßÿØŸäÿ©
          return (
            <MessageArea 
              messages={chat.roomMessages[chat.currentRoomId] || chat.publicMessages}
              currentUser={chat.currentUser}
              onlineUsers={chat.onlineUsers}
              onSendMessage={chat.sendPublicMessage}
              onTyping={chat.handleTyping}
              typingUsers={Array.from(chat.typingUsers)}
              onReportMessage={handleReportUser}
              onUserClick={handleUserClick}
            />
          );
        })()}
      </main>

      {/* Modals and Popups */}
      {showProfile && (
        <>
          {profileUser && profileUser.id !== chat.currentUser?.id ? (
            <ProfileModal
              user={profileUser}
              currentUser={chat.currentUser}
              onClose={() => {
                setShowProfile(false);
                setProfileUser(null);
              }}
              onIgnoreUser={(userId) => {
                chat.ignoreUser(userId);
              }}
              onPrivateMessage={handlePrivateMessage}
              onAddFriend={handleAddFriend}
            />
          ) : (
            <ProfileModal 
              user={profileUser || chat.currentUser}
              currentUser={chat.currentUser}
              onClose={() => {
                setShowProfile(false);
                setProfileUser(null);
              }}
              onIgnoreUser={(userId) => {
                chat.ignoreUser(userId);
              }}
            />
          )}
        </>
      )}

      {selectedPrivateUser && (
        <PrivateMessageBox
          isOpen={!!selectedPrivateUser}
          user={selectedPrivateUser}
          currentUser={chat.currentUser}
          messages={chat.privateConversations[selectedPrivateUser.id] || []}
          onSendMessage={(content) => chat.sendPrivateMessage(selectedPrivateUser.id, content)}
          onClose={closePrivateMessage}
        />
      )}

      {userPopup.show && userPopup.user && (
        <UserPopup
          user={userPopup.user}
          x={userPopup.x}
          y={userPopup.y}
          onPrivateMessage={() => handlePrivateMessage(userPopup.user!)}
          onAddFriend={() => handleAddFriend(userPopup.user!)}
          onIgnore={() => {
            // ÿ•ÿ≤ÿßŸÑÿ© ÿ≤ÿ± ÿßŸÑÿ™ÿ¨ÿßŸáŸÑ ŸÖŸÜ UserPopup - ÿßŸÑÿ¢ŸÜ ŸÅŸä ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä ŸÅŸÇÿ∑
          }}
          onViewProfile={() => handleViewProfile(userPopup.user!)}
          currentUser={chat.currentUser}
          onClose={closeUserPopup}
        />
      )}

              {showSettings && (
          <SettingsMenu
            onOpenProfile={() => {
              setShowProfile(true);
              setShowSettings(false);
            }}
            onLogout={onLogout}
            onClose={() => setShowSettings(false)}
            onOpenReports={() => {
              setShowAdminReports(true);
              setShowSettings(false);
            }}
            onOpenThemeSelector={() => {
              setShowThemeSelector(true);
              setShowSettings(false);
            }}
            currentUser={chat.currentUser}
          />
        )}

      {showReportModal && (
        <ReportModal
          isOpen={showReportModal}
          onClose={closeReportModal}
          reportedUser={reportedUser}
          currentUser={chat.currentUser}
          messageContent={reportedMessage?.content}
          messageId={reportedMessage?.id}
        />
      )}

      {showNotifications && (
        <NotificationPanel
          isOpen={showNotifications}
          onClose={() => setShowNotifications(false)}
          currentUser={chat.currentUser}
        />
      )}

      {/* Admin Reports Panel */}
      {showAdminReports && chat.currentUser && chat.currentUser.userType === 'owner' && (
        <AdminReportsPanel
          isOpen={showAdminReports}
          onClose={() => setShowAdminReports(false)}
          currentUser={chat.currentUser}
        />
      )}

      {showFriends && (
        <FriendsPanel
          isOpen={showFriends}
          onClose={() => setShowFriends(false)}
          currentUser={chat.currentUser}
          onlineUsers={chat.onlineUsers}
          onStartPrivateChat={(friend) => {
            setSelectedPrivateUser(friend);
            setShowFriends(false);
          }}
        />
      )}

      {showMessages && (
        <MessagesPanel
          isOpen={showMessages}
          onClose={() => setShowMessages(false)}
          currentUser={chat.currentUser}
          privateConversations={chat.privateConversations}
          onlineUsers={chat.onlineUsers}
          onStartPrivateChat={(user) => {
            setSelectedPrivateUser(user);
            setShowMessages(false);
          }}
        />
      )}

      {showModerationPanel && (
        <ModerationPanel
          isOpen={showModerationPanel}
          onClose={() => setShowModerationPanel(false)}
          currentUser={chat.currentUser}
          onlineUsers={chat.onlineUsers}
        />
      )}

      {showOwnerPanel && (
        <OwnerAdminPanel 
          isOpen={showOwnerPanel}
          onClose={() => setShowOwnerPanel(false)}
          currentUser={chat.currentUser}
          onlineUsers={chat.onlineUsers}
        />
      )}

      {showModerationPanel && (
        <ModerationPanel 
          isOpen={showModerationPanel}
          onClose={() => setShowModerationPanel(false)}
          currentUser={chat.currentUser}
          onlineUsers={chat.onlineUsers}
        />
      )}

      {showReportsLog && (
        <ReportsLog 
          isVisible={showReportsLog}
          onClose={() => setShowReportsLog(false)}
          currentUser={chat.currentUser}
        />
      )}

      {showActiveActions && (
        <ActiveModerationLog 
          isVisible={showActiveActions}
          onClose={() => setShowActiveActions(false)}
          currentUser={chat.currentUser}
        />
      )}

      {showPromotePanel && (
        <PromoteUserPanel 
          isVisible={showPromotePanel}
          onClose={() => setShowPromotePanel(false)}
          currentUser={chat.currentUser}
          onlineUsers={chat.onlineUsers}
        />
      )}

      {showThemeSelector && (
        <ThemeSelector
          isOpen={showThemeSelector}
          onClose={() => setShowThemeSelector(false)}
          currentUser={chat.currentUser}
          onThemeUpdate={(theme) => {
            }}
        />
      )}

      {/* ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ∑ÿ±ÿØ ŸàÿßŸÑÿ≠ÿ¨ÿ® */}
      {chat.showKickCountdown && (
        <KickNotification
          isVisible={chat.showKickCountdown}
          durationMinutes={15}
          onClose={() => chat.setShowKickCountdown(false)}
        />
      )}
      {/* ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ≠ÿ¨ÿ® (block) */}
      {chat.notifications && chat.notifications.some(n => n.type === 'moderation' && n.content.includes('ÿ≠ÿ∏ÿ±')) && (
        <BlockNotification
          isVisible={true}
          reason={chat.notifications.find(n => n.type === 'moderation' && n.content.includes('ÿ≠ÿ∏ÿ±'))?.content || ''}
          onClose={() => {}}
        />
      )}

      {/* ÿ™ŸÜÿ®ŸäŸá ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ© */}
      <MessageAlert
        isOpen={newMessageAlert.show}
        sender={newMessageAlert.sender}
        onClose={() => setNewMessageAlert({ show: false, sender: null })}
        onOpenMessages={() => setShowMessages(true)}
      />

      {/* ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ® */}
      {chat.currentUser && <WelcomeNotification user={chat.currentUser} />}

    </div>
  );
}
