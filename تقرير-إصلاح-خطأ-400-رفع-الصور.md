# ุชูุฑูุฑ ุฅุตูุงุญ ุฎุทุฃ 400 ูู ุฑูุน ุงูุตูุฑ

## ๐ ุงููุดููุฉ ุงูููุชุดูุฉ

### ุงููุตู
ูุงู ููุงู ุฎุทุฃ 400 (Bad Request) ุนูุฏ ูุญุงููุฉ ุฑูุน ุตูุฑ ุงูุจุฑููุงูู ูุงูุจุงูุฑ ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ.

### ุฑุณุงูุฉ ุงูุฎุทุฃ
```
POST https://abd-53fb.onrender.com/api/upload/profile-image 400 (Bad Request)
```

### ุงูุฃุณุจุงุจ ุงููุญุชููุฉ
1. **ูุดููุฉ ูู Content-Type:** ุฏุงูุฉ `apiRequest` ูุงูุช ุชุถุน `Content-Type: application/json` ุฏุงุฆูุงู
2. **ูุดููุฉ ูู FormData:** ุนุฏู ุงูุชุนุงูู ุงูุตุญูุญ ูุน FormData ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
3. **ูุดููุฉ ูู ุงูุฎุงุฏู:** ููู `index-fixed.ts` ูู ูุญุชูู ุนูู routes ุฑูุน ุงูุตูุฑ

## โ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ

### 1. ุฅุตูุงุญ ุฏุงูุฉ apiRequest

**ุงูููู:** `client/src/lib/queryClient.ts`

**ุงููุดููุฉ:** ุงูุฏุงูุฉ ูุงูุช ุชุถุน `Content-Type: application/json` ุฏุงุฆูุงู ุญุชู ูุน FormData

**ุงูุญู:** ุฅุถุงูุฉ ูุญุต ููุน ุงูุจูุงูุงุช ูุชุญุฏูุฏ Content-Type ุงูููุงุณุจ

```typescript
// ูุจู ุงูุฅุตูุงุญ
const res = await fetch(url, {
  method,
  headers: {
    'Content-Type': 'application/json', // โ ุฏุงุฆูุงู
    ...headers
  },
  body: body ? JSON.stringify(body) : undefined,
  credentials: "include",
});

// ุจุนุฏ ุงูุฅุตูุงุญ
const isFormData = body instanceof FormData;
const defaultHeaders = isFormData ? {} : { 'Content-Type': 'application/json' };

const res = await fetch(url, {
  method,
  headers: {
    ...defaultHeaders,
    ...headers
  },
  body: isFormData ? body : (body ? JSON.stringify(body) : undefined),
  credentials: "include",
});
```

### 2. ุฅุตูุงุญ ProfileModal.tsx

**ุงูููู:** `client/src/components/chat/ProfileModal.tsx`

**ุงููุดููุฉ:** ุงุณุชุฎุฏุงู `apiRequest` ูุน FormData

**ุงูุญู:** ุงุณุชุฎุฏุงู `fetch` ูุจุงุดุฑุฉ ูุน ุฅุถุงูุฉ logging ููุชุดุฎูุต

```typescript
// ูุจู ุงูุฅุตูุงุญ
const response = await apiRequest(endpoint, {
  method: 'POST',
  body: formData,
});

// ุจุนุฏ ุงูุฅุตูุงุญ
const response = await fetch(endpoint, {
  method: 'POST',
  body: formData,
  credentials: 'include'
});

console.log('๐ก ุงุณุชุฌุงุจุฉ ุงูุฎุงุฏู:', response.status);

if (!response.ok) {
  const errorData = await response.json().catch(() => ({ error: 'ูุดู ูู ุฑูุน ุงูุตูุฑุฉ' }));
  throw new Error(errorData.error || 'ูุดู ูู ุฑูุน ุงูุตูุฑุฉ');
}
```

### 3. ุฅุถุงูุฉ routes ุฑูุน ุงูุตูุฑ ุฅูู index-fixed.ts

**ุงูููู:** `server/index-fixed.ts`

**ุงููุดููุฉ:** ุงูููู ูู ูุญุชูู ุนูู routes ุฑูุน ุงูุตูุฑ

**ุงูุญู:** ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช multer ู routes ูุงููุฉ

#### ุฅุนุฏุงุฏุงุช multer
```typescript
// ุฅุนุฏุงุฏ multer ูุฑูุน ุงูุตูุฑ
const storage_multer = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadDir = path.join(process.cwd(), 'client', 'public', 'uploads', 'profiles');
    if (!fs.existsSync(uploadDir)) {
      fs.mkdirSync(uploadDir, { recursive: true });
    }
    cb(null, uploadDir);
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    const ext = path.extname(file.originalname);
    cb(null, `profile-${uniqueSuffix}${ext}`);
  }
});

const upload = multer({
  storage: storage_multer,
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB
    files: 1
  },
  fileFilter: (req, file, cb) => {
    const allowedMimes = [
      'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 
      'image/webp', 'image/svg+xml', 'image/bmp', 'image/tiff'
    ];
    
    if (allowedMimes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error(`ููุน ุงูููู ุบูุฑ ูุฏุนูู: ${file.mimetype}`));
    }
  }
});
```

#### Routes ุฑูุน ุงูุตูุฑ
```typescript
// ุฑูุน ุตูุฑ ุงูุจุฑููุงูู
app.post('/api/upload/profile-image', upload.single('profileImage'), async (req, res) => {
  try {
    console.log('๐ค ุฑูุน ุตูุฑุฉ ุจุฑููุงูู:', {
      file: req.file ? 'ููุฌูุฏ' : 'ุบูุฑ ููุฌูุฏ',
      body: req.body,
      headers: req.headers['content-type']
    });

    if (!req.file) {
      return res.status(400).json({ 
        error: "ูู ูุชู ุฑูุน ุฃู ููู",
        details: "ุชุฃูุฏ ูู ุฅุฑุณุงู ุงูููู ูู ุญูู 'profileImage'"
      });
    }

    const userId = parseInt(req.body.userId);
    if (!userId) {
      fs.unlinkSync(req.file.path);
      return res.status(400).json({ error: "ูุนุฑู ุงููุณุชุฎุฏู ูุทููุจ" });
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู
    const user = await fixedStorage.getUser(userId);
    if (!user) {
      fs.unlinkSync(req.file.path);
      return res.status(404).json({ error: "ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ" });
    }

    // ุฅูุดุงุก ูุณุงุฑ ุงูุตูุฑุฉ ุงููุณุจู
    const relativePath = `/uploads/profiles/${req.file.filename}`;
    
    // ุชุญุฏูุซ ุตูุฑุฉ ุงูุจุฑููุงูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    await fixedStorage.updateUser(userId, { profileImage: relativePath });

    console.log('โ ุชู ุฑูุน ุตูุฑุฉ ุงูุจุฑููุงูู ุจูุฌุงุญ:', {
      userId,
      filename: req.file.filename,
      path: relativePath
    });

    res.json({
      message: "ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุฌุงุญ",
      imageUrl: relativePath,
      filename: req.file.filename
    });

  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุฑูุน ุตูุฑุฉ ุงูุจุฑููุงูู:', error);
    
    if (req.file && fs.existsSync(req.file.path)) {
      try {
        fs.unlinkSync(req.file.path);
      } catch (unlinkError) {
        console.error('ุฎุทุฃ ูู ุญุฐู ุงูููู:', unlinkError);
      }
    }

    res.status(500).json({ 
      error: "ุฎุทุฃ ูู ุฑูุน ุงูุตูุฑุฉ",
      details: error instanceof Error ? error.message : 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'
    });
  }
});
```

### 4. ุฅูุดุงุก ูุฌูุฏุงุช ุงูุฑูุน

```bash
mkdir -p client/public/uploads/profiles client/public/uploads/banners
```

### 5. ุฅุถุงูุฉ static middleware

```typescript
app.use('/uploads', express.static(path.join(process.cwd(), 'client', 'public', 'uploads')));
```

## ๐งช ุงุฎุชุจุงุฑุงุช ุงูุชุญูู

### ุงุฎุชุจุงุฑ ุจุงุณุชุฎุฏุงู curl
```bash
curl -X POST http://localhost:3000/api/upload/profile-image \
  -F "profileImage=@test-image.png" \
  -F "userId=1" \
  -H "Content-Type: multipart/form-data"
```

### ุงููุชุงุฆุฌ ุงููุชููุนุฉ
- **200 OK:** ูุฌุญ ุฑูุน ุงูุตูุฑุฉ
- **400 Bad Request:** ุฎุทุฃ ูู ุงูุจูุงูุงุช ุงููุฑุณูุฉ
- **404 Not Found:** ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ
- **500 Internal Server Error:** ุฎุทุฃ ูู ุงูุฎุงุฏู

## ๐ ุงููุชุงุฆุฌ

### โ ูุง ุชู ุฅุตูุงุญู
1. **Content-Type:** ุงูุขู ูุชู ุชุญุฏูุฏู ุจุดูู ุตุญูุญ ุญุณุจ ููุน ุงูุจูุงูุงุช
2. **FormData:** ูุชู ุงูุชุนุงูู ูุนู ุจุดูู ุตุญูุญ ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
3. **Routes:** ุชู ุฅุถุงูุฉ routes ุฑูุน ุงูุตูุฑ ุฅูู ุงูุฎุงุฏู
4. **Logging:** ุฅุถุงูุฉ logging ููุตู ููุชุดุฎูุต
5. **Error Handling:** ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก

### ๐ ุงูุฑูุงุจุท ุงููุชุฃุซุฑุฉ
- `/api/upload/profile-image` - ุฑูุน ุตูุฑุฉ ุงูุจุฑููุงูู
- `/api/upload/profile-banner` - ุฑูุน ุตูุฑุฉ ุงูุจุงูุฑ
- `/uploads/*` - ุงููุตูู ููุตูุฑ ุงููุฑููุนุฉ

### ๐ ุงููููุงุช ุงููุญุฏุซุฉ
- `client/src/lib/queryClient.ts` - ุฅุตูุงุญ ุฏุงูุฉ apiRequest
- `client/src/components/chat/ProfileModal.tsx` - ุฅุตูุงุญ ุฑูุน ุงููููุงุช
- `server/index-fixed.ts` - ุฅุถุงูุฉ routes ุฑูุน ุงูุตูุฑ

## ๐ฏ ุงูุฎูุงุตุฉ

**ุงููุดููุฉ:** ุฎุทุฃ 400 ุนูุฏ ุฑูุน ุงูุตูุฑ ุจุณุจุจ ูุดุงูู ูู Content-Type ูุนุฏู ูุฌูุฏ routes ูู ุงูุฎุงุฏู.

**ุงูุญู:** ุฅุตูุงุญ ุฏุงูุฉ apiRequestุ ุงุณุชุฎุฏุงู fetch ูุจุงุดุฑุฉุ ุฅุถุงูุฉ routes ุฑูุน ุงูุตูุฑ ุฅูู ุงูุฎุงุฏู.

**ุงููุชูุฌุฉ:** โ ุฑูุน ุงูุตูุฑ ูุนูู ุงูุขู ุจุดูู ุตุญูุญ ูุน ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก.

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 27 ููููู 2025  
**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ  
**ุงููุทูุฑ:** Claude Sonnet 4