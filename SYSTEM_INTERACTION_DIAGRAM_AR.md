# 🔄 مخطط تفاعل الأنظمة

## 📊 كيف تتفاعل الأنظمة لتسبب المشكلة

```
                    🌐 المتصفح (Browser)
                           │
                           │ يفتح الموقع
                           ↓
        ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        ┃      main.tsx (Entry Point)        ┃
        ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                           │
                 ┌─────────┼─────────┐
                 │         │         │
                 ↓         ↓         ↓
         ┌───────────┐ ┌───────┐ ┌──────────┐
         │Keep-Alive │ │Socket │ │useChat   │
         │Audio 🔊   │ │Init   │ │Hook      │
         │(مستمر)    │ │       │ │          │
         └───────────┘ └───────┘ └──────────┘
                           │           │
                           │           └──────┐
                           ↓                  ↓
         ┌─────────────────────────┐  ┌──────────────┐
         │  Socket.IO Connection   │  │Connection    │
         │  ───────────────────    │  │Manager       │
         │  reconnectionAttempts:  │  │(Polling)     │
         │  Infinity ♾️            │  │              │
         │  delay: 0.5s-5s         │  │1.5s interval │
         └─────────────────────────┘  └──────────────┘
                 │                            │
                 │                            │
         ┌───────┴────────┐          ┌────────┴────────┐
         ↓                ↓          ↓                 ↓
    ┌─────────┐    ┌──────────┐  ┌─────────┐   ┌──────────┐
    │connect  │    │reconnect │  │polling  │   │backup    │
    │handler  │    │handler   │  │every    │   │polling   │
    │         │    │(∞ times) │  │1.5s     │   │(0.5s!)   │
    └─────────┘    └──────────┘  └─────────┘   └──────────┘
         │              │              │              │
         └──────────────┴──────────────┴──────────────┘
                            │
                            ↓
              ┌─────────────────────────┐
              │  5 Event Handlers 👂    │
              ├─────────────────────────┤
              │ 1. useChat:             │
              │    visibilitychange     │
              │                         │
              │ 2. useChat:             │
              │    pageshow             │
              │                         │
              │ 3. connectionManager:   │
              │    visibilitychange     │
              │                         │
              │ 4. main.tsx:            │
              │    visibilitychange (×2)│
              │                         │
              │ 5. main.tsx:            │
              │    pageshow             │
              └─────────────────────────┘
                            │
                 عند تبديل التاب
                            ↓
         ┌──────────────────────────────────┐
         │  جميع الـ 5 handlers تعمل معاً!  │
         └──────────────────────────────────┘
                            │
         ┌──────────────────┼──────────────────┐
         ↓                  ↓                  ↓
    ┌────────┐      ┌────────────┐     ┌─────────┐
    │fetch   │      │socket      │     │audio    │
    │messages│      │reconnect   │     │resume   │
    │        │      │            │     │         │
    └────────┘      └────────────┘     └─────────┘
         │                  │                  │
         └──────────────────┴──────────────────┘
                            │
                            ↓
                    ┌───────────────┐
                    │  الخادم 💥    │
                    │               │
                    │ يستقبل:       │
                    │ • 5 عمليات   │
                    │ • في نفس      │
                    │   اللحظة!     │
                    └───────────────┘
```

---

## 🔄 دورة الحياة الكاملة

### 1. عند فتح الموقع (Initial Load):

```
⏱️ T+0.0s:  main.tsx يبدأ التنفيذ
            ├─ تهيئة React
            └─ تحميل المكونات

⏱️ T+0.1s:  Keep-Alive Audio يبدأ
            ├─ إنشاء AudioContext
            └─ oscillator يبدأ التشغيل 🔊

⏱️ T+0.2s:  useChat Hook يبدأ
            ├─ تهيئة Socket.IO
            ├─ تهيئة ConnectionManager
            └─ تسجيل Event Handlers

⏱️ T+0.5s:  Socket.IO يحاول الاتصال
            └─ emit('auth', ...)

⏱️ T+1.0s:  ConnectionManager polling يبدأ
            └─ أول طلب HTTP

⏱️ T+1.5s:  Socket.IO متصل ✅
            ├─ on('connect') يعمل
            └─ تحديث localStorage

⏱️ T+2.5s:  Polling طلب #2
            └─ /api/messages/room/general/since

⏱️ T+4.0s:  Polling طلب #3

⏱️ T+5.5s:  Polling طلب #4

... (يستمر كل 1.5 ثانية)
```

---

### 2. عند تبديل التاب (Tab Switch):

```
👤 المستخدم يبدل التاب
         ↓
         
⚡ pagehide event يُطلق
         ├─ useChat handlePageHide
         │  ├─ iOS? حفظ snapshot
         │  └─ Android? تفعيل Worker ping
         │
         └─ ConnectionManager pagehide
            └─ sendBeacon('/api/ping')

───────────────────────────────────

👤 المستخدم يرجع للتاب
         ↓
         
⚡ 5 handlers تعمل في نفس الوقت:

┌─────────────────────────────────────┐
│ 1️⃣ useChat visibilitychange       │
│    └─ startRegularPing()            │
│    └─ fetchMissedMessages()         │
│                                     │
│ 2️⃣ useChat pageshow                │
│    └─ getConnectionHealth()         │
│    └─ cacheGetRoomMessages()        │
│    └─ iOS snapshot check            │
│    └─ تفريغ buffer                  │
│    └─ fetchMissedMessages() (مرة ثانية!)│
│    └─ apiRequest('/api/users/online')│
│                                     │
│ 3️⃣ ConnectionManager visibilitychange│
│    └─ scheduleNextPoll(1)           │
│                                     │
│ 4️⃣ main.tsx visibilitychange       │
│    └─ keepAliveAudioCtx.resume()    │
│    └─ keepAliveAudioEl.play()       │
│                                     │
│ 5️⃣ main.tsx pageshow                │
│    └─ keepAliveAudioEl.play() (مرة ثانية!)│
└─────────────────────────────────────┘
         │
         ↓
    🔥 النتيجة:
    • 3-5 fetch requests
    • 2 socket operations  
    • 2 audio operations
    ───────────────────────
    = 7-9 عمليات في < 1 ثانية!
```

---

### 3. عند انقطاع Socket (Connection Lost):

```
📡 Socket.IO ينقطع
         ↓

┌────────────────────────────────────────┐
│  Socket.IO Reconnection System         │
├────────────────────────────────────────┤
│  محاولة #1  → 0.5s delay  → فشلت ❌   │
│  محاولة #2  → 1.0s delay  → فشلت ❌   │
│  محاولة #3  → 2.0s delay  → فشلت ❌   │
│  محاولة #4  → 4.0s delay  → فشلت ❌   │
│  محاولة #5  → 5.0s delay  → فشلت ❌   │
│  محاولة #6  → 5.0s delay  → فشلت ❌   │
│  محاولة #7  → 5.0s delay  → فشلت ❌   │
│  ...                                   │
│  محاولة ∞   → 5.0s delay  → ∞         │
└────────────────────────────────────────┘

في نفس الوقت:

┌────────────────────────────────────────┐
│  ConnectionManager Backup Polling      │
├────────────────────────────────────────┤
│  setSocketStatus(false) يُستدعى       │
│  ↓                                     │
│  scheduleNextPoll(500) 🔥              │
│  ↓                                     │
│  طلب كل 0.5 ثانية:                    │
│  • T+0.5s  → طلب #1                    │
│  • T+1.0s  → طلب #2                    │
│  • T+1.5s  → طلب #3                    │
│  • T+2.0s  → طلب #4                    │
│  ...                                   │
│  = 120 طلب/دقيقة! 💥                  │
└────────────────────────────────────────┘

في نفس الوقت أيضاً:

┌────────────────────────────────────────┐
│  Regular Polling (لا يزال يعمل!)      │
├────────────────────────────────────────┤
│  • T+0.0s  → طلب #1                    │
│  • T+1.5s  → طلب #2                    │
│  • T+3.0s  → طلب #3                    │
│  ...                                   │
│  = 40 طلب/دقيقة                       │
└────────────────────────────────────────┘

────────────────────────────────────────
📊 المجموع عند انقطاع Socket:
• Socket reconnect: كل 0.5-5s
• Backup polling:   120 طلب/دقيقة
• Regular polling:  40 طلب/دقيقة
────────────────────────────────────────
= 160 طلب/دقيقة = 9,600 طلب/ساعة! 🔥
```

---

## 🎯 مخطط تدفق المشكلة

```
          [المستخدم يفتح الموقع]
                    ↓
      ┌─────────────────────────────┐
      │ هل Socket متصل؟             │
      └─────────────────────────────┘
              ↙️           ↘️
          نعم ✅          لا ❌
            ↓              ↓
    ┌───────────────┐  ┌───────────────────┐
    │ Regular Mode  │  │ Reconnect Mode    │
    ├───────────────┤  ├───────────────────┤
    │ Socket: ✅    │  │ Socket: ❌        │
    │ Polling: 1.5s │  │ Reconnect: 0.5-5s │
    │ Workers: ✅   │  │ Backup Poll: 0.5s │
    │ Audio: 🔊     │  │ Regular Poll: 1.5s│
    │               │  │ Workers: ✅       │
    │ 40 req/min    │  │ Audio: 🔊         │
    └───────────────┘  │                   │
            │          │ 160+ req/min 🔥   │
            │          └───────────────────┘
            │                  │
            └──────────┬───────┘
                       ↓
          [المستخدم يبدل التاب]
                       ↓
      ┌─────────────────────────────┐
      │ 5 Event Handlers تعمل       │
      │ ✕ 7-9 عمليات               │
      └─────────────────────────────┘
                       ↓
          [المستخدم يرجع للتاب]
                       ↓
      ┌─────────────────────────────┐
      │ 5 Event Handlers تعمل مرة   │
      │ أخرى ✕ 7-9 عمليات          │
      └─────────────────────────────┘
                       ↓
               [يستمر إلى ∞]
```

---

## 📊 التفاعل بين الأنظمة

### الوضع الطبيعي (Socket يعمل):

```
        Socket.IO          ConnectionManager       Workers
            │                      │                  │
            │ متصل ✅              │                  │
            │                      │ polling (1.5s)   │
            │                      │─────────────────→│
            │                      │                  │ ping (30s)
            │                      │                  │─────→ Server
            │                      │←─────────────────│
            │                      │ response         │
            │                      │                  │
            ↓                      ↓                  ↓
        [عادي]              [طلبات كثيرة]        [عادي]
```

### عند انقطاع Socket:

```
        Socket.IO          ConnectionManager       Workers
            │                      │                  │
            │ انقطع ❌            │                  │
            │ reconnect (0.5s)    │                  │
            │───────────────────→ Server (فشل)      │
            │                      │                  │
            │                      │ backup (0.5s!) 🔥│
            │                      │─────────────────→│
            │ reconnect (1.0s)    │                  │ ping (30s)
            │───────────────────→ Server (فشل)      │─────→ Server
            │                      │ regular (1.5s)   │
            │                      │─────────────────→│
            │ reconnect (2.0s)    │                  │
            │───────────────────→ Server (فشل)      │
            │                      │ backup (0.5s!) 🔥│
            │                      │─────────────────→│
            ↓                      ↓                  ↓
    [محاولات ∞]            [طلبات مجنونة]      [محاولات]
         │                       │                  │
         └───────────────────────┴──────────────────┘
                              │
                              ↓
                    [الخادم مكتظ! 💥]
```

---

## 🔄 دورة Event Loop

```
JavaScript Event Loop:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Microtasks Queue]
  • Promise callbacks
  • MutationObserver callbacks
  
[Macrotasks Queue]
  • setTimeout callbacks
  • setInterval callbacks  ← ConnectionManager polling (كل 1.5s)
  • Socket.IO reconnect     ← Socket.IO (كل 0.5-5s)
  • DOM events              ← visibilitychange, pageshow (5 handlers!)
  • Network responses

[Animation Frame]
  • requestAnimationFrame

[Idle Callbacks]
  • requestIdleCallback

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

المشكلة:
• Macrotasks Queue مكتظة جداً
• 40+ tasks كل دقيقة من Polling وحده
• Socket reconnect يضيف ∞ tasks
• Event handlers تضيف 5+ tasks لكل حدث
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
= Event Loop مشغول باستمرار
= يبدو للمستخدم كأن الموقع "معلق" أو "يعمل refresh"
```

---

## 📈 Timeline المرئي (60 ثانية)

```
الوقت      Socket.IO    Polling    Events    Workers    Audio
────────────────────────────────────────────────────────────────
0s         connect       ●                    start      ♪
1.5s                     ●                               ♪
3s                       ●                               ♪
4.5s                     ●                               ♪
6s                       ●                               ♪
7.5s                     ●                               ♪
9s                       ●                               ♪
10s        [انقطع!]                                      ♪
10.5s      reconnect #1  ●                               ♪
11s                      ● (backup!)                     ♪
11.5s      reconnect #2  ● (backup!)                     ♪
12s                      ● ● (backup!)                   ♪
12.5s                    ● (backup!)                     ♪
13s        reconnect #3  ● ● (backup!)                   ♪
14s                      ● (backup!)                     ♪
15s        reconnect #4  ● ● (backup!)                   ♪
16s                      ● (backup!)                     ♪
17s        reconnect #5  ● ●                             ♪
18s                      ●                               ♪
20s                      ●                  ping         ♪
22s        reconnect #6  ●                               ♪
24s                      ●                               ♪
25s        [تبديل تاب]       ⚡⚡⚡⚡⚡ (5 handlers)        ♪
26s                      ●                               ♪
27s        reconnect #7  ●                               ♪
30s                      ●                               ♪
32s        reconnect #8  ●                  ping         ♪
35s        [عودة للتاب]      ⚡⚡⚡⚡⚡ (5 handlers)        ♪
40s                      ●                               ♪
45s                      ●                               ♪
50s                      ●                  ping         ♪
55s                      ●                               ♪
60s        reconnect #20 ●                               ♪

────────────────────────────────────────────────────────────────
Legend:
●       = HTTP Request
⚡      = Event Handler
♪       = Audio Playing
reconnect = Socket.IO reconnection attempt

في دقيقة واحدة:
• Polling: 40 طلب
• Reconnect: 20 محاولة (عندما Socket منقطع)
• Events: 10 handlers (2 تبديلات × 5)
• Workers: 2 pings
• Audio: مستمر 🔊
────────────────────────────────────────────────────────────────
المجموع: 70+ عملية في دقيقة واحدة!
```

---

## 🎭 السيناريوهات المختلفة

### سيناريو A: مستخدم عادي يتصفح

```
1. يفتح الموقع           → 40 طلب/دقيقة
2. يترك التاب مفتوح لـ 10 دقائق → 400 طلب
3. يبدل التاب 3 مرات    → 15 عملية إضافية
4. يغلق الموقع

المجموع: 415 طلب في 10 دقائق = 2,490 طلب/ساعة
```

### سيناريو B: مستخدم يواجه انقطاع

```
1. يفتح الموقع           → 40 طلب/دقيقة
2. Socket ينقطع بعد 2 دقيقة → 160 طلب/دقيقة
3. ينقطع لمدة 5 دقائق    → 800 طلب
4. Socket يعود            → 40 طلب/دقيقة

المجموع: 880 طلب في 7 دقائق = 7,543 طلب/ساعة! 🔥
```

### سيناريو C: مستخدم iOS يبدل التطبيقات

```
1. يفتح الموقع           → 40 طلب/دقيقة
2. يبدل للتطبيق آخر      → 5 handlers تعمل
3. iOS snapshot system    → localStorage writes
4. يرجع للموقع           → 5 handlers تعمل مرة أخرى
5. iOS يحاول reconnect   → عمليات إضافية

كل تبديل = 10-15 عملية إضافية
مع 20 تبديل في الساعة = 200-300 عملية إضافية
```

---

## 🔍 الخلاصة المرئية

```
┌───────────────────────────────────────────────────────────┐
│                 🔄 دورة المشكلة الكاملة                  │
├───────────────────────────────────────────────────────────┤
│                                                           │
│   [فتح الموقع]                                           │
│         ↓                                                 │
│   [3 أنظمة تبدأ معاً]                                    │
│    ├─ Socket.IO                                           │
│    ├─ Polling (1.5s)                                      │
│    └─ Audio (∞)                                           │
│         ↓                                                 │
│   [40 طلب/دقيقة]                                         │
│         ↓                                                 │
│   [تبديل تاب] ──→ [5 handlers] ──→ [7-9 عمليات]         │
│         ↓                                                 │
│   [Socket ينقطع؟]                                        │
│         ↙️      ↘️                                         │
│      نعم        لا                                        │
│       ↓          ↓                                        │
│   [160 طلب/دقيقة] [40 طلب/دقيقة]                        │
│       ↓          ↓                                        │
│   [reconnect ∞] [يستمر]                                  │
│       ↓          ↓                                        │
│   [الخادم مكتظ] [شعور بـ refresh]                        │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

---

## ✅ النتيجة النهائية

**السؤال:** لماذا الموقع يعمل refresh ويعيد الاتصال؟

**الجواب المرئي:**

```
                    [الأسباب]
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ↓               ↓               ↓
   ┌────────┐     ┌─────────┐    ┌─────────┐
   │Polling │     │Reconnect│    │Multiple │
   │(1.5s)  │  +  │(Infinity)│ +  │Handlers │
   │40/min  │     │         │    │(5 معالج)│
   └────────┘     └─────────┘    └─────────┘
        │               │               │
        └───────────────┴───────────────┘
                        │
                        ↓
              ┌──────────────────┐
              │   [النتيجة]      │
              ├──────────────────┤
              │ • 2,500+ طلب/ساعة │
              │ • شعور بـ refresh│
              │ • reconnecting   │
              │ • استنزاف موارد  │
              └──────────────────┘
```

---

**📅 تم التحليل:** 2025-10-17  
**🎯 نوع الملف:** مخطط تفاعلي  
**✅ الحالة:** شرح كامل لتفاعل الأنظمة
