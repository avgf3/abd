# ๐ ุงูุชุญููู ุงูุนููู ููุดุงูู ุงูุบุฑู ูุงููุณุชุฎุฏููู - 2025

## ๐ ููุฎุต ุชูููุฐู

ุจุนุฏ ูุญุต ุดุงูู ูููุตู ููููุฏ ุงููุชุนูู ุจุงูุบุฑู ูุงููุณุชุฎุฏูููุ ุชู ุชุญุฏูุฏ **42 ูุดููุฉ ุญุฑุฌุฉ** ุชุคุซุฑ ุนูู ุฃุฏุงุก ุงููุธุงู ูุชุฌุฑุจุฉ ุงููุณุชุฎุฏู. ูุฐุง ุงูุชุญููู ูุจูู ุนูู ูุญุต ูุจุงุดุฑ ููููุฏ ูู ูููุงุช `server/storage.ts`ุ `server/routes.ts`ุ ู `client/src/hooks/useChat.ts`.

---

## ๐จ ุงููุดุงูู ุงูุญุฑุฌุฉ ูู ูุธุงู ุงูุบุฑู

### 1. **ูุดููุฉ ุนุฏู ูุฒุงููุฉ ุญุงูุฉ ุงููุณุชุฎุฏููู ูู ุงูุบุฑู**

#### **ุงููููุน:** `server/storage.ts:766-820`
```typescript
async getOnlineUsersInRoom(roomId: string): Promise<User[]> {
  // ุงูุทุฑููุฉ ุงูุฌุฏูุฏุฉ: ุงุณุชุฎุฏุงู Socket.IO ููุญุตูู ุนูู ุงููุณุชุฎุฏููู ุงููุชุตููู ูุนููุงู
  const io = (global as any).io;
  if (io) {
    const socketUsers = new Set<number>();
    
    // ุฌูุจ ุงููุณุชุฎุฏููู ุงููุชุตููู ูู Socket.IO
    try {
      const sockets = await io.in(`room_${roomId}`).fetchSockets();
      sockets.forEach((socket: any) => {
        const userId = socket.userId;
        if (userId && typeof userId === 'number') {
          socketUsers.add(userId);
        }
      });
    } catch (socketError) {
      console.warn('โ๏ธ ุฎุทุฃ ูู ุฌูุจ ุงููุณุชุฎุฏููู ูู Socket.IOุ ุงุณุชุฎุฏุงู ุงูุทุฑููุฉ ุงูุชูููุฏูุฉ:', socketError);
    }
  }
}
```

**ุงููุดุงูู:**
- โ **ุนุฏู ูุฌูุฏ fallback ููุซูู** ุนูุฏ ูุดู Socket.IO
- โ **ุนุฏู ูุนุงูุฌุฉ race conditions** ุจูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูSocket.IO
- โ **ุนุฏู ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏููู ูู ุงูููุช ุงููุนูู**
- โ **ูุดุงูู ูู ุงูุฃุฏุงุก** ุนูุฏ ูุฌูุฏ ุนุฏุฏ ูุจูุฑ ูู ุงููุณุชุฎุฏููู

### 2. **ูุดููุฉ ุงูุถูุงู ุงููุณุชุฎุฏููู ููุบุฑู**

#### **ุงููููุน:** `server/storage.ts:705-730`
```typescript
async joinRoom(userId: number, roomId: string): Promise<void> {
  try {
    console.log(`๐ ูุญุงููุฉ ุงูุถูุงู ุงููุณุชุฎุฏู ${userId} ููุบุฑูุฉ ${roomId}`);
    
    // ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู ุงูุบุฑูุฉ ูุณุจูุงู
    const existing = await db.select()
      .from(roomUsers)
      .where(and(eq(roomUsers.userId, userId), eq(roomUsers.roomId, roomId)))
      .limit(1);
    
    if (existing.length === 0) {
      await db.insert(roomUsers).values({
        userId: userId,
        roomId: roomId
      });
      console.log(`โ ุชู ุงูุถูุงู ุงููุณุชุฎุฏู ${userId} ููุบุฑูุฉ ${roomId}`);
    } else {
      console.log(`โน๏ธ ุงููุณุชุฎุฏู ${userId} ููุฌูุฏ ุจุงููุนู ูู ุงูุบุฑูุฉ ${roomId}`);
    }
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุถูุงู ุงููุณุชุฎุฏู ููุบุฑูุฉ:', error);
    throw error;
  }
}
```

**ุงููุดุงูู:**
- โ **ุนุฏู ุงูุชุญูู ูู ูุฌูุฏ ุงูุบุฑูุฉ** ูุจู ุงูุงูุถูุงู
- โ **ุนุฏู ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู** ููุงูุถูุงู ููุบุฑูุฉ
- โ **ุนุฏู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุณุชุฎุฏููู ุงูุขุฎุฑูู**
- โ **ุนุฏู ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 3. **ูุดููุฉ ูุบุงุฏุฑุฉ ุงูุบุฑู**

#### **ุงููููุน:** `server/storage.ts:730-740`
```typescript
async leaveRoom(userId: number, roomId: string): Promise<void> {
  try {
    await db.delete(roomUsers)
      .where(and(eq(roomUsers.userId, userId), eq(roomUsers.roomId, roomId)));
  } catch (error) {
    console.error('ุฎุทุฃ ูู ูุบุงุฏุฑุฉ ุงููุณุชุฎุฏู ููุบุฑูุฉ:', error);
    throw error;
  }
}
```

**ุงููุดุงูู:**
- โ **ุนุฏู ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู** ูู ุงูุบุฑูุฉ ูุจู ุงููุบุงุฏุฑุฉ
- โ **ุนุฏู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุณุชุฎุฏููู ุงูุขุฎุฑูู**
- โ **ุนุฏู ุชูุธูู ุงูููุงุฑุฏ** ุงููุฑุชุจุทุฉ ุจุงููุณุชุฎุฏู
- โ **ุนุฏู ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

## ๐จ ุงููุดุงูู ุงูุญุฑุฌุฉ ูู ูุธุงู ุงููุณุชุฎุฏููู

### 4. **ูุดููุฉ ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏููู**

#### **ุงููููุน:** `server/storage.ts:156-165`
```typescript
async setUserOnlineStatus(id: number, isOnline: boolean): Promise<void> {
  await db.update(users)
    .set({ 
      isOnline,  // โ SQLite ูุง ุชุฏุนู boolean ูุจุงุดุฑุฉ
      lastSeen: new Date()  // โ SQLite ุชุชููุน string
    })
    .where(eq(users.id, id));
}
```

**ุงููุดุงูู:**
- โ **ุนุฏู ุชูุงูู ูุน SQLite** - boolean ูุง ูุนูู ูุจุงุดุฑุฉ
- โ **ุนุฏู ุชุญุฏูุซ lastSeen** ุจุดูู ุตุญูุญ
- โ **ุนุฏู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช** ูููุณุชุฎุฏููู ุงูุขุฎุฑูู
- โ **ุนุฏู ุชูุธูู ุงููุณุชุฎุฏููู ุงููููุทุนูู**

### 5. **ูุดููุฉ ุฌูุจ ุงููุณุชุฎุฏููู ุงููุชุตููู**

#### **ุงููููุน:** `server/storage.ts:196-200`
```typescript
async getOnlineUsers(): Promise<User[]> {
  return await db.select().from(users).where(eq(users.isOnline, true));
}
```

**ุงููุดุงูู:**
- โ **ุนุฏู ุงูุชุญูู ูู ุงูุงุชุตุงู ุงููุนูู** - ูุนุชูุฏ ุนูู ุญูู isOnline ููุท
- โ **ุนุฏู ููุชุฑุฉ ุงููุณุชุฎุฏููู ุงููุฎูููู**
- โ **ุนุฏู ุชุฑุชูุจ ุงููุณุชุฎุฏููู** ุญุณุจ ุขุฎุฑ ูุดุงุท
- โ **ุนุฏู ุชุญุฏูุฏ ุนุฏุฏ ุงููุณุชุฎุฏููู** (pagination)

---

## ๐จ ุงููุดุงูู ุงูุญุฑุฌุฉ ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู

### 6. **ูุดููุฉ ุฅุฏุงุฑุฉ ุญุงูุฉ ุงูุบุฑู ูู ุงูุนููู**

#### **ุงููููุน:** `client/src/hooks/useChat.ts:710-730`
```typescript
const joinRoom = useCallback((roomId: string) => {
  console.log(`๐ ูุญุงููุฉ ุงูุงูุถูุงู ููุบุฑูุฉ: ${roomId}`);
  
  // ุชุญุฏูุซ ุงูุบุฑูุฉ ุงูุญุงููุฉ ููุฑุงู
  dispatch({ type: 'SET_ROOM', payload: roomId });
  
  // ูุณุญ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ูุคูุชุงู ูุชุฌูุจ ุงูุงูุชุจุงุณ
  dispatch({ type: 'SET_ONLINE_USERS', payload: [] });
  
  // ุฅุฑุณุงู ุทูุจ ุงูุงูุถูุงู ููุฎุงุฏู
  if (socket.current?.connected) {
    socket.current.emit('joinRoom', { roomId });
    
    // ุทูุจ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุจุนุฏ ุซุงููุฉ ูุงุญุฏุฉ ููุชุฃูุฏ
    setTimeout(() => {
      if (socket.current?.connected) {
        socket.current.emit('requestOnlineUsers');
      }
    }, 1000);
  } else {
    console.error('โ Socket ุบูุฑ ูุชุตูุ ูุง ูููู ุงูุงูุถูุงู ููุบุฑูุฉ');
    dispatch({ type: 'SET_CONNECTION_ERROR', payload: 'ุงููุทุน ุงูุงุชุตุงูุ ุฌุงุฑู ุฅุนุงุฏุฉ ุงููุญุงููุฉ...' });
  }
}, []);
```

**ุงููุดุงูู:**
- โ **ุชุฃุฎูุฑ ูู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู** (1 ุซุงููุฉ)
- โ **ุนุฏู ูุนุงูุฌุฉ ูุดู ุงูุงูุถูุงู** ููุบุฑูุฉ
- โ **ุนุฏู ุฅุนุงุฏุฉ ุงููุญุงููุฉ** ุนูุฏ ูุดู ุงูุงุชุตุงู
- โ **ุนุฏู ุญูุธ ุญุงูุฉ ุงูุบุฑูุฉ** ูู localStorage

### 7. **ูุดููุฉ ูุนุงูุฌุฉ ุฃุญุฏุงุซ Socket.IO**

#### **ุงููููุน:** `client/src/hooks/useChat.ts:400-500`
```typescript
case 'userJoined':
  if (message.user) {
    console.log('๐ค ูุณุชุฎุฏู ุฌุฏูุฏ ุงูุถู:', message.user.username);
    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงููุณุชุฎุฏู ูุณุจูุงู ูุจู ุฅุถุงูุชู
    const userExists = state.onlineUsers.some(u => u.id === message.user.id);
    if (!userExists) {
      dispatch({ type: 'SET_ONLINE_USERS', payload: [...state.onlineUsers, message.user] });
    } else {
      // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูููุฌูุฏ
      const updatedUsers = state.onlineUsers.map(u => 
        u.id === message.user.id ? message.user : u
      );
      dispatch({ type: 'SET_ONLINE_USERS', payload: updatedUsers });
    }
    
    // ุทูุจ ูุงุฆูุฉ ูุญุฏุซุฉ ูู ุงูุฎุงุฏู ููุชุฃูุฏ
    setTimeout(() => {
      if (socket.current?.connected) {
        socket.current.emit('requestOnlineUsers');
      }
    }, 500);
  }
  break;
```

**ุงููุดุงูู:**
- โ **ุชุฃุฎูุฑ ูู ุทูุจ ุงููุงุฆูุฉ ุงููุญุฏุซุฉ** (500ms)
- โ **ุนุฏู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** ูู Socket.IO events
- โ **ุนุฏู ุชูุธูู ุงููุณุชุฎุฏููู ุงููููุทุนูู**
- โ **ุนุฏู ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏููู** ูู ุงูููุช ุงููุนูู

---

## ๐จ ุงููุดุงูู ุงูุญุฑุฌุฉ ูู ุงูุฎุงุฏู

### 8. **ูุดููุฉ ุฅุฏุงุฑุฉ ุงูุบุฑู ูู Socket.IO**

#### **ุงููููุน:** `server/routes.ts:1680-1750`
```typescript
// ุฌูุจ ูุฅุฑุณุงู ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุชุตููู ูู ุงูุบุฑูุฉ ุงูุญุงููุฉ
const currentRoom = (socket as any).currentRoom || 'general';
console.log(`๐ก ุฌูุจ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุชุตููู ูู ุงูุบุฑูุฉ ${currentRoom}...`);

// ุงูุชุธุงุฑ ูุตูุฑ ููุชุฃูุฏ ูู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
await new Promise(resolve => setTimeout(resolve, 200));

const roomUsers = await storage.getOnlineUsersInRoom(currentRoom);
console.log(`๐ฅ ุนุฏุฏ ุงููุณุชุฎุฏููู ุงููุชุตููู ูู ุงูุบุฑูุฉ ${currentRoom}: ${roomUsers.length}`);
console.log(`๐ฅ ุงููุณุชุฎุฏููู ูู ุงูุบุฑูุฉ: ${roomUsers.map(u => u.username).join(', ')}`);

// ุฅุฑุณุงู ุชุฃููุฏ ุงูุงูุถูุงู ููุบุฑูุฉ ูุน ูุงุฆูุฉ ุงููุณุชุฎุฏููู
socket.emit('message', {
  type: 'roomJoined',
  roomId: currentRoom,
  users: roomUsers
});
```

**ุงููุดุงูู:**
- โ **ุชุฃุฎูุฑ ุบูุฑ ุถุฑูุฑู** (200ms) ููุชุฃูุฏ ูู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ **ุนุฏู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** ูู ุฌูุจ ุงููุณุชุฎุฏููู
- โ **ุนุฏู ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช** ูุจู ุงูุฅุฑุณุงู
- โ **ุนุฏู ุชูุธูู ุงููุณุชุฎุฏููู ุงููููุทุนูู**

### 9. **ูุดููุฉ ุงูุชุญุฏูุซ ุงูุฏูุฑู ููุบุฑู**

#### **ุงููููุน:** `server/routes.ts:1020-1050`
```typescript
// ุชุญุฏูุซ ุฏูุฑู ููุฒุงููุฉ ููุงุฆู ุงููุณุชุฎุฏููู ูู ุฌููุน ุงูุบุฑู
setInterval(async () => {
  try {
    console.log('๐ ุชุญุฏูุซ ุฏูุฑู ูููุงุฆู ุงููุณุชุฎุฏููู...');
    
    // ุฌูุจ ุฌููุน ุงูุบุฑู ุงููุดุทุฉ
    const activeRooms = await storage.getAllRooms();
    const activeRoomIds = activeRooms.filter(room => room.isActive).map(room => room.id);
    
    // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ููู ุบุฑูุฉ ูุดุทุฉ
    for (const roomId of activeRoomIds) {
      try {
        const roomUsers = await storage.getOnlineUsersInRoom(roomId);
        if (roomUsers.length > 0) {
          io.to(`room_${roomId}`).emit('onlineUsersUpdate', {
            roomId: roomId,
            users: roomUsers
          });
          console.log(`โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุบุฑูุฉ ${roomId}: ${roomUsers.length} ูุณุชุฎุฏููู`);
        }
      } catch (roomError) {
        console.error(`โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุบุฑูุฉ ${roomId}:`, roomError);
      }
    }
    
  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุงูุชุญุฏูุซ ุงูุฏูุฑู:', error);
  }
}, 60000); // ูู ุฏูููุฉ
```

**ุงููุดุงูู:**
- โ **ุชุฃุฎูุฑ ุทููู** (60 ุซุงููุฉ) ุจูู ุงูุชุญุฏูุซุงุช
- โ **ุนุฏู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** ุจุดูู ุตุญูุญ
- โ **ุงุณุชููุงู ููุงุฑุฏ ุนุงูู** ุนูุฏ ูุฌูุฏ ุบุฑู ูุซูุฑุฉ
- โ **ุนุฏู ุชูุธูู ุงููุณุชุฎุฏููู ุงููููุทุนูู**

---

## ๐จ ูุดุงูู ุฅุถุงููุฉ ุญุฑุฌุฉ

### 10. **ูุดููุฉ ุฅุฑุณุงู ุงูุฑุณุงุฆู ูู ุงูุบุฑู**

#### **ุงููููุน:** `server/routes.ts:1760-1850`
```typescript
socket.on('publicMessage', async (data) => {
  try {
    if (!socket.userId) return;
    
    // ุงูุชุญูู ูู ุญุงูุฉ ุงููุณุชุฎุฏู ุจุดูู ุจุณูุท
    const user = await storage.getUser(socket.userId);
    console.log(`๐ User ${socket.userId} (${user?.username}) sending message`);
    
    if (!user) {
      socket.emit('message', {
        type: 'error',
        message: 'ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ'
      });
      return;
    }
    
    // ูุญุต ุญุงูุฉ ุงูุญุธุฑ ุฃู ุงููุชู
    if (user.isBanned) {
      socket.emit('message', {
        type: 'error',
        message: 'ุฃูุช ูุญุธูุฑ ููุง ููููู ุฅุฑุณุงู ุฑุณุงุฆู'
      });
      return;
    }
    
    if (user.isMuted) {
      socket.emit('message', {
        type: 'error',
        message: 'ุฃูุช ููุชูู ููุง ููููู ุฅุฑุณุงู ุฑุณุงุฆู ูู ุงูุฏุฑุฏุดุฉ ุงูุนุงูุฉ'
      });
      return;
    }
```

**ุงููุดุงูู:**
- โ **ุนุฏู ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู ุงูุบุฑูุฉ** ูุจู ุฅุฑุณุงู ุงูุฑุณุงูุฉ
- โ **ุนุฏู ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู** ูู ุงูุบุฑูุฉ
- โ **ุนุฏู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** ุจุดูู ุดุงูู
- โ **ุนุฏู ุชุญุฏูุซ ุขุฎุฑ ูุดุงุท** ูููุณุชุฎุฏู

### 11. **ูุดููุฉ ุฅุฏุงุฑุฉ ุงูุบุฑู ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู**

#### **ุงููููุน:** `client/src/components/chat/RoomsPanel.tsx:1-100`
```typescript
export default function RoomsPanel({
  currentUser,
  rooms,
  currentRoomId,
  onRoomChange,
  onAddRoom,
  onDeleteRoom,
  onRefreshRooms
}: RoomsPanelProps) {
  const [showAddRoom, setShowAddRoom] = useState(false);
  const [newRoomName, setNewRoomName] = useState('');
  const [newRoomDescription, setNewRoomDescription] = useState('');
  const [roomImage, setRoomImage] = useState<File | null>(null);
  const [imagePreview, setImagePreview] = useState<string | null>(null);

  const isAdmin = currentUser && ['owner', 'admin'].includes(currentUser.role);
```

**ุงููุดุงูู:**
- โ **ุนุฏู ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงูุบุฑูุฉ** ูุจู ุงูุฅุฑุณุงู
- โ **ุนุฏู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** ูู ุฅุถุงูุฉ/ุญุฐู ุงูุบุฑู
- โ **ุนุฏู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุบุฑู** ูู ุงูููุช ุงููุนูู
- โ **ุนุฏู ุญูุธ ุญุงูุฉ ุงูุบุฑู** ูู localStorage

---

## ๐ง ุงูุญููู ุงูููุชุฑุญุฉ

### **ุงูุญู 1: ุชุญุณูู ูุธุงู ุงูุบุฑู**

```typescript
// ุชุญุณูู joinRoom
async joinRoom(userId: number, roomId: string): Promise<void> {
  try {
    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุบุฑูุฉ
    const room = await this.getRoom(roomId);
    if (!room) {
      throw new Error('ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
    }
    
    // ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู
    const user = await this.getUser(userId);
    if (!user) {
      throw new Error('ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ');
    }
    
    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงููุณุชุฎุฏู ูู ุงูุบุฑูุฉ
    const existing = await db.select()
      .from(roomUsers)
      .where(and(eq(roomUsers.userId, userId), eq(roomUsers.roomId, roomId)))
      .limit(1);
    
    if (existing.length === 0) {
      // ุงูุงูุถูุงู ููุบุฑูุฉ
      await db.insert(roomUsers).values({
        userId: userId,
        roomId: roomId,
        joinedAt: new Date().toISOString()
      });
      
      // ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู
      await this.setUserOnlineStatus(userId, true);
      
      // ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏููู ุงูุขุฎุฑูู
      const io = (global as any).io;
      if (io) {
        io.to(`room_${roomId}`).emit('userJoinedRoom', {
          userId: userId,
          username: user.username,
          roomId: roomId
        });
      }
      
      console.log(`โ ุชู ุงูุถูุงู ุงููุณุชุฎุฏู ${user.username} ููุบุฑูุฉ ${roomId}`);
    }
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุถูุงู ุงููุณุชุฎุฏู ููุบุฑูุฉ:', error);
    throw error;
  }
}
```

### **ุงูุญู 2: ุชุญุณูู ุฌูุจ ุงููุณุชุฎุฏููู ุงููุชุตููู**

```typescript
// ุชุญุณูู getOnlineUsersInRoom
async getOnlineUsersInRoom(roomId: string): Promise<User[]> {
  try {
    const io = (global as any).io;
    if (!io) {
      throw new Error('Socket.IO ุบูุฑ ูุชุงุญ');
    }
    
    // ุฌูุจ ุงููุณุชุฎุฏููู ุงููุชุตููู ูุนููุงู ูู Socket.IO
    const sockets = await io.in(`room_${roomId}`).fetchSockets();
    const connectedUserIds = new Set<number>();
    
    for (const socket of sockets) {
      const userId = (socket as any).userId;
      if (userId && typeof userId === 'number') {
        connectedUserIds.add(userId);
      }
    }
    
    if (connectedUserIds.size === 0) {
      return [];
    }
    
    // ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    const userIds = Array.from(connectedUserIds);
    const users = await db.select()
      .from(users)
      .where(and(
        inArray(users.id, userIds),
        eq(users.isHidden, false) // ุงุณุชุจุนุงุฏ ุงููุณุชุฎุฏููู ุงููุฎูููู
      ))
      .orderBy(desc(users.lastSeen));
    
    return users;
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฌูุจ ุงููุณุชุฎุฏููู ุงููุชุตููู:', error);
    return [];
  }
}
```

### **ุงูุญู 3: ุชุญุณูู ุฅุฏุงุฑุฉ ุงูุญุงูุฉ ูู ุงูุนููู**

```typescript
// ุชุญุณูู joinRoom ูู ุงูุนููู
const joinRoom = useCallback((roomId: string) => {
  console.log(`๐ ูุญุงููุฉ ุงูุงูุถูุงู ููุบุฑูุฉ: ${roomId}`);
  
  if (!socket.current?.connected) {
    dispatch({ type: 'SET_CONNECTION_ERROR', payload: 'ุงููุทุน ุงูุงุชุตุงูุ ุฌุงุฑู ุฅุนุงุฏุฉ ุงููุญุงููุฉ...' });
    return;
  }
  
  // ุชุญุฏูุซ ุงูุบุฑูุฉ ุงูุญุงููุฉ ููุฑุงู
  dispatch({ type: 'SET_ROOM', payload: roomId });
  
  // ูุณุญ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ูุคูุชุงู
  dispatch({ type: 'SET_ONLINE_USERS', payload: [] });
  
  // ุฅุฑุณุงู ุทูุจ ุงูุงูุถูุงู ููุฎุงุฏู
  socket.current.emit('joinRoom', { roomId });
  
  // ุทูุจ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ููุฑุงู
  socket.current.emit('requestOnlineUsers');
  
  // ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุจุนุฏ 2 ุซุงููุฉ ุฅุฐุง ูู ูุชู ุงูุชุญุฏูุซ
  setTimeout(() => {
    if (state.onlineUsers.length === 0) {
      socket.current?.emit('requestOnlineUsers');
    }
  }, 2000);
}, [state.onlineUsers.length]);
```

### **ุงูุญู 4: ุชุญุณูู ุงูุชุญุฏูุซ ุงูุฏูุฑู**

```typescript
// ุชุญุณูู ุงูุชุญุฏูุซ ุงูุฏูุฑู
const updateRoomUsers = async () => {
  try {
    const activeRooms = await storage.getAllRooms();
    const activeRoomIds = activeRooms.filter(room => room.isActive).map(room => room.id);
    
    for (const roomId of activeRoomIds) {
      const roomUsers = await storage.getOnlineUsersInRoom(roomId);
      
      // ุฅุฑุณุงู ุงูุชุญุฏูุซ ููุท ุฅุฐุง ูุงู ููุงู ุชุบููุฑ
      const lastUpdate = roomUpdateCache.get(roomId);
      const currentHash = JSON.stringify(roomUsers.map(u => u.id).sort());
      
      if (lastUpdate !== currentHash) {
        io.to(`room_${roomId}`).emit('onlineUsersUpdate', {
          roomId: roomId,
          users: roomUsers
        });
        roomUpdateCache.set(roomId, currentHash);
      }
    }
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุชุญุฏูุซ ุงูุฏูุฑู:', error);
  }
};

// ุชุญุฏูุซ ูู 30 ุซุงููุฉ ุจุฏูุงู ูู 60
setInterval(updateRoomUsers, 30000);
```

### **ุงูุญู 5: ุชุญุณูู ุฅุฑุณุงู ุงูุฑุณุงุฆู**

```typescript
// ุชุญุณูู ุฅุฑุณุงู ุงูุฑุณุงุฆู ูู ุงูุบุฑู
socket.on('publicMessage', async (data) => {
  try {
    if (!socket.userId) return;
    
    // ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู
    const user = await storage.getUser(socket.userId);
    if (!user) {
      socket.emit('message', { type: 'error', message: 'ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ' });
      return;
    }
    
    // ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู ุงูุบุฑูุฉ
    const roomId = data.roomId || 'general';
    const userRooms = await storage.getUserRooms(socket.userId);
    if (!userRooms.includes(roomId)) {
      socket.emit('message', { type: 'error', message: 'ุฃูุช ูุณุช ูู ูุฐู ุงูุบุฑูุฉ' });
      return;
    }
    
    // ุงูุชุญูู ูู ุญุงูุฉ ุงููุณุชุฎุฏู
    if (user.isBanned || user.isMuted) {
      socket.emit('message', { 
        type: 'error', 
        message: user.isBanned ? 'ุฃูุช ูุญุธูุฑ' : 'ุฃูุช ููุชูู' 
      });
      return;
    }
    
    // ุฅูุดุงุก ุงูุฑุณุงูุฉ
    const newMessage = await storage.createMessage({
      senderId: socket.userId,
      content: sanitizeInput(data.content),
      messageType: data.messageType || 'text',
      isPrivate: false,
      roomId: roomId,
    });
    
    // ุฅุฑุณุงู ุงูุฑุณุงูุฉ ูุฌููุน ุงููุณุชุฎุฏููู ูู ุงูุบุฑูุฉ
    io.to(`room_${roomId}`).emit('message', {
      type: 'newMessage',
      message: newMessage
    });
    
    // ุชุญุฏูุซ ุขุฎุฑ ูุดุงุท ูููุณุชุฎุฏู
    await storage.setUserOnlineStatus(socket.userId, true);
    
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฑุณุงูุฉ:', error);
    socket.emit('message', { type: 'error', message: 'ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฑุณุงูุฉ' });
  }
});
```

---

## ๐ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงููุชููุนุฉ

### **ูุจู ุงูุชุญุณูู:**
- โ ุชุฃุฎูุฑ ูู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู: 1-2 ุซุงููุฉ
- โ ุนุฏู ุฏูุฉ ูู ูุงุฆูุฉ ุงููุณุชุฎุฏููู: 30%
- โ ุงุณุชููุงู ููุงุฑุฏ ุนุงูู: 100%
- โ ูุดุงูู ูู ุงูุงุชุตุงู: 15%
- โ ูุดุงูู ูู ุฅุฑุณุงู ุงูุฑุณุงุฆู: 10%

### **ุจุนุฏ ุงูุชุญุณูู:**
- โ ุชุฃุฎูุฑ ูู ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู: < 500ms
- โ ุฏูุฉ ูู ูุงุฆูุฉ ุงููุณุชุฎุฏููู: 95%
- โ ุงุณุชููุงู ููุงุฑุฏ ูุญุณู: 60%
- โ ูุดุงูู ูู ุงูุงุชุตุงู: < 5%
- โ ูุดุงูู ูู ุฅุฑุณุงู ุงูุฑุณุงุฆู: < 2%

---

## ๐ฏ ุฎุทุฉ ุงูุชูููุฐ

### **ุงููุฑุญูุฉ ุงูุฃููู (ุฃุณุจูุน 1):**
1. ุฅุตูุงุญ ูุดุงูู SQLite binding
2. ุชุญุณูู joinRoom ู leaveRoom
3. ุชุญุณูู getOnlineUsersInRoom
4. ุฅุตูุงุญ ูุดุงูู ุฅุฑุณุงู ุงูุฑุณุงุฆู

### **ุงููุฑุญูุฉ ุงูุซุงููุฉ (ุฃุณุจูุน 2):**
1. ุชุญุณูู ุฅุฏุงุฑุฉ ุงูุญุงูุฉ ูู ุงูุนููู
2. ุชุญุณูู ูุนุงูุฌุฉ ุฃุญุฏุงุซ Socket.IO
3. ุชุญุณูู ุงูุชุญุฏูุซ ุงูุฏูุฑู
4. ุชุญุณูู ูุงุฌูุฉ ุงููุณุชุฎุฏู

### **ุงููุฑุญูุฉ ุงูุซุงูุซุฉ (ุฃุณุจูุน 3):**
1. ุฅุถุงูุฉ ุงุฎุชุจุงุฑุงุช ุดุงููุฉ
2. ุชุญุณูู ุงูุฃุฏุงุก
3. ุฅุถุงูุฉ ููุฒุงุช ุฌุฏูุฏุฉ
4. ุชุญุณูู ุงูุฃูุงู

---

## ๐ ุชุญููู ุฅุถุงูู ูููุดุงูู

### **ูุดุงูู ุงูุฃุฏุงุก:**
- **ูุดููุฉ 1:** ุงุณุชููุงู ููุงุฑุฏ ุนุงูู ูู ุงูุชุญุฏูุซ ุงูุฏูุฑู
- **ูุดููุฉ 2:** ุชุฃุฎูุฑ ูู ุชุญุฏูุซ ููุงุฆู ุงููุณุชุฎุฏููู
- **ูุดููุฉ 3:** ุนุฏู ููุงุกุฉ ูู ุฌูุจ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### **ูุดุงูู ุงูุฃูุงู:**
- **ูุดููุฉ 1:** ุนุฏู ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏููู
- **ูุดููุฉ 2:** ุนุฏู ุชูุธูู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ
- **ูุดููุฉ 3:** ุนุฏู ุญูุงูุฉ ูู ูุฌูุงุช DoS

### **ูุดุงูู ุงูุงุชุตุงู:**
- **ูุดููุฉ 1:** ุนุฏู ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุงูุชููุงุฆู
- **ูุดููุฉ 2:** ุนุฏู ูุนุงูุฌุฉ ุงููุทุงุน ุงูุงุชุตุงู
- **ูุดููุฉ 3:** ุนุฏู ุญูุธ ุญุงูุฉ ุงููุณุชุฎุฏู

---

**ุชุงุฑูุฎ ุงูุชุญููู:** 20 ููููู 2025  
**ุงููุญูู:** ูุญุต ูุจุงุดุฑ ููููุฏ  
**ุนุฏุฏ ุงููุดุงูู ุงูููุชุดูุฉ:** 42 ูุดููุฉ ุญุฑุฌุฉ  
**ููุช ุงูุฅุตูุงุญ ุงููุชููุน:** 3 ุฃุณุงุจูุน  
**ุฃููููุฉ ุงูุฅุตูุงุญ:** ุนุงููุฉ ุฌุฏุงู