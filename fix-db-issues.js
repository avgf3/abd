#!/usr/bin/env node

import dotenv from 'dotenv';
import postgres from 'postgres';

dotenv.config();

console.log('ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

async function fixDatabaseIssues() {
  try {
    const databaseUrl = process.env.DATABASE_URL || 'postgresql://postgres:password@localhost:5432/chatapp';
    console.log('ğŸ“¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', databaseUrl.replace(/\/\/.*@/, '//***@'));
    
    const client = postgres(databaseUrl, { max: 1 });
    
    // 1. Ø­Ø°Ù Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©...');
    
    const tablesToDrop = [
      'level_settings',
      'points_history',
      'blocked_devices',
      'notifications',
      'friends',
      'messages',
      'users'
    ];
    
    for (const table of tablesToDrop) {
      try {
        await client`DROP TABLE IF EXISTS ${client(table)} CASCADE`;
        console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø¬Ø¯ÙˆÙ„ ${table}`);
      } catch (error) {
        console.log(`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¬Ø¯ÙˆÙ„ ${table}:`, error.message);
      }
    }
    
    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
    console.log('ğŸ—ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...');
    
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    await client`
      CREATE TABLE users (
        id SERIAL PRIMARY KEY,
        username TEXT NOT NULL UNIQUE,
        password TEXT,
        user_type TEXT NOT NULL DEFAULT 'guest',
        role TEXT NOT NULL DEFAULT 'guest',
        profile_image TEXT,
        profile_banner TEXT,
        profile_background_color TEXT DEFAULT '#3c0d0d',
        status TEXT,
        gender TEXT,
        age INTEGER,
        country TEXT,
        relation TEXT,
        bio TEXT,
        is_online BOOLEAN DEFAULT false,
        is_hidden BOOLEAN DEFAULT false,
        last_seen TIMESTAMP,
        join_date TIMESTAMP DEFAULT now(),
        created_at TIMESTAMP DEFAULT now(),
        is_muted BOOLEAN DEFAULT false,
        mute_expiry TIMESTAMP,
        is_banned BOOLEAN DEFAULT false,
        ban_expiry TIMESTAMP,
        is_blocked BOOLEAN DEFAULT false,
        ip_address VARCHAR(45),
        device_id VARCHAR(100),
        ignored_users TEXT DEFAULT '[]',
        username_color TEXT DEFAULT '#FFFFFF',
        user_theme TEXT DEFAULT 'default',
        profile_effect TEXT DEFAULT 'none',
        points INTEGER DEFAULT 0,
        level INTEGER DEFAULT 1,
        total_points INTEGER DEFAULT 0,
        level_progress INTEGER DEFAULT 0
      )
    `;
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ users');
    
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    await client`
      CREATE TABLE messages (
        id SERIAL PRIMARY KEY,
        sender_id INTEGER REFERENCES users(id),
        receiver_id INTEGER REFERENCES users(id),
        content TEXT NOT NULL,
        message_type TEXT NOT NULL DEFAULT 'text',
        is_private BOOLEAN DEFAULT false,
        room_id TEXT DEFAULT 'general',
        timestamp TIMESTAMP DEFAULT now()
      )
    `;
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ messages');
    
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
    await client`
      CREATE TABLE friends (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id),
        friend_id INTEGER REFERENCES users(id),
        status TEXT NOT NULL DEFAULT 'pending',
        created_at TIMESTAMP DEFAULT now()
      )
    `;
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ friends');
    
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    await client`
      CREATE TABLE notifications (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id),
        type TEXT NOT NULL,
        title TEXT NOT NULL,
        message TEXT NOT NULL,
        is_read BOOLEAN DEFAULT false,
        data JSONB,
        created_at TIMESTAMP DEFAULT now()
      )
    `;
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ notifications');
    
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨Ø©
    await client`
      CREATE TABLE blocked_devices (
        id SERIAL PRIMARY KEY,
        ip_address TEXT NOT NULL,
        device_id TEXT NOT NULL,
        user_id INTEGER NOT NULL,
        reason TEXT NOT NULL,
        blocked_at TIMESTAMP NOT NULL,
        blocked_by INTEGER NOT NULL
      )
    `;
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ blocked_devices');
    
    // Ø¬Ø¯ÙˆÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‚Ø§Ø·
    await client`
      CREATE TABLE points_history (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id),
        points INTEGER NOT NULL,
        reason TEXT NOT NULL,
        action TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT now()
      )
    `;
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ points_history');
    
    // Ø¬Ø¯ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
    await client`
      CREATE TABLE level_settings (
        id SERIAL PRIMARY KEY,
        level INTEGER NOT NULL,
        required_points INTEGER NOT NULL,
        title TEXT NOT NULL,
        color TEXT DEFAULT '#FFFFFF',
        benefits JSONB,
        created_at TIMESTAMP DEFAULT now(),
        CONSTRAINT level_settings_level_unique UNIQUE(level)
      )
    `;
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ level_settings');
    
    // 3. Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    console.log('ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©...');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§Ù„Ùƒ Ø§ÙØªØ±Ø§Ø¶ÙŠ
    await client`
      INSERT INTO users (username, user_type, role, points, level, total_points, level_progress)
      VALUES ('admin', 'owner', 'owner', 1000, 10, 1000, 0)
    `;
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… admin');
    
    // Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const defaultLevels = [
      { level: 1, required_points: 0, title: 'Ù…Ø¨ØªØ¯Ø¦', color: '#FFFFFF' },
      { level: 2, required_points: 100, title: 'Ù…ØªÙ‚Ø¯Ù…', color: '#00FF00' },
      { level: 3, required_points: 300, title: 'Ø®Ø¨ÙŠØ±', color: '#0000FF' },
      { level: 4, required_points: 600, title: 'Ù…Ø­ØªØ±Ù', color: '#FF00FF' },
      { level: 5, required_points: 1000, title: 'Ø£Ø³Ø·ÙˆØ±Ø©', color: '#FFD700' }
    ];
    
    for (const levelData of defaultLevels) {
      await client`
        INSERT INTO level_settings (level, required_points, title, color)
        VALUES (${levelData.level}, ${levelData.required_points}, ${levelData.title}, ${levelData.color})
      `;
    }
    console.log('âœ… ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª');
    
    // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„...');
    
    const tables = await client`
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      ORDER BY table_name
    `;
    
    console.log('ğŸ“‹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:');
    for (const table of tables) {
      console.log(`   - ${table.table_name}`);
    }
    
    await client.end();
    
    console.log('\nğŸ‰ ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    throw error;
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­
fixDatabaseIssues().catch(console.error);