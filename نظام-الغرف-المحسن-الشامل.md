# 🏠 نظام الغرف المحسن الشامل

## 📋 نظرة عامة

تم إعادة بناء نظام الغرف بشكل كامل وقوي مع إزالة جميع التكرارات وإضافة ميزات متقدمة. النظام الجديد يوفر:

- ✅ إدارة غرف متقدمة مع تصنيفات وعلامات
- ✅ نظام صلاحيات قوي ومتعدد المستويات
- ✅ غرف البث مع إدارة الميكروفون
- ✅ نظام استيراد وتصدير قاعدة البيانات
- ✅ فحص شامل لصحة قاعدة البيانات
- ✅ نظام نسخ احتياطي تلقائي
- ✅ Socket.IO محسن للاتصال المباشر
- ✅ ترحيب تلقائي للمستخدمين الجدد
- ✅ إحصائيات مفصلة ومتقدمة

## 🚀 الميزات الرئيسية

### 1. إدارة الغرف المتقدمة
- إنشاء غرف مع تصنيفات وعلامات
- غرف خاصة وعامة
- غرف البث مع إدارة الميكروفون
- حد أقصى للمستخدمين
- نظام صلاحيات متقدم

### 2. نظام المستخدمين والصلاحيات
- انضمام وخروج من الغرف
- صلاحيات مختلفة (مالك، مضيف، متحدث، عضو)
- إدارة الميكروفون في غرف البث
- ترحيب تلقائي في الغرفة العامة

### 3. نظام البث المباشر
- طلب الميكروفون
- الموافقة/رفض طلبات الميكروفون
- إزالة المتحدثين
- قائمة انتظار الميكروفون

### 4. استيراد وتصدير قاعدة البيانات
- تصدير كامل للبيانات
- استيراد البيانات مع خيارات متقدمة
- نسخ احتياطي تلقائي
- استعادة من النسخ الاحتياطية

### 5. فحص صحة قاعدة البيانات
- فحص شامل لجميع الجداول
- اكتشاف البيانات اليتيمة
- إصلاح تلقائي للمشاكل
- تنظيف البيانات القديمة

## 📁 هيكل الملفات

```
server/
├── services/
│   ├── EnhancedRoomService.ts          # خدمة الغرف المحسنة
│   ├── EnhancedSocketService.ts        # خدمة Socket.IO المحسنة
│   ├── DatabaseExportImportService.ts  # خدمة الاستيراد/التصدير
│   └── DatabaseHealthCheckService.ts   # خدمة فحص صحة قاعدة البيانات
├── routes/
│   └── EnhancedRoomRoutes.ts           # راوتر الغرف المحسن
├── EnhancedRoomSystem.ts               # النظام الرئيسي للغرف
└── index.ts                            # نقطة البداية مع التكامل
```

## 🔧 التثبيت والإعداد

### 1. تحديث قاعدة البيانات
```bash
# تأكد من وجود الجداول المطلوبة
npm run db:migrate
```

### 2. تشغيل النظام
```bash
npm run dev
```

### 3. تهيئة النظام
النظام يتم تهيئته تلقائياً عند بدء التشغيل:
- إنشاء الغرفة العامة
- فحص صحة قاعدة البيانات
- إعداد النسخ الاحتياطي التلقائي
- إعداد مهام التنظيف

## 📡 API Endpoints

### إدارة الغرف

#### الحصول على جميع الغرف
```http
GET /api/enhanced-rooms
```

**Query Parameters:**
- `includeInactive` - تضمين الغرف غير النشطة
- `category` - تصنيف الغرف
- `isBroadcast` - غرف البث فقط
- `isPrivate` - الغرف الخاصة فقط
- `search` - البحث في الغرف
- `sortBy` - ترتيب حسب (createdAt, name, userCount)
- `sortOrder` - اتجاه الترتيب (asc, desc)
- `limit` - عدد النتائج (افتراضي: 50)
- `offset` - إزاحة النتائج (افتراضي: 0)

#### إنشاء غرفة جديدة
```http
POST /api/enhanced-rooms
```

**Body:**
```json
{
  "id": "room-id",
  "name": "اسم الغرفة",
  "description": "وصف الغرفة",
  "icon": "رابط الأيقونة",
  "isBroadcast": false,
  "isPrivate": false,
  "maxUsers": 100,
  "category": "عام",
  "tags": ["دردشة", "عام"]
}
```

#### تحديث غرفة
```http
PUT /api/enhanced-rooms/:roomId
```

#### حذف غرفة
```http
DELETE /api/enhanced-rooms/:roomId
```

### انضمام وخروج الغرف

#### الانضمام لغرفة
```http
POST /api/enhanced-rooms/:roomId/join
```

#### الخروج من غرفة
```http
POST /api/enhanced-rooms/:roomId/leave
```

### غرف البث

#### طلب الميكروفون
```http
POST /api/enhanced-rooms/:roomId/mic/request
```

#### الموافقة على طلب الميكروفون
```http
POST /api/enhanced-rooms/:roomId/mic/approve
```

**Body:**
```json
{
  "userId": 123
}
```

#### رفض طلب الميكروفون
```http
POST /api/enhanced-rooms/:roomId/mic/reject
```

#### إزالة متحدث
```http
POST /api/enhanced-rooms/:roomId/speakers/remove
```

### البحث والتصفية

#### البحث في الغرف
```http
GET /api/enhanced-rooms/search?q=كلمة البحث
```

#### الغرف الشائعة
```http
GET /api/enhanced-rooms/popular?limit=10
```

#### تصنيفات الغرف
```http
GET /api/enhanced-rooms/categories
```

### إدارة المستخدمين

#### غرف المستخدم
```http
GET /api/enhanced-rooms/user/my-rooms
```

#### الغرف التي أنشأها المستخدم
```http
GET /api/enhanced-rooms/user/created-rooms
```

### الإحصائيات

#### إحصائيات الغرفة
```http
GET /api/enhanced-rooms/:roomId/stats
```

#### مستخدمو الغرفة
```http
GET /api/enhanced-rooms/:roomId/users?onlineOnly=true
```

#### رسائل الغرفة
```http
GET /api/enhanced-rooms/:roomId/messages?limit=50&offset=0
```

## 🔧 إدارة النظام (للمشرفين)

### فحص صحة قاعدة البيانات
```http
GET /api/enhanced-rooms/admin/health
```

### إصلاح البيانات اليتيمة
```http
POST /api/enhanced-rooms/admin/fix-orphaned
```

**Body:**
```json
{
  "fixRoomUsers": true,
  "fixMessages": true
}
```

### تنظيف البيانات القديمة
```http
POST /api/enhanced-rooms/admin/cleanup
```

**Body:**
```json
{
  "deleteOldMessages": true,
  "deleteOldNotifications": true,
  "messageAgeDays": 30,
  "notificationAgeDays": 7
}
```

### النسخ الاحتياطي

#### إنشاء نسخة احتياطية
```http
POST /api/enhanced-rooms/admin/backup
```

**Body:**
```json
{
  "includeUsers": true,
  "includeMessages": true,
  "includeNotifications": true,
  "includeRoomUsers": true,
  "compressBackup": false
}
```

#### قائمة النسخ الاحتياطية
```http
GET /api/enhanced-rooms/admin/backups
```

#### استعادة نسخة احتياطية
```http
POST /api/enhanced-rooms/admin/restore
```

**Body:**
```json
{
  "backupPath": "./backups/backup-2024-01-01.json",
  "options": {
    "overwriteExisting": false,
    "skipUsers": false,
    "skipMessages": false
  }
}
```

#### حذف نسخة احتياطية
```http
DELETE /api/enhanced-rooms/admin/backup/:filename
```

#### إحصائيات قاعدة البيانات
```http
GET /api/enhanced-rooms/admin/stats
```

## 🔌 Socket.IO Events

### المصادقة
```javascript
// مصادقة المستخدم
socket.emit('authenticate', { token: 'user-jwt-token' });

// استقبال تأكيد المصادقة
socket.on('authenticated', (data) => {
  console.log('تمت المصادقة:', data.user);
});
```

### إدارة الغرف
```javascript
// الانضمام لغرفة
socket.emit('joinRoom', { roomId: 'general' });

// الخروج من غرفة
socket.emit('leaveRoom', { roomId: 'general' });

// تبديل الغرف
socket.emit('switchRoom', { roomId: 'new-room' });

// استقبال تأكيد الانضمام
socket.on('roomJoined', (data) => {
  console.log('انضممت للغرفة:', data.room);
});
```

### الرسائل
```javascript
// إرسال رسالة
socket.emit('sendMessage', {
  content: 'مرحباً بالجميع!',
  roomId: 'general',
  messageType: 'text'
});

// استقبال رسالة جديدة
socket.on('newMessage', (data) => {
  console.log('رسالة جديدة:', data.message);
});
```

### مؤشر الكتابة
```javascript
// بدء الكتابة
socket.emit('typing', { roomId: 'general' });

// إيقاف الكتابة
socket.emit('stopTyping', { roomId: 'general' });

// استقبال مؤشر الكتابة
socket.on('userTyping', (data) => {
  console.log(`${data.username} يكتب...`);
});
```

### غرف البث
```javascript
// طلب الميكروفون
socket.emit('requestMic', { roomId: 'broadcast-room' });

// الموافقة على طلب الميكروفون
socket.emit('approveMic', { roomId: 'broadcast-room', userId: 123 });

// رفض طلب الميكروفون
socket.emit('rejectMic', { roomId: 'broadcast-room', userId: 123 });

// إزالة متحدث
socket.emit('removeSpeaker', { roomId: 'broadcast-room', userId: 123 });
```

### إدارة الغرف
```javascript
// إنشاء غرفة
socket.emit('createRoom', {
  id: 'new-room',
  name: 'غرفة جديدة',
  description: 'وصف الغرفة',
  isBroadcast: false,
  isPrivate: false
});

// تحديث غرفة
socket.emit('updateRoom', {
  roomId: 'room-id',
  updates: { name: 'اسم جديد' }
});

// حذف غرفة
socket.emit('deleteRoom', { roomId: 'room-id' });
```

### تحديثات الحالة
```javascript
// تحديث الحالة
socket.emit('updateStatus', { status: 'متاح' });

// تحديث الملف الشخصي
socket.emit('updateProfile', {
  username: 'اسم جديد',
  bio: 'نبذة جديدة'
});
```

## 🛠️ إدارة النظام

### التهيئة التلقائية
النظام يقوم تلقائياً بـ:
- إنشاء الغرفة العامة إذا لم تكن موجودة
- فحص صحة قاعدة البيانات عند بدء التشغيل
- إعداد النسخ الاحتياطي التلقائي (كل 24 ساعة)
- تنظيف البيانات القديمة (كل 7 أيام)
- فحص صحة النظام (كل 6 ساعات)

### مراقبة النظام
```javascript
// الحصول على حالة النظام
const systemStatus = enhancedRoomSystem.getSystemStatus();
console.log('حالة النظام:', systemStatus);

// فحص صحة النظام
const healthCheck = await enhancedRoomSystem.performHealthCheck();
console.log('نتيجة الفحص:', healthCheck.overall);
```

### إيقاف النظام
```javascript
// إيقاف النظام بشكل آمن
await enhancedRoomSystem.shutdown();
```

## 🔒 الأمان والصلاحيات

### مستويات الصلاحيات
1. **مالك الغرفة (Owner)**
   - تحرير الغرفة
   - حذف الغرفة
   - إدارة المستخدمين
   - إدارة الميكروفون

2. **مضيف الغرفة (Host)**
   - تحرير الغرفة
   - إدارة المستخدمين
   - إدارة الميكروفون

3. **متحدث (Speaker)**
   - التحدث في غرف البث

4. **عضو (Member)**
   - الانضمام للغرف
   - إرسال الرسائل
   - طلب الميكروفون

5. **مشرف (Admin/Owner)**
   - جميع الصلاحيات
   - إدارة النظام
   - الوصول لجميع الغرف

### التحقق من الصلاحيات
```javascript
// التحقق من صلاحيات المستخدم في غرفة
const permissions = await enhancedRoomSystem.getRoomPermissions(userId, roomId);
console.log('الصلاحيات:', permissions);
```

## 📊 الإحصائيات والتقارير

### إحصائيات الغرفة
```javascript
const roomStats = await enhancedRoomService.getRoomStats(roomId);
console.log('إحصائيات الغرفة:', roomStats);
```

### إحصائيات قاعدة البيانات
```javascript
const dbStats = await enhancedRoomSystem.getDatabaseStats();
console.log('إحصائيات قاعدة البيانات:', dbStats);
```

## 🚨 استكشاف الأخطاء

### مشاكل شائعة وحلولها

#### 1. خطأ في الاتصال بقاعدة البيانات
```bash
# فحص الاتصال
npm run db:check

# إعادة تشغيل قاعدة البيانات
npm run db:restart
```

#### 2. مشاكل في الغرف
```bash
# فحص صحة الغرف
curl -X GET "http://localhost:5000/api/enhanced-rooms/admin/health"

# إصلاح البيانات اليتيمة
curl -X POST "http://localhost:5000/api/enhanced-rooms/admin/fix-orphaned" \
  -H "Content-Type: application/json" \
  -d '{"fixRoomUsers": true, "fixMessages": true}'
```

#### 3. مشاكل في Socket.IO
```javascript
// فحص الاتصال
socket.on('connect', () => {
  console.log('متصل بـ Socket.IO');
});

socket.on('disconnect', (reason) => {
  console.log('انقطع الاتصال:', reason);
});

socket.on('error', (error) => {
  console.error('خطأ في Socket.IO:', error);
});
```

#### 4. مشاكل في الأداء
```bash
# تنظيف البيانات القديمة
curl -X POST "http://localhost:5000/api/enhanced-rooms/admin/cleanup" \
  -H "Content-Type: application/json" \
  -d '{"deleteOldMessages": true, "messageAgeDays": 30}'
```

## 📝 السجلات والتتبع

### سجلات النظام
النظام يسجل جميع العمليات المهمة:
- إنشاء/تحديث/حذف الغرف
- انضمام/خروج المستخدمين
- طلبات الميكروفون
- أخطاء النظام
- عمليات النسخ الاحتياطي

### مراقبة الأداء
```javascript
// مراقبة استخدام الذاكرة
const memUsage = process.memoryUsage();
console.log('استخدام الذاكرة:', memUsage);

// مراقبة عدد الاتصالات
const onlineUsers = enhancedRoomSystem.getOnlineUsers().length;
console.log('المستخدمون المتصلون:', onlineUsers);
```

## 🔄 التحديثات والصيانة

### التحديثات التلقائية
النظام يدعم التحديثات التلقائية:
- فحص التحديثات عند بدء التشغيل
- تنزيل وتطبيق التحديثات
- النسخ الاحتياطي قبل التحديث
- استعادة النظام في حالة الفشل

### الصيانة الدورية
```bash
# فحص صحة النظام
npm run health:check

# تنظيف البيانات
npm run cleanup

# إنشاء نسخة احتياطية
npm run backup

# تحديث النظام
npm run update
```

## 📞 الدعم والمساعدة

### التوثيق الإضافي
- [دليل المطور](developer-guide.md)
- [دليل API](api-reference.md)
- [أمثلة الاستخدام](examples.md)
- [استكشاف الأخطاء](troubleshooting.md)

### الاتصال بالدعم
- 📧 البريد الإلكتروني: support@example.com
- 💬 الدردشة المباشرة: [رابط الدردشة]
- 📞 الهاتف: +1234567890

---

## 🎉 الخلاصة

النظام المحسن للغرف يوفر حلاً شاملاً وقوياً لإدارة الغرف مع:

✅ **أداء عالي** - نظام محسن للسرعة والكفاءة  
✅ **أمان قوي** - نظام صلاحيات متقدم  
✅ **سهولة الاستخدام** - واجهة بسيطة وواضحة  
✅ **قابلية التوسع** - يدعم عدد كبير من المستخدمين  
✅ **مراقبة شاملة** - أدوات مراقبة وإدارة متقدمة  
✅ **نسخ احتياطي** - نظام نسخ احتياطي تلقائي  
✅ **دعم فني** - دعم شامل ومستمر  

النظام جاهز للاستخدام في الإنتاج ويدعم جميع المتطلبات الحديثة لتطبيقات الدردشة والاجتماعات.