const TelegramBot = require('node-telegram-bot-api');
const fs = require('fs');
const path = require('path');

// ุฅุนุฏุงุฏุงุช ุงูุจูุช
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || 'YOUR_BOT_TOKEN_HERE';
const OWNER_ID = process.env.OWNER_TELEGRAM_ID || 'YOUR_OWNER_ID_HERE'; // ูุนุฑู ุงููุงูู ูู ุชููุฌุฑุงู

// ููู ูุญูุธ ุฌูุณุงุช ุงููุญุงุฏุซุงุช
const SESSIONS_FILE = path.join(__dirname, 'telegram-sessions.json');

class TelegramMessageBot {
  constructor() {
    this.bot = new TelegramBot(BOT_TOKEN, { polling: true });
    this.sessions = this.loadSessions();
    this.setupEventHandlers();
    console.log('๐ค ุจูุช ุชููุฌุฑุงู ููุฑุณุงุฆู ูุนูู ุงูุขู...');
  }

  // ุชุญููู ุฌูุณุงุช ุงููุญุงุฏุซุงุช ูู ุงูููู
  loadSessions() {
    try {
      if (fs.existsSync(SESSIONS_FILE)) {
        const data = fs.readFileSync(SESSIONS_FILE, 'utf8');
        return JSON.parse(data);
      }
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุชุญููู ุงูุฌูุณุงุช:', error);
    }
    return {};
  }

  // ุญูุธ ุฌูุณุงุช ุงููุญุงุฏุซุงุช ุฅูู ุงูููู
  saveSessions() {
    try {
      fs.writeFileSync(SESSIONS_FILE, JSON.stringify(this.sessions, null, 2));
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุญูุธ ุงูุฌูุณุงุช:', error);
    }
  }

  // ุฅุนุฏุงุฏ ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ
  setupEventHandlers() {
    // ูุนุงูุฌ ุงูุฑุณุงุฆู ุงููุตูุฉ
    this.bot.on('message', (msg) => {
      this.handleMessage(msg);
    });

    // ูุนุงูุฌ ุงูุฃุฎุทุงุก
    this.bot.on('error', (error) => {
      console.error('ุฎุทุฃ ูู ุงูุจูุช:', error);
    });

    // ูุนุงูุฌ ุจุฏุก ุงููุญุงุฏุซุฉ
    this.bot.onText(/\/start/, (msg) => {
      this.handleStart(msg);
    });

    // ูุนุงูุฌ ุงููุณุงุนุฏุฉ
    this.bot.onText(/\/help/, (msg) => {
      this.handleHelp(msg);
    });

    // ูุนุงูุฌ ุฅููุงุก ุงููุญุงุฏุซุฉ (ูููุงูู ููุท)
    this.bot.onText(/\/end (.+)/, (msg, match) => {
      if (msg.from.id.toString() === OWNER_ID) {
        this.handleEndSession(msg, match[1]);
      }
    });

    // ูุนุงูุฌ ุนุฑุถ ุงููุญุงุฏุซุงุช ุงููุดุทุฉ (ูููุงูู ููุท)
    this.bot.onText(/\/sessions/, (msg) => {
      if (msg.from.id.toString() === OWNER_ID) {
        this.handleShowSessions(msg);
      }
    });
  }

  // ูุนุงูุฌ ุจุฏุก ุงููุญุงุฏุซุฉ
  async handleStart(msg) {
    const chatId = msg.chat.id;
    const userId = msg.from.id.toString();
    const userName = msg.from.first_name || msg.from.username || 'ูุฌููู';

    if (userId === OWNER_ID) {
      await this.bot.sendMessage(chatId, `
๐ง **ููุญุฉ ุชุญูู ุงููุงูู**

ุฃููุงู ุจู! ุฃูุช ุงููุงูู ูููููู:
โข ุงุณุชูุจุงู ุฌููุน ุงูุฑุณุงุฆู ูู ุงููุณุชุฎุฏููู
โข ุงูุฑุฏ ุนูู ุฃู ูุณุชุฎุฏู ุจูุชุงุจุฉ ุฑุณุงูุชู ูุจุงุดุฑุฉ
โข ุงุณุชุฎุฏุงู /sessions ูุนุฑุถ ุงููุญุงุฏุซุงุช ุงููุดุทุฉ
โข ุงุณุชุฎุฏุงู /end [user_id] ูุฅููุงุก ูุญุงุฏุซุฉ ูุนููุฉ

ุงูุจูุช ุฌุงูุฒ ูุงุณุชูุจุงู ุงูุฑุณุงุฆู! ๐
      `, { parse_mode: 'Markdown' });
    } else {
      // ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ ูููุณุชุฎุฏู
      this.sessions[userId] = {
        user_id: userId,
        user_name: userName,
        chat_id: chatId,
        started_at: new Date().toISOString(),
        last_message: new Date().toISOString(),
        message_count: 0
      };
      this.saveSessions();

      // ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฑุญูุจ ูููุณุชุฎุฏู
      await this.bot.sendMessage(chatId, `
๐ค **ุฃููุงู ูุณููุงู ${userName}!**

ูุฑุญุจุงู ุจู! ููููู ุงูุขู ุฅุฑุณุงู ุฑุณุงุฆูู ูุณุฃููู ุจุชูุตูููุง ูููุงูู.
ุณูุชู ุงูุฑุฏ ุนููู ูู ุฎูุงูู ุจุฃุณุฑุน ููุช ูููู.

ุงูุชุจ ุฑุณุงูุชู ุงูุขู... โ๏ธ
      `);

      // ุฅุดุนุงุฑ ุงููุงูู ุจูุณุชุฎุฏู ุฌุฏูุฏ
      await this.bot.sendMessage(OWNER_ID, `
๐ **ูุณุชุฎุฏู ุฌุฏูุฏ ุจุฏุฃ ูุญุงุฏุซุฉ**

๐ค **ุงููุณุชุฎุฏู:** ${userName}
๐ **ุงููุนุฑู:** ${userId}
โฐ **ุงูููุช:** ${new Date().toLocaleString('ar-EG')}

ุงูุชุธุฑ ุฑุณุงูุชู ุงูุฃููู...
      `, { parse_mode: 'Markdown' });
    }
  }

  // ูุนุงูุฌ ุงููุณุงุนุฏุฉ
  async handleHelp(msg) {
    const chatId = msg.chat.id;
    const userId = msg.from.id.toString();

    if (userId === OWNER_ID) {
      await this.bot.sendMessage(chatId, `
๐ง **ูุณุงุนุฏุฉ ุงููุงูู**

**ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:**
โข /start - ุจุฏุก ุงูุจูุช
โข /help - ุนุฑุถ ูุฐู ุงููุณุงุนุฏุฉ
โข /sessions - ุนุฑุถ ุงููุญุงุฏุซุงุช ุงููุดุทุฉ
โข /end [user_id] - ุฅููุงุก ูุญุงุฏุซุฉ ูุนููุฉ

**ููููุฉ ุงูุงุณุชุฎุฏุงู:**
1. ุงุณุชูุจู ุงูุฑุณุงุฆู ูู ุงููุณุชุฎุฏููู
2. ุงูุชุจ ุฑุฏู ูุจุงุดุฑุฉ (ุณูุตู ูููุณุชุฎุฏู ุงูุฃุฎูุฑ)
3. ุฃู ุฑุฏ ุนูู ุฑุณุงูุฉ ูุนููุฉ ูุฅุฑุณุงููุง ูุตุงุญุจูุง

**ููุงุญุธุงุช:**
โข ุฌููุน ุงูุฑุณุงุฆู ูุญููุธุฉ ูู ุฌูุณุงุช
โข ููููู ูุชุงุจุนุฉ ุนุฏุฉ ูุญุงุฏุซุงุช ูู ููุณ ุงูููุช
      `);
    } else {
      await this.bot.sendMessage(chatId, `
๐ค **ููููุฉ ุงูุงุณุชุฎุฏุงู**

**ูุฑุญุจุงู! ููููู:**
โข ุฅุฑุณุงู ุฃู ุฑุณุงูุฉ ูุตูุฉ
โข ุฅุฑุณุงู ุงูุตูุฑ ูุงููููุงุช
โข ุทุฑุญ ุงูุฃุณุฆูุฉ ูุงูุงุณุชูุณุงุฑุงุช

**ููุงุญุธุงุช:**
โข ุฌููุน ุฑุณุงุฆูู ุณุชุตู ูููุงูู
โข ุณูุชู ุงูุฑุฏ ุนููู ุจุฃุณุฑุน ููุช
โข ุงููุญุงุฏุซุฉ ุขููุฉ ููุดูุฑุฉ

ุงูุชุจ ุฑุณุงูุชู ุงูุขู... โ๏ธ
      `);
    }
  }

  // ูุนุงูุฌ ุงูุฑุณุงุฆู ุงูุฑุฆูุณู
  async handleMessage(msg) {
    // ุชุฌุงูู ุงูุฃูุงูุฑ
    if (msg.text && msg.text.startsWith('/')) {
      return;
    }

    const userId = msg.from.id.toString();
    const chatId = msg.chat.id;
    const userName = msg.from.first_name || msg.from.username || 'ูุฌููู';

    if (userId === OWNER_ID) {
      // ุฑุณุงูุฉ ูู ุงููุงูู - ุฅุฑุณุงููุง ูููุณุชุฎุฏู ุงูููุงุณุจ
      await this.handleOwnerMessage(msg);
    } else {
      // ุฑุณุงูุฉ ูู ูุณุชุฎุฏู ุนุงุฏู - ุฅุฑุณุงููุง ูููุงูู
      await this.handleUserMessage(msg);
    }
  }

  // ูุนุงูุฌ ุฑุณุงุฆู ุงููุณุชุฎุฏููู ุงูุนุงุฏููู
  async handleUserMessage(msg) {
    const userId = msg.from.id.toString();
    const chatId = msg.chat.id;
    const userName = msg.from.first_name || msg.from.username || 'ูุฌููู';

    // ุฅูุดุงุก ุฃู ุชุญุฏูุซ ุงูุฌูุณุฉ
    if (!this.sessions[userId]) {
      this.sessions[userId] = {
        user_id: userId,
        user_name: userName,
        chat_id: chatId,
        started_at: new Date().toISOString(),
        last_message: new Date().toISOString(),
        message_count: 0
      };
    }

    // ุชุญุฏูุซ ุงูุฌูุณุฉ
    this.sessions[userId].last_message = new Date().toISOString();
    this.sessions[userId].message_count++;
    this.saveSessions();

    // ุชุญุถูุฑ ุงูุฑุณุงูุฉ ูููุงูู
    let forwardMessage = `
๐จ **ุฑุณุงูุฉ ูู ${userName}**
๐ **ุงููุนุฑู:** ${userId}
โฐ **ุงูููุช:** ${new Date().toLocaleString('ar-EG')}
๐ **ุนุฏุฏ ุงูุฑุณุงุฆู:** ${this.sessions[userId].message_count}

๐ฌ **ุงููุญุชูู:**
${msg.text || '[ูุญุชูู ุบูุฑ ูุตู]'}
    `;

    // ุฅุฑุณุงู ุงูุฑุณุงูุฉ ูููุงูู
    try {
      await this.bot.sendMessage(OWNER_ID, forwardMessage, { parse_mode: 'Markdown' });

      // ุฅุฐุง ูุงูุช ุงูุฑุณุงูุฉ ุชุญุชูู ุนูู ูุณุงุฆุทุ ุฃุฑุณููุง ุฃูุถุงู
      if (msg.photo) {
        await this.bot.sendPhoto(OWNER_ID, msg.photo[msg.photo.length - 1].file_id, {
          caption: `ุตูุฑุฉ ูู ${userName} (${userId})`
        });
      } else if (msg.document) {
        await this.bot.sendDocument(OWNER_ID, msg.document.file_id, {
          caption: `ููู ูู ${userName} (${userId})`
        });
      } else if (msg.voice) {
        await this.bot.sendVoice(OWNER_ID, msg.voice.file_id, {
          caption: `ุฑุณุงูุฉ ุตูุชูุฉ ูู ${userName} (${userId})`
        });
      }

      // ุชุฃููุฏ ุงูุงุณุชูุงู ูููุณุชุฎุฏู
      await this.bot.sendMessage(msg.chat.id, 'โ ุชู ุฅุฑุณุงู ุฑุณุงูุชู ุจูุฌุงุญ! ุณูุชู ุงูุฑุฏ ุนููู ูุฑูุจุงู.');

    } catch (error) {
      console.error('ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ูููุงูู:', error);
      await this.bot.sendMessage(msg.chat.id, 'โ ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ุฅุฑุณุงู ุฑุณุงูุชู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.');
    }
  }

  // ูุนุงูุฌ ุฑุณุงุฆู ุงููุงูู
  async handleOwnerMessage(msg) {
    // ุงูุจุญุซ ุนู ุขุฎุฑ ูุณุชุฎุฏู ุชูุงุนู ูุนู ุงููุงูู
    const lastUser = this.getLastActiveUser();

    if (!lastUser) {
      await this.bot.sendMessage(msg.chat.id, 'โ ูุง ุชูุฌุฏ ูุญุงุฏุซุงุช ูุดุทุฉ ุญุงููุงู.');
      return;
    }

    // ุฅุฑุณุงู ุฑุณุงูุฉ ุงููุงูู ูููุณุชุฎุฏู
    try {
      let replyMessage = `๐ค **ุฑุฏ ูู ุงูุฏุนู:**\n\n${msg.text}`;

      await this.bot.sendMessage(lastUser.chat_id, replyMessage, { parse_mode: 'Markdown' });

      // ุฅุฐุง ูุงูุช ุงูุฑุณุงูุฉ ุชุญุชูู ุนูู ูุณุงุฆุทุ ุฃุฑุณููุง ุฃูุถุงู
      if (msg.photo) {
        await this.bot.sendPhoto(lastUser.chat_id, msg.photo[msg.photo.length - 1].file_id);
      } else if (msg.document) {
        await this.bot.sendDocument(lastUser.chat_id, msg.document.file_id);
      } else if (msg.voice) {
        await this.bot.sendVoice(lastUser.chat_id, msg.voice.file_id);
      }

      // ุชุฃููุฏ ุงูุฅุฑุณุงู ูููุงูู
      await this.bot.sendMessage(msg.chat.id, `โ ุชู ุฅุฑุณุงู ุฑุฏู ุฅูู ${lastUser.user_name} (${lastUser.user_id})`);

    } catch (error) {
      console.error('ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฑุฏ ูููุณุชุฎุฏู:', error);
      await this.bot.sendMessage(msg.chat.id, `โ ูุดู ูู ุฅุฑุณุงู ุงูุฑุฏ ุฅูู ${lastUser.user_name}. ูุฏ ูููู ูุงู ุจุญุธุฑ ุงูุจูุช.`);
    }
  }

  // ุงูุญุตูู ุนูู ุขุฎุฑ ูุณุชุฎุฏู ูุดุท
  getLastActiveUser() {
    const users = Object.values(this.sessions);
    if (users.length === 0) return null;

    // ุชุฑุชูุจ ุงููุณุชุฎุฏููู ุญุณุจ ุขุฎุฑ ุฑุณุงูุฉ
    users.sort((a, b) => new Date(b.last_message) - new Date(a.last_message));
    return users[0];
  }

  // ุนุฑุถ ุงููุญุงุฏุซุงุช ุงููุดุทุฉ
  async handleShowSessions(msg) {
    const users = Object.values(this.sessions);
    
    if (users.length === 0) {
      await this.bot.sendMessage(msg.chat.id, '๐ญ ูุง ุชูุฌุฏ ูุญุงุฏุซุงุช ูุดุทุฉ ุญุงููุงู.');
      return;
    }

    let sessionsList = '๐ **ุงููุญุงุฏุซุงุช ุงููุดุทุฉ:**\n\n';
    
    users.forEach((user, index) => {
      const lastMessageTime = new Date(user.last_message).toLocaleString('ar-EG');
      sessionsList += `${index + 1}. **${user.user_name}**\n`;
      sessionsList += `   ๐ ${user.user_id}\n`;
      sessionsList += `   ๐ ${user.message_count} ุฑุณุงูุฉ\n`;
      sessionsList += `   โฐ ุขุฎุฑ ุฑุณุงูุฉ: ${lastMessageTime}\n\n`;
    });

    sessionsList += '\n๐ก **ููุฑุฏ ุนูู ูุณุชุฎุฏู ูุนูู:** ุงูุชุจ ุฑุณุงูุชู ูุจุงุดุฑุฉ (ุณูุชู ุฅุฑุณุงููุง ูููุณุชุฎุฏู ุงูุฃุฎูุฑ)';

    await this.bot.sendMessage(msg.chat.id, sessionsList, { parse_mode: 'Markdown' });
  }

  // ุฅููุงุก ุฌูุณุฉ ูุญุฏุฏุฉ
  async handleEndSession(msg, userId) {
    if (this.sessions[userId]) {
      const userName = this.sessions[userId].user_name;
      delete this.sessions[userId];
      this.saveSessions();
      
      await this.bot.sendMessage(msg.chat.id, `โ ุชู ุฅููุงุก ุงููุญุงุฏุซุฉ ูุน ${userName} (${userId})`);
      
      // ุฅุดุนุงุฑ ุงููุณุชุฎุฏู ุจุฅููุงุก ุงููุญุงุฏุซุฉ
      try {
        await this.bot.sendMessage(this.sessions[userId].chat_id, 
          '๐ ุชู ุฅููุงุก ุงููุญุงุฏุซุฉ. ุดูุฑุงู ูู! ููููู ุจุฏุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ ุจุฅุฑุณุงู /start'
        );
      } catch (error) {
        // ุชุฌุงูู ุงูุฎุทุฃ ุฅุฐุง ูู ูุชููู ูู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ูููุณุชุฎุฏู
      }
    } else {
      await this.bot.sendMessage(msg.chat.id, `โ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุญุงุฏุซุฉ ูููุณุชุฎุฏู ${userId}`);
    }
  }

  // ุชูุธูู ุงูุฌูุณุงุช ุงููุฏููุฉ (ูููู ุชุดุบูููุง ุฏูุฑูุงู)
  cleanOldSessions() {
    const now = new Date();
    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

    Object.keys(this.sessions).forEach(userId => {
      const lastMessage = new Date(this.sessions[userId].last_message);
      if (lastMessage < oneDayAgo) {
        delete this.sessions[userId];
      }
    });

    this.saveSessions();
  }
}

// ุจุฏุก ุงูุจูุช
const messageBot = new TelegramMessageBot();

// ุชูุธูู ุงูุฌูุณุงุช ุงููุฏููุฉ ูู 6 ุณุงุนุงุช
setInterval(() => {
  messageBot.cleanOldSessions();
}, 6 * 60 * 60 * 1000);

// ูุนุงูุฌ ุฅุบูุงู ุงูุชุทุจูู
process.on('SIGINT', () => {
  console.log('\n๐ ุฅููุงู ุงูุจูุช...');
  messageBot.saveSessions();
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('\n๐ ุฅููุงู ุงูุจูุช...');
  messageBot.saveSessions();
  process.exit(0);
});

module.exports = TelegramMessageBot;