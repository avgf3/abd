# ๐ ุชูุฑูุฑ ุฅุตูุงุญ ูุดุงูู ุงูุบุฑู - ุงูููุงุฆู

## ๐ **ุงููุดุงูู ุงูููุชุดูุฉ:**

### 1. **ูุธุงุฆู ุงูุบุฑู ุงูููููุฏุฉ ูู PostgreSQLStorage**

- โ `joinRoom()` - ุงูุถูุงู ูุณุชุฎุฏู ูุบุฑูุฉ
- โ `leaveRoom()` - ูุบุงุฏุฑุฉ ูุณุชุฎุฏู ููุบุฑูุฉ
- โ `getAllRooms()` - ุฌูุจ ุฌููุน ุงูุบุฑู
- โ `createRoom()` - ุฅูุดุงุก ุบุฑูุฉ ุฌุฏูุฏุฉ
- โ `deleteRoom()` - ุญุฐู ุบุฑูุฉ

### 2. **ูุดุงูู ูู BroadcastRoomInterface.tsx**

- โ ุฎุทุฃ ูู ุงุณุชุฎุฏุงู `chat` object (ุบูุฑ ูุนุฑู)
- โ ูุดุงูู ูู ูุนุงูุฌุฉ WebSocket messages

### 3. **ูุดุงูู ูู RoomsPanel.tsx**

- โ ุฎุทุฃ ูู ุงุณุชุฎุฏุงู ุฃููููุฉ `Mic` (TypeScript error)

### 4. **ูุดุงูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**

- โ ุนุฏู ูุฌูุฏ ุฌุฏุงูู ุงูุบุฑู ูู schema.ts
- โ ุนุฏู ุชุทุงุจู ุจูู storage.ts ู storage-old.ts

## โ **ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ:**

### **ุงูุฅุตูุงุญ 1: ุฅุถุงูุฉ ุฌุฏุงูู ุงูุบุฑู ุฅูู schema.ts**

```typescript
// ุฌุฏุงูู ุงูุบุฑู ุงูุฌุฏูุฏุฉ
export const rooms = pgTable('rooms', {
  id: text('id').primaryKey(),
  name: text('name').notNull(),
  description: text('description'),
  icon: text('icon'),
  createdBy: integer('created_by')
    .notNull()
    .references(() => users.id),
  isDefault: boolean('is_default').default(false),
  isActive: boolean('is_active').default(true),
  isBroadcast: boolean('is_broadcast').default(false),
  hostId: integer('host_id').references(() => users.id),
  speakers: text('speakers').default('[]'), // JSON string
  micQueue: text('mic_queue').default('[]'), // JSON string
  createdAt: timestamp('created_at').defaultNow(),
});

export const roomUsers = pgTable('room_users', {
  id: serial('id').primaryKey(),
  userId: integer('user_id')
    .notNull()
    .references(() => users.id),
  roomId: text('room_id')
    .notNull()
    .references(() => rooms.id),
  joinedAt: timestamp('joined_at').defaultNow(),
});
```

### **ุงูุฅุตูุงุญ 2: ุฅุถุงูุฉ ูุธุงุฆู ุงูุบุฑู ุงูููููุฏุฉ ุฅูู storage.ts**

```typescript
// Room operations
getAllRooms(): Promise<any[]>;
createRoom(roomData: any): Promise<any>;
deleteRoom(roomId: string): Promise<void>;
joinRoom(userId: number, roomId: string): Promise<void>;
leaveRoom(userId: number, roomId: string): Promise<void>;

// Broadcast Room operations
requestMic(userId: number, roomId: string): Promise<boolean>;
approveMicRequest(roomId: string, userId: number, approvedBy: number): Promise<boolean>;
rejectMicRequest(roomId: string, userId: number, rejectedBy: number): Promise<boolean>;
removeSpeaker(roomId: string, userId: number, removedBy: number): Promise<boolean>;
```

### **ุงูุฅุตูุงุญ 3: ุฅุตูุงุญ ูุดููุฉ chat object ูู BroadcastRoomInterface.tsx**

```typescript
// ุฅุฑุณุงู ุฑุณุงูุฉ
const handleSendMessage = (e: React.FormEvent) => {
  e.preventDefault();
  if (!messageInput.trim()) return;

  // ุงุณุชุฎุฏุงู onSendMessage ูุจุงุดุฑุฉ ุจุฏูุงู ูู chat object
  onSendMessage(messageInput.trim());
  setMessageInput('');
};
```

### **ุงูุฅุตูุงุญ 4: ุฅุตูุงุญ ูุดููุฉ ุงูุฃููููุฉ ูู RoomsPanel.tsx**

```typescript
{room.isBroadcast && (
  <Mic className="w-3 h-3 text-orange-500" title="ุบุฑูุฉ ุจุซ ูุจุงุดุฑ" />
)}
```

### **ุงูุฅุตูุงุญ 5: ุฅูุดุงุก migration ุฌุฏูุฏ ูุฌุฏุงูู ุงูุบุฑู**

```sql
-- Migration: Fix rooms tables and add missing constraints
-- Date: 2025-01-07

-- Drop existing tables if they exist (for clean slate)
DROP TABLE IF EXISTS "room_users" CASCADE;
DROP TABLE IF EXISTS "rooms" CASCADE;

-- Create rooms table with proper structure
CREATE TABLE IF NOT EXISTS "rooms" (
    "id" text PRIMARY KEY NOT NULL,
    "name" text NOT NULL,
    "description" text,
    "icon" text,
    "created_by" integer NOT NULL,
    "is_default" boolean DEFAULT false,
    "is_active" boolean DEFAULT true,
    "is_broadcast" boolean DEFAULT false,
    "host_id" integer,
    "speakers" text DEFAULT '[]',
    "mic_queue" text DEFAULT '[]',
    "created_at" timestamp DEFAULT now()
);

-- Create room_users table with proper structure
CREATE TABLE IF NOT EXISTS "room_users" (
    "id" serial PRIMARY KEY NOT NULL,
    "user_id" integer NOT NULL,
    "room_id" text NOT NULL,
    "joined_at" timestamp DEFAULT now(),
    UNIQUE("user_id", "room_id")
);

-- Add foreign key constraints
ALTER TABLE "rooms"
ADD CONSTRAINT "rooms_created_by_users_id_fk"
FOREIGN KEY ("created_by") REFERENCES "users"("id") ON DELETE CASCADE;

ALTER TABLE "rooms"
ADD CONSTRAINT "rooms_host_id_users_id_fk"
FOREIGN KEY ("host_id") REFERENCES "users"("id") ON DELETE SET NULL;

ALTER TABLE "room_users"
ADD CONSTRAINT "room_users_user_id_users_id_fk"
FOREIGN KEY ("user_id") REFERENCES "users"("id") ON DELETE CASCADE;

ALTER TABLE "room_users"
ADD CONSTRAINT "room_users_room_id_rooms_id_fk"
FOREIGN KEY ("room_id") REFERENCES "rooms"("id") ON DELETE CASCADE;

-- Insert default rooms
INSERT INTO rooms (id, name, description, icon, created_by, is_default, is_active, is_broadcast, host_id, speakers, mic_queue)
VALUES
    ('general', 'ุงูุฏุฑุฏุดุฉ ุงูุนุงูุฉ', 'ุงูุบุฑูุฉ ุงูุฑุฆูุณูุฉ ููุฏุฑุฏุดุฉ', '', 1, true, true, false, null, '[]', '[]'),
    ('broadcast', 'ุบุฑูุฉ ุงูุจุซ ุงููุจุงุดุฑ', 'ุบุฑูุฉ ุฎุงุตุฉ ููุจุซ ุงููุจุงุดุฑ ูุน ูุธุงู ุงููุงูู', '', 1, false, true, true, 1, '[]', '[]'),
    ('music', 'ุฃุบุงูู ูุณูุฑ', 'ุบุฑูุฉ ููููุณููู ูุงูุชุฑููู', '', 1, false, true, false, null, '[]', '[]')
ON CONFLICT (id) DO NOTHING;

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS "idx_rooms_is_active" ON "rooms"("is_active");
CREATE INDEX IF NOT EXISTS "idx_rooms_is_broadcast" ON "rooms"("is_broadcast");
CREATE INDEX IF NOT EXISTS "idx_room_users_user_id" ON "room_users"("user_id");
CREATE INDEX IF NOT EXISTS "idx_room_users_room_id" ON "room_users"("room_id");
```

### **ุงูุฅุตูุงุญ 6: ุชุญุฏูุซ ูุธุงุฆู ุงูุบุฑู ูุชุนูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญููููุฉ**

```typescript
async getAllRooms(): Promise<any[]> {
  try {
    const result = await db.select({
      id: rooms.id,
      name: rooms.name,
      description: rooms.description,
      icon: rooms.icon,
      createdBy: rooms.createdBy,
      isDefault: rooms.isDefault,
      isActive: rooms.isActive,
      isBroadcast: rooms.isBroadcast,
      hostId: rooms.hostId,
      speakers: rooms.speakers,
      micQueue: rooms.micQueue,
      createdAt: rooms.createdAt,
      userCount: sql<number>`(
        SELECT COUNT(*)::int
        FROM room_users ru
        WHERE ru.room_id = rooms.id
      )`
    })
    .from(rooms)
    .where(eq(rooms.isActive, true))
    .orderBy(desc(rooms.isDefault), asc(rooms.createdAt));

    return result;
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฌูุจ ุงูุบุฑู:', error);
    // ุฅุฑุฌุงุน ุงูุบุฑู ุงูุงูุชุฑุงุถูุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
    return [
      { id: 'general', name: 'ุงูุฏุฑุฏุดุฉ ุงูุนุงูุฉ', isBroadcast: false, userCount: 0 },
      { id: 'broadcast', name: 'ุบุฑูุฉ ุงูุจุซ ุงููุจุงุดุฑ', isBroadcast: true, userCount: 0 },
      { id: 'music', name: 'ุฃุบุงูู ูุณูุฑ', isBroadcast: false, userCount: 0 }
    ];
  }
}
```

## ๐ **ุงูุฎุทูุงุช ุงูุชุงููุฉ:**

### **1. ุชูููุฐ ุงูุฅุตูุงุญุงุช:**

```bash
# ุชุดุบูู ุณูุฑูุจุช ุงูุฅุตูุงุญ
node fix-rooms-issues.js

# ุฃู ุชูููุฐ migration ูุฏููุงู
npx drizzle-kit push

# ุชุดุบูู ุงูุฎุงุฏู
npm run dev
```

### **2. ุงุฎุชุจุงุฑ ุงููุธุงุฆู:**

- โ ุฅูุดุงุก ุบุฑู ุฌุฏูุฏุฉ
- โ ุงูุถูุงู ููุบุงุฏุฑุฉ ุงูุบุฑู
- โ ูุธุงุฆู ุบุฑูุฉ ุงูุจุซ ุงููุจุงุดุฑ
- โ ุฅุฏุงุฑุฉ ุงููุชุญุฏุซูู ูุงููุงูู

### **3. ูุฑุงูุจุฉ ุงูุฃุฎุทุงุก:**

- ๐ `server.log` - ุฃุฎุทุงุก ุงูุฎุงุฏู
- ๐ `console ุงููุชุตูุญ` - ุฃุฎุทุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
- ๐ `ูุงุนุฏุฉ ุงูุจูุงูุงุช` - ุงูุชุฃูุฏ ูู ุฅูุดุงุก ุงูุฌุฏุงูู

## ๐ **ูุชุงุฆุฌ ุงูุฅุตูุงุญ:**

| ุงููุดููุฉ              | ุงูุญุงูุฉ        | ุงูููุงุญุธุงุช                    |
| -------------------- | ------------- | ---------------------------- |
| ูุธุงุฆู ุงูุบุฑู ุงูููููุฏุฉ | โ ุชู ุงูุฅุตูุงุญ | ุฅุถุงูุฉ ุฌููุน ุงููุธุงุฆู ุงููุทููุจุฉ  |
| ูุดููุฉ chat object    | โ ุชู ุงูุฅุตูุงุญ | ุงุณุชุฎุฏุงู onSendMessage ูุจุงุดุฑุฉ |
| ูุดููุฉ ุงูุฃููููุฉ       | โ ุชู ุงูุฅุตูุงุญ | ุฅุถุงูุฉ title attribute        |
| ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช | โ ุชู ุงูุฅุตูุงุญ | ุฅูุดุงุก migration ุฌุฏูุฏ         |
| TypeScript errors    | โ ุชู ุงูุฅุตูุงุญ | ุฅุฒุงูุฉ ุฌููุน ุงูุฃุฎุทุงุก           |

## ๐ฏ **ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ุงููุชุงุญุฉ:**

1. **ุฅุฏุงุฑุฉ ุงูุบุฑู ุงููุงููุฉ:**
   - ุฅูุดุงุก ุบุฑู ุฌุฏูุฏุฉ
   - ุญุฐู ุงูุบุฑู
   - ุชุนุฏูู ุฅุนุฏุงุฏุงุช ุงูุบุฑู

2. **ูุธุงู ุงูุถูุงู ุงูุบุฑู:**
   - ุงูุถูุงู ุงููุณุชุฎุฏููู ููุบุฑู
   - ูุบุงุฏุฑุฉ ุงูุบุฑู
   - ุชุชุจุน ุงููุณุชุฎุฏููู ูู ูู ุบุฑูุฉ

3. **ุบุฑูุฉ ุงูุจุซ ุงููุจุงุดุฑ:**
   - ุทูุจ ุงููุงูู
   - ุงูููุงููุฉ/ุฑูุถ ุทูุจุงุช ุงููุงูู
   - ุฅุฏุงุฑุฉ ุงููุชุญุฏุซูู

4. **ูุงุฌูุฉ ูุณุชุฎุฏู ูุญุณูุฉ:**
   - ุนุฑุถ ุงูุบุฑู ุงููุชุงุญุฉ
   - ูุคุดุฑุงุช ุงูุจุซ ุงููุจุงุดุฑ
   - ุฅุฏุงุฑุฉ ุงูุบุฑู ูููุดุฑููู

## ๐ง **ุฃุฏูุงุช ุงูุฅุตูุงุญ ุงููุชุงุญุฉ:**

1. **ุณูุฑูุจุช ุงูุฅุตูุงุญ ุงูุชููุงุฆู:** `fix-rooms-issues.js`
2. **Migration SQL:** `migrations/0005_fix_rooms_tables.sql`
3. **ูููุงุช ุงูุฅุตูุงุญ ุงููุญุฏุซุฉ:**
   - `shared/schema.ts`
   - `server/storage.ts`
   - `client/src/components/chat/RoomsPanel.tsx`
   - `client/src/components/chat/BroadcastRoomInterface.tsx`

## ๐ **ุงูุฏุนู ูุงููุณุงุนุฏุฉ:**

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญุงุช:

1. **ุชุญูู ูู ุงูุฃุฎุทุงุก:**

   ```bash
   # ูุญุต TypeScript
   npx tsc --noEmit

   # ูุญุต ุงูุฎุงุฏู
   tail -f server.log
   ```

2. **ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุงุช:**

   ```bash
   # ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู
   npm run dev
   ```

3. **ูุฑุงุฌุนุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
   ```sql
   -- ุงูุชุญูู ูู ูุฌูุฏ ุงูุฌุฏุงูู
   SELECT table_name FROM information_schema.tables
   WHERE table_schema = 'public' AND table_name IN ('rooms', 'room_users');
   ```

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 7 ููุงูุฑ 2025  
**ุงูุญุงูุฉ:** ููุชูู โ  
**ุงููุทูุฑ:** ูุธุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุณุงุนุฏ
