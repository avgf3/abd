# ุชูุฑูุฑ ูุดุงูู ูุธุงู ุงูุชุงุฌุงุช - Tag System Issues Report

ุชุงุฑูุฎ ุงูุชุญููู: 2025-10-12

## ููุฎุต ุงููุดุงูู ุงูููุชุดูุฉ

ุชู ุงูุชุดุงู **9 ูุดุงูู ุฑุฆูุณูุฉ** ูู ูุธุงู ุงูุชุงุฌุงุช ุชุญุชุงุฌ ุฅูู ุฅุตูุงุญ:

---

## ุงููุดููุฉ 1: ุนุฏู ุชุทุงุจู ุนุฏุฏ ุงูุชูุฌุงู ุงููุฏุนููุฉ

**ุงููููุน:** `client/src/config/tagLayouts.ts` ู `client/src/components/chat/ProfileImage.tsx`

**ุงููุตู:**
- ููู `tagLayouts.ts` ูุญุชูู ุนูู ุฅุนุฏุงุฏุงุช ูู 12 ุชุงุฌ ููุท (TAG_LAYOUTS[1] ุฅูู TAG_LAYOUTS[12])
- ููู ูู `ProfileImage.tsx` ุงูุณุทุฑ 72ุ ุงูููุฏ ูุณูุญ ุจู 50 ุชุงุฌ:
  ```typescript
  const n = Math.max(1, Math.min(50, parseInt(m[1])));
  ```
- ูุฐุง ูุนูู ุงูุชูุฌุงู ูู 13 ุฅูู 50 ุณุชุณุชุฎุฏู DEFAULT_TAG_LAYOUT ููุฏ ูุง ุชุธูุฑ ุจุดูู ุตุญูุญ

**ุงูุชุฃุซูุฑ:** ุงูุชูุฌุงู ููู ุฑูู 12 ูุฏ ุชุธูุฑ ุจุดูู ุบูุฑ ุตุญูุญ ุฃู ุจููุงุถุน ุฎุงุทุฆุฉ

---

## ุงููุดููุฉ 2: ูููุงุช ุงูุชูุฌุงู ุงูููููุฏุฉ

**ุงููููุน:** `client/public/tags/`

**ุงููุตู:**
- ุงููุฌูุฏ ูุญุชูู ููุท ุนูู 12 ููู webp (tag1.webp ุฅูู tag12.webp)
- ุงูููุฏ ูุฏุนู ุญุชู tag50.webp ููู ุงููููุงุช ุบูุฑ ููุฌูุฏุฉ
- ูุง ููุฌุฏ ูุนุงูุฌุฉ ููุฃุฎุทุงุก ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ุชุงุฌ ุบูุฑ ููุฌูุฏ

**ุงูุชุฃุซูุฑ:** ูุญุงููุฉ ุงุณุชุฎุฏุงู ุชุงุฌ > 12 ุณุชุคุฏู ุฅูู ุตูุฑ ููุณูุฑุฉ

---

## ุงููุดููุฉ 3: ููู ุงูุงุฎุชุจุงุฑ ุบูุฑ ูุชุฒุงูู ูุน ุงูููุฏ ุงููุนูู

**ุงููููุน:** `client/public/test-tags.html`

**ุงููุตู:**
ููู test-tags.html ูุง ูุณุชุฎุฏู ููุณ ุงูููุทู ุงูููุฌูุฏ ูู ProfileImage.tsx:
- ููููุฏ: `autoAnchor` (ุงูุณุทุฑ 14 ูู tagLayouts.ts)
- ููููุฏ: `anchorY` ูุฌููุน ุงูุชูุฌุงู
- ูุณุชุฎุฏู ุชูููู ูุจุณุท `{w,x,y}` ุจุฏูุงู ูู `{widthRatio, xAdjustPx, yAdjustPx, anchorY, autoAnchor}`

**ุงูุชุฃุซูุฑ:** ุงูุงุฎุชุจุงุฑ ูุง ูุนูุณ ุงูุดูู ุงูุญูููู ููุชูุฌุงู ูู ุงูุชุทุจูู

---

## ุงููุดููุฉ 4: ุนุฏู ุชุญุฏูุซ ุชุงุฌ ุงููุณุชุฎุฏู ูู wall_posts

**ุงููููุน:** `server/routes.ts` ุงูุณุทุฑ 4381 ู schema `wall_posts`

**ุงููุตู:**
- ุนูุฏ ุฅูุดุงุก ููุดูุฑ ุฌุฏูุฏุ ูุชู ุญูุธ `userProfileTag` ูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงููุฉ
- ููู ุฅุฐุง ุชู ุชุบููุฑ ุชุงุฌ ุงููุณุชุฎุฏู ูุงุญูุงูุ ุงูููุดูุฑุงุช ุงููุฏููุฉ ูุง ูุชู ุชุญุฏูุซูุง
- ูุฐุง ูุชุนูุฏ (snapshot) ููู ูููู ุฃู ูุณุจุจ ุงุฑุชุจุงู ุญูุซ ูุฏ ูุธูุฑ ููุณ ุงููุณุชุฎุฏู ุจุชูุฌุงู ูุฎุชููุฉ ูู ููุดูุฑุงุช ูุฎุชููุฉ

**ุงูุชุฃุซูุฑ:** ุนุฏู ุงุชุณุงู ูู ุนุฑุถ ุงูุชูุฌุงู ูู ุงูุญุงุฆุท

---

## ุงููุดููุฉ 5: ุงูุจูุชุงุช ูุง ุชุฏุนู ุงูุชูุฌุงู

**ุงููููุน:** `shared/schema.ts` ุฌุฏูู `bots`

**ุงููุตู:**
- ุฌุฏูู `users` ูุญุชูู ุนูู `profileTag` (ุงูุณุทุฑ 53)
- ููู ุฌุฏูู `bots` (ุงูุณุทุฑ 613-641) ูุง ูุญุชูู ุนูู ุญูู `profileTag`
- ูุฐุง ูุนูู ูุง ูููู ุฅุถุงูุฉ ุชุงุฌ ููุจูุชุงุช

**ุงูุชุฃุซูุฑ:** ุงูุจูุชุงุช ูุง ูููู ุฃู ูููู ููุง ุชูุฌุงู ุญุชู ูู ุฃุฑุฏูุง ุฐูู

---

## ุงููุดููุฉ 6: ุนุฏู validation ููููุฉ profileTag

**ุงููููุน:** `server/routes.ts` ุงูุณุทุฑ 3360 ู `client/src/components/chat/UserPopup.tsx` ุงูุณุทุฑ 54

**ุงููุตู:**
- ูุง ููุฌุฏ ุงูุชุญูู ูู ุตุญุฉ ุงููููุฉ ูุจู ุงูุญูุธ
- ูููู ูููุณุชุฎุฏู ุฅุฑุณุงู ูููุฉ ุบูุฑ ุตุญูุญุฉ ูุซู `"../../../etc/passwd"`
- ุงูููุฏ ููุจู ุฃู ูููุฉ string ููุญูุธูุง ูุจุงุดุฑุฉ

**ุงูุชุฃุซูุฑ:** ุซุบุฑุฉ ุฃูููุฉ ูุญุชููุฉ - path traversal

---

## ุงููุดููุฉ 7: ุนุฏู ุงุชุณุงู ูู ูุนุงูุฌุฉ ุงูุชุงุฌ

**ุงููููุน:** `ProfileImage.tsx`ุ `WallPostList.tsx`ุ `UserSidebarWithWalls.tsx`

**ุงููุตู:**
ูู component ูุนุงูุฌ ุงูุชุงุฌ ุจุทุฑููุฉ ูุฎุชููุฉ ููููุงู:

**ProfileImage.tsx (ุงูุณุทุฑ 65-83):**
```typescript
const tagName = (user as any)?.profileTag as string | undefined;
const tagSrc: string | undefined = (() => {
  if (!tagName) return undefined;
  const str = String(tagName);
  if (str.startsWith('data:') || str.startsWith('/') || str.includes('/')) return str;
  const m = str.match(/(\d+)/);
  if (m && Number.isFinite(parseInt(m[1]))) {
    const n = Math.max(1, Math.min(50, parseInt(m[1])));
    return `/tags/tag${n}.webp`;
  }
  return `/tags/${str}`;
})();
```

**WallPostList.tsx (ุงูุณุทุฑ 108, 125-126):**
```typescript
const tagFromPost = (post as any)?.userProfileTag as string | undefined;
if (!('profileTag' in (effectiveUser as any)) && tagFromPost) {
  (effectiveUser as any).profileTag = tagFromPost;
}
```

**UserSidebarWithWalls.tsx (ุงูุณุทุฑ 801, 810):**
```typescript
const tagFromPost = (post as any)?.userProfileTag as string | undefined;
if (tagFromPost) (effectiveUser as any).profileTag = tagFromPost;
```

**ุงููุดููุฉ:** WallPostList ู UserSidebarWithWalls ูุณุชุฎุฏูุงู `userProfileTag` ุจูููุง ProfileImage ูุณุชุฎุฏู `profileTag`

**ุงูุชุฃุซูุฑ:** ูุฏ ูุญุฏุซ inconsistency ูู ุงูุนุฑุถ

---

## ุงููุดููุฉ 8: ุงูุณูุฑูุจุชุงุช ุชุฏุนู 12 ุชุงุฌ ููุท

**ุงููููุน:** `scripts/replace_tags.py` ู `scripts/replace_tags.mjs`

**ุงููุตู:**
- ุงูุณูุฑูุจุชุงุช ุชุญุชูู ุนูู 12 URL ููุท ูุชูุฒูู ุงูุชูุฌุงู (ุงูุณุทุฑ 11-24 ูู Python ู 8-21 ูู JS)
- ููู ุงูููุฏ ูุฏุนู ุญุชู 50 ุชุงุฌ
- ูุง ุชูุฌุฏ ุทุฑููุฉ ุณููุฉ ูุฅุถุงูุฉ ุชูุฌุงู ุฌุฏูุฏุฉ

**ุงูุชุฃุซูุฑ:** ุตุนูุจุฉ ุชูุณูุน ุงููุธุงู ูุฏุนู ุชูุฌุงู ุฅุถุงููุฉ

---

## ุงููุดููุฉ 9: ุนุฏู ูุนุงูุฌุฉ ุฃุฎุทุงุก ุชุญููู ุงูุชุงุฌ

**ุงููููุน:** `client/src/components/chat/ProfileImage.tsx` ุงูุณุทุฑ 169

**ุงููุตู:**
```typescript
onError={(e: any) => { try { e.currentTarget.style.display = 'none'; } catch {} }}
```
- ุนูุฏ ูุดู ุชุญููู ุตูุฑุฉ ุงูุชุงุฌุ ูุชู ุฅุฎูุงุกูุง ููุท
- ูุง ููุฌุฏ ุฅุดุนุงุฑ ูููุณุชุฎุฏู
- ูุง ููุฌุฏ fallback tag
- ูุง ูุชู logging ุงูุฎุทุฃ

**ุงูุชุฃุซูุฑ:** ุฃุฎุทุงุก ุงูุชุญููู ุชูุฎูู ุจุตูุช ููุฏ ูุง ููุงุญุธูุง ุฃุญุฏ

---

## ููุฎุต ุงูุฃููููุงุช

### ุฃููููุฉ ุนุงููุฉ ๐ด
1. **ุงููุดููุฉ 6:** ุฅุตูุงุญ validation (ุซุบุฑุฉ ุฃูููุฉ)
2. **ุงููุดููุฉ 1:** ุฅุถุงูุฉ layouts ููุชูุฌุงู ุงูููููุฏุฉ ุฃู ุงูุญุฏ ูู ุงูุนุฏุฏ ุงููุฏุนูู
3. **ุงููุดููุฉ 7:** ุชูุญูุฏ ูุนุงูุฌุฉ ุงูุชุงุฌ ูู ุฌููุน ุงูููููุงุช

### ุฃููููุฉ ูุชูุณุทุฉ ๐ก
4. **ุงููุดููุฉ 9:** ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก
5. **ุงููุดููุฉ 3:** ุชุญุฏูุซ ููู ุงูุงุฎุชุจุงุฑ
6. **ุงููุดููุฉ 2:** ุฅุถุงูุฉ ูููุงุช ููุชูุฌุงู ุงูููููุฏุฉ ุฃู ููุน ุงุณุชุฎุฏุงููุง

### ุฃููููุฉ ููุฎูุถุฉ ๐ข
7. **ุงููุดููุฉ 5:** ุฅุถุงูุฉ ุฏุนู ุงูุชูุฌุงู ููุจูุชุงุช (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
8. **ุงููุดููุฉ 4:** ุชูุซูู ุณููู snapshot ูู wall_posts
9. **ุงููุดููุฉ 8:** ุชุญุฏูุซ ุงูุณูุฑูุจุชุงุช ูุฏุนู ุงููุฒูุฏ ูู ุงูุชูุฌุงู

---

## ุงููููุงุช ุงููุชุฃุซุฑุฉ

### Frontend (Client)
1. `client/src/config/tagLayouts.ts`
2. `client/src/components/chat/ProfileImage.tsx`
3. `client/src/components/chat/UserPopup.tsx`
4. `client/src/components/chat/WallPostList.tsx`
5. `client/src/components/chat/UserSidebarWithWalls.tsx`
6. `client/public/test-tags.html`

### Backend (Server)
7. `server/routes.ts`
8. `shared/schema.ts`
9. `server/database-adapter.ts`

### Scripts
10. `scripts/replace_tags.py`
11. `scripts/replace_tags.mjs`

### Assets
12. `client/public/tags/` (directory)

---

## ุชูุตูุงุช ููุฅุตูุงุญ

### ุงูุญู ุงูููุชุฑุญ 1: ุงูุญุฏ ูู ุนุฏุฏ ุงูุชูุฌุงู ุงููุฏุนููุฉ
- ุชุบููุฑ ุงูุญุฏ ุงูุฃูุตู ูู 50 ุฅูู 12 ูู ุฌููุน ุงูุฃูุงูู
- ุฅุถุงูุฉ validation ุนูู ุงูุฎุงุฏู ูุฑูุถ ุฃู ุชุงุฌ > 12

### ุงูุญู ุงูููุชุฑุญ 2: ุชูุณูุน ุฏุนู ุงูุชูุฌุงู
- ุฅุถุงูุฉ layouts ูู 50 ุชุงุฌ ูู tagLayouts.ts
- ุฅุถุงูุฉ ูููุงุช webp ููุชูุฌุงู ุงูุฅุถุงููุฉ
- ุชุญุฏูุซ ุงูุณูุฑูุจุชุงุช ูุฏุนู ุงููุฒูุฏ

### ุงูุญู ุงูููุชุฑุญ 3: ุชูุญูุฏ ุงูููุฏ
- ุฅูุดุงุก utility function ูุงุญุฏุฉ ููุนุงูุฌุฉ ุงูุชุงุฌ
- ุงุณุชุฎุฏุงููุง ูู ุฌููุน ุงูููููุงุช
- ุฅุถุงูุฉ TypeScript types ุตุญูุญุฉ

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุงูุชุธุฑ ููุงููุฉ ุงููุณุชุฎุฏู ูุจู ุชูููุฐ ุงูุฅุตูุงุญุงุช.

---

**ุงูุชูู ุงูุชูุฑูุฑ**
