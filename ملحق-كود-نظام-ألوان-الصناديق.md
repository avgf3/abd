# ملحق: شرح مفصل لكود نظام ألوان صناديق المستخدمين

## 1. كود عرض المستخدم في القائمة 📋

### من ملف `UserSidebarWithWalls.tsx` (الأسطر 546-592):

```tsx
<li key={user.id} className="relative -mx-4">
  <SimpleUserMenu
    targetUser={user}
    currentUser={currentUser}
    showModerationActions={isModerator}
  >
    <div
      // تطبيق الكلاسات والأنماط المخصصة
      className={`flex items-center gap-2 p-2 px-4 rounded-none border-b border-border transition-all duration-200 cursor-pointer w-full ${getUserListItemClasses(user)} ${!getUserListItemClasses(user) ? 'bg-card hover:bg-accent/10' : ''}`}
      style={getUserListItemStyles(user)}
      onClick={(e) => handleUserClick(e, user)}
    >
      {/* صورة البروفايل */}
      <ProfileImage 
        user={user} 
        size="small" 
        className=""
        hideRoleBadgeOverlay={true}
      />
      
      {/* معلومات المستخدم */}
      <div className="flex-1">
        <div className="flex items-center justify-between gap-2">
          {/* اسم المستخدم بلونه المخصص */}
          <span 
            className="text-base font-medium transition-all duration-300"
            style={{ 
              color: getFinalUsernameColor(user),
              textShadow: getFinalUsernameColor(user) ? `0 0 10px ${getFinalUsernameColor(user)}40` : 'none',
              filter: getFinalUsernameColor(user) ? 'drop-shadow(0 0 3px rgba(255,255,255,0.3))' : 'none'
            }}
          >
            {user.username}
          </span>
          
          {/* الشارات */}
          <div className="flex items-center gap-1">
            {renderUserBadge(user)}
            {renderCountryFlag(user)}
          </div>
        </div>
      </div>
    </div>
  </SimpleUserMenu>
</li>
```

## 2. دالة تحديد أنماط الصندوق 🎨

### من ملف `themeUtils.ts` (الأسطر 196-236):

```typescript
export const getUserListItemStyles = (user: any): Record<string, string> => {
  const style: Record<string, string> = {};
  const isPrivileged = ['moderator', 'admin', 'owner'].includes(String(user?.userType || '').toLowerCase());

  // للمشرفين/الأدمن/الأونر: السلوك المتقدم
  if (isPrivileged) {
    // 1) تأثيرات الصندوق إذا وُجدت
    if (user?.profileEffect && user.profileEffect !== 'none') {
      return getUserEffectStyles(user);
    }

    // 2) ثيم المستخدم
    const theme = getThemeData(user?.userTheme || 'default');
    if (theme.gradient !== 'transparent') {
      const base = gradientToTransparent(theme.gradient, 0.08);
      if (user?.usernameColor) {
        const overlay = `linear-gradient(0deg, ${hexToRgba(String(user.usernameColor), 0.08)}, ${hexToRgba(String(user.usernameColor), 0.08)})`;
        style.background = `${overlay}, ${base}`;
      } else {
        style.background = base;
      }
    } else if (user?.usernameColor) {
      style.background = hexToRgba(String(user.usernameColor), 0.08);
    }

    // خط جانبي لإبراز اللون
    if (user?.usernameColor) {
      style.borderLeft = `3px solid ${String(user.usernameColor)}`;
    }

    return style;
  }

  // للمستخدمين العاديين: اجعل الصندوق يعتمد فقط على لون الاسم
  if (user?.usernameColor) {
    style.background = hexToRgba(String(user.usernameColor), 0.08);
    style.borderLeft = `3px solid ${String(user.usernameColor)}`;
  }

  return style;
};
```

## 3. دالة تحديد التأثيرات 🌟

### من ملف `themeUtils.ts` (الأسطر 150-193):

```typescript
export const getUserEffectStyles = (user: any): Record<string, string> => {
  const effect = (user && user.profileEffect) ? String(user.profileEffect) : 'none';
  const backgrounds: Record<string, string> = {
    'effect-glow': 'linear-gradient(135deg, rgba(255, 215, 0, 0.10), rgba(255, 215, 0, 0.05))',
    'effect-pulse': 'linear-gradient(135deg, rgba(255, 105, 180, 0.10), rgba(255, 105, 180, 0.05))',
    'effect-water': 'linear-gradient(135deg, rgba(0, 206, 209, 0.10), rgba(0, 206, 209, 0.05))',
    'effect-aurora': 'linear-gradient(135deg, rgba(155, 89, 182, 0.10), rgba(155, 89, 182, 0.05))',
    'effect-neon': 'linear-gradient(135deg, rgba(0, 255, 127, 0.12), rgba(0, 255, 127, 0.06))',
    'effect-fire': 'linear-gradient(135deg, rgba(255, 69, 0, 0.10), rgba(255, 69, 0, 0.05))',
    'effect-ice': 'linear-gradient(135deg, rgba(135, 206, 235, 0.10), rgba(135, 206, 235, 0.05))',
    'effect-rainbow': 'linear-gradient(135deg, rgba(236, 72, 153, 0.10), rgba(139, 92, 246, 0.05))',
    'effect-shadow': 'linear-gradient(135deg, rgba(0, 0, 0, 0.06), rgba(0, 0, 0, 0.03))',
    'effect-electric': 'linear-gradient(135deg, rgba(0, 191, 255, 0.10), rgba(0, 191, 255, 0.05))',
    'effect-crystal': 'linear-gradient(135deg, rgba(230, 230, 250, 0.10), rgba(230, 230, 250, 0.05))',
  };

  const style: Record<string, string> = {};
  if (effect && effect !== 'none') {
    const base = backgrounds[effect] || 'rgba(255,255,255,0.05)';
    if (user?.usernameColor) {
      // دمج لون المستخدم مع التأثير
      const overlay = `linear-gradient(0deg, ${hexToRgba(String(user.usernameColor), 0.10)}, ${hexToRgba(String(user.usernameColor), 0.10)})`;
      style.background = `${overlay}, ${base}`;
    } else {
      style.background = base;
    }
    return style;
  }

  // إذا لم يكن هناك تأثير، استخدم الثيم
  const theme = getThemeData(user?.userTheme || 'default');
  if (theme.gradient !== 'transparent') {
    const base = gradientToTransparent(theme.gradient, 0.12);
    if (user?.usernameColor) {
      const overlay = `linear-gradient(0deg, ${hexToRgba(String(user.usernameColor), 0.08)}, ${hexToRgba(String(user.usernameColor), 0.08)})`;
      style.background = `${overlay}, ${base}`;
    } else {
      style.background = base;
    }
  } else if (user?.usernameColor) {
    style.background = hexToRgba(String(user.usernameColor), 0.08);
  }

  return style;
};
```

## 4. تأثيرات CSS المتحركة 🎭

### من ملف `index.css` (أمثلة):

```css
/* تأثير التوهج الذهبي */
.effect-glow {
  animation: goldenGlow 4s ease-in-out infinite;
  box-shadow: 0 8px 32px rgba(0,0,0,0.8), 0 0 20px rgba(255,215,0,0.3);
}

@keyframes goldenGlow {
  0%, 100% {
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.5), inset 0 0 10px rgba(255, 215, 0, 0.2);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), inset 0 0 15px rgba(255, 215, 0, 0.3);
    transform: scale(1.02);
  }
}

/* تأثير النبض */
.effect-pulse {
  animation: gentlePulse 3s ease-in-out infinite;
}

@keyframes gentlePulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.03); opacity: 0.9; }
}

/* تأثير الماء */
.effect-water {
  animation: waterWave 5s ease-in-out infinite;
  position: relative;
  overflow: hidden;
}

.effect-water::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(0,206,209,0.1) 0%, transparent 70%);
  animation: waterRipple 5s linear infinite;
}

@keyframes waterWave {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

@keyframes waterRipple {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* تأثيرات الثيمات المتحركة */
.theme-animated {
  position: relative;
  overflow: hidden;
  animation: themeGlow 3s ease-in-out infinite;
}

.theme-animated::before {
  content: '';
  position: absolute;
  top: -2px;
  right: -2px;
  bottom: -2px;
  left: -2px;
  background: inherit;
  filter: blur(8px);
  opacity: 0.5;
  z-index: -1;
  animation: themePulse 3s ease-in-out infinite;
}

@keyframes themeGlow {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.95; }
}

@keyframes themePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}
```

## 5. دالة تحويل الألوان 🔄

### من ملف `themeUtils.ts` (الأسطر 109-132):

```typescript
// تحويل HEX إلى RGBA بنسبة شفافية
const hexToRgba = (hex: string, alpha: number): string => {
  const match = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex.trim());
  if (!match) return hex;
  const r = parseInt(match[1], 16);
  const g = parseInt(match[2], 16);
  const b = parseInt(match[3], 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
};

// دالة لتحويل التدرج اللوني إلى تدرج شفاف
const gradientToTransparent = (gradient: string, opacity: number): string => {
  // استخراج الألوان من التدرج
  const colors = gradient.match(/#[a-fA-F0-9]{6}/g);
  if (!colors) return gradient;
  
  // تحويل كل لون إلى RGBA مع الشفافية المطلوبة
  let newGradient = gradient;
  colors.forEach(color => {
    const rgba = hexToRgba(color, opacity);
    newGradient = newGradient.replace(color, rgba);
  });
  
  return newGradient;
};
```

## 6. مثال على بيانات المستخدم 📊

```typescript
// مثال على بيانات مستخدم مع كل الخصائص المؤثرة على اللون
const exampleUser = {
  id: 123,
  username: "محمد",
  userType: "admin",              // يحدد إذا كان له صلاحيات متقدمة
  usernameColor: "#FFD700",       // لون الاسم (ذهبي)
  userTheme: "golden",            // الثيم العام
  profileEffect: "effect-glow",   // التأثير المتحرك
  level: 25,
  gender: "male",
  country: "🇸🇦 السعودية"
};

// النتيجة:
// - اسم المستخدم: ذهبي متوهج
// - خلفية الصندوق: تدرج ذهبي شفاف مع توهج متحرك
// - خط جانبي: ذهبي
// - شارة: نجمة (⭐) للأدمن
```

## 7. ترتيب تطبيق الألوان (Cascade) 🎯

```
1. هل المستخدم مشرف/أدمن/مالك؟
   ├─ نعم → 
   │   ├─ هل له تأثير (profileEffect)؟
   │   │   ├─ نعم → استخدم التأثير + دمج لون الاسم
   │   │   └─ لا → هل له ثيم (userTheme)؟
   │   │       ├─ نعم → استخدم الثيم + دمج لون الاسم
   │   │       └─ لا → استخدم لون الاسم فقط
   │   └─ أضف خط جانبي بلون الاسم
   │
   └─ لا (عضو عادي) → 
       └─ استخدم لون الاسم فقط (خلفية + خط جانبي)
```

## 8. نصائح للمطورين 💡

### لإضافة تأثير جديد:

1. **أضف التأثير في `getUserEffectStyles()`**:
```typescript
'effect-sparkle': 'linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05))',
```

2. **أضف CSS في `index.css`**:
```css
.effect-sparkle {
  animation: sparkle 2s ease-in-out infinite;
  position: relative;
}

.effect-sparkle::after {
  content: '✨';
  position: absolute;
  top: 2px;
  right: 5px;
  animation: sparkleFloat 3s ease-in-out infinite;
}

@keyframes sparkle {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

@keyframes sparkleFloat {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-5px) rotate(180deg); }
}
```

3. **أضف التأثير في قائمة التأثيرات المتاحة في قاعدة البيانات**

### لتغيير أولويات التطبيق:

عدّل دالة `getUserListItemStyles()` في السطر 199 لتغيير الشروط أو ترتيب الأولويات.

## 9. اختبار التغييرات 🧪

```javascript
// سكريبت اختبار في console المتصفح
const testUser = {
  id: 999,
  username: "اختبار",
  userType: "admin",
  usernameColor: "#FF0000",
  userTheme: "fire",
  profileEffect: "effect-fire"
};

// اختبار الدوال
console.log("Styles:", getUserListItemStyles(testUser));
console.log("Classes:", getUserListItemClasses(testUser));
console.log("Username Color:", getFinalUsernameColor(testUser));
```