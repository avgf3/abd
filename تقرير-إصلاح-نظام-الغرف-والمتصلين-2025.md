# تقرير إصلاح نظام الانضمام وقائمة المتصلين - يناير 2025

## المشاكل التي تم حلها:

### 1. مشكلة بقاء المستخدم في الغرفة السابقة عند التبديل

**المشكلة:**
- عند تغيير الغرفة، كان المستخدم يظل في قائمة المتصلين للغرفة السابقة
- لم يكن هناك آلية لمغادرة الغرفة السابقة تلقائياً

**الحل:**
- تحديث `roomService.joinRoom()` لتنفيذ مغادرة الغرفة السابقة تلقائياً قبل الانضمام للجديدة
- تحديث `handleRoomJoin()` في الخادم للتحقق من الغرفة الحالية أولاً
- إضافة فحص لمنع الانضمام المتكرر لنفس الغرفة

### 2. مشكلة عدم تحديث قائمة المتصلين

**المشكلة:**
- قائمة المتصلين لا تُحدث بشكل دوري
- العميل لا يطلب قائمة المتصلين من الخادم
- القائمة تعتمد على الأحداث فقط

**الحل:**
- إضافة آلية طلب دوري لقائمة المتصلين كل 30 ثانية
- طلب القائمة عند الانضمام لغرفة جديدة
- طلب القائمة عند الاتصال الأولي
- تحسين دالة `sendRoomUsers()` لفلترة أفضل

### 3. مشكلة فترة السماح الطويلة (5 دقائق)

**المشكلة:**
- المستخدم يظل في القائمة لمدة 5 دقائق بعد قطع الاتصال

**الحل:**
- تقليل فترة السماح من 5 دقائق إلى 30 ثانية
- تحسين آلية التنظيف الدوري

### 4. التكرارات والتعارضات في الكود

**المشكلة:**
- معالجات متعددة لأحداث `kicked` و `blocked` و `error`
- تكرار في معالجة الرسائل الخاصة

**الحل:**
- إزالة المعالجات المكررة
- توحيد معالجة الأحداث في معالج `message` الرئيسي

## التحسينات المضافة:

### 1. في الخادم (server/routes.ts):
```typescript
// تقليل فترة السماح
const GRACE_PERIOD_MS = 30 * 1000; // 30 ثانية بدلاً من 5 دقائق

// تحسين فلترة المستخدمين
async function sendRoomUsers(roomId: string) {
  const roomUsers = Array.from(connectedUsers.values())
    .filter(conn => {
      if (conn.room !== roomId) return false;
      if (!conn.user || !conn.user.id) return false;
      if ((conn.user as any).isHidden) return false;
      return true;
    })
    .map(conn => ({
      ...conn.user,
      lastSeen: conn.lastSeen
    }));
  // إرسال القائمة
}

// تحسين معالج الانضمام
async function handleRoomJoin() {
  // مغادرة الغرفة السابقة أولاً
  if (currentRoom && currentRoom !== roomId) {
    await handleRoomLeave(socket, userId, username, currentRoom, false);
  }
  // ثم الانضمام للجديدة
}
```

### 2. في خدمة الغرف (server/services/roomService.ts):
```typescript
async joinRoom(userId: number, roomId: string) {
  // مغادرة الغرفة السابقة تلقائياً
  const previousRoom = this.userRooms.get(userId);
  if (previousRoom && previousRoom !== roomId) {
    await this.leaveRoom(userId, previousRoom);
  }
  // ثم الانضمام للجديدة
}
```

### 3. في العميل (client/src/hooks/useChat.ts):
```typescript
// طلب دوري لقائمة المتصلين
const requestOnlineUsers = () => {
  if (socketInstance.connected) {
    socketInstance.emit('requestOnlineUsers');
  }
};

// كل 30 ثانية
const onlineUsersInterval = setInterval(requestOnlineUsers, 30000);

// عند الانضمام لغرفة
case 'roomJoined': {
  setTimeout(() => {
    socketInstance.emit('requestOnlineUsers');
  }, 500);
}
```

## النتائج:

1. ✅ المستخدم يُزال من الغرفة السابقة فوراً عند التبديل
2. ✅ قائمة المتصلين تُحدث كل 30 ثانية
3. ✅ المستخدم يُزال من القائمة بعد 30 ثانية من قطع الاتصال
4. ✅ لا توجد معالجات مكررة للأحداث
5. ✅ الكود أصبح أكثر كفاءة وأقل تعقيداً

## ملاحظات للمطورين:

- عند إضافة أي معالج جديد، تأكد من عدم تكراره
- استخدم `requestOnlineUsers` لطلب قائمة المتصلين
- فترة السماح الآن 30 ثانية فقط
- دالة `joinRoom` تتعامل مع المغادرة تلقائياً