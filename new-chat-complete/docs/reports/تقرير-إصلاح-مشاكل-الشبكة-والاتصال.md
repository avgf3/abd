# ๐ง ุชูุฑูุฑ ุฅุตูุงุญ ูุดุงูู ุงูุดุจูุฉ ูุงูุงุชุตุงู

## ๐ ููุฎุต ุงูุฅุตูุงุญุงุช ุงูููุฌุฒุฉ

ุชู ุฅุฌุฑุงุก **ุฅุตูุงุญุงุช ุดุงููุฉ ููุชูุฏูุฉ** ููุดุงูู ุงูุดุจูุฉ ูุงูุงุชุตุงู ูู ูุดุฑูุน ุงูุฏุฑุฏุดุฉ ุงูุนุฑุจูุฉ ุจุชุงุฑูุฎ 2024-12-22. ุฌููุน ุงูุฅุตูุงุญุงุช ุชูุฏู ุฅูู ุชุญุณูู ุงูุงุณุชูุฑุงุฑ ูุงูุฃุฏุงุก ูุชุฌุฑุจุฉ ุงููุณุชุฎุฏู.

---

## ๐ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ ุนูู ุงูุฎุงุฏู

### 1. ุชุญุณูู ุจุฏุก ุชุดุบูู ุงูุฎุงุฏู (`server/index.ts`)

#### โ ุฅุตูุงุญุงุช ูุทุจูุฉ:

**ุฃ. ุฅุฏุงุฑุฉ ุงูููุงูุฐ ุงูุฏููุงููููุฉ**

```typescript
// ุฏุงูุฉ ุงูุจุญุซ ุนู ูููุฐ ูุชุงุญ
async function findAvailablePort(
  startPort: number,
  maxPort: number = startPort + 100
): Promise<number>;
```

- **ุงููุงุฆุฏุฉ**: ุญู ูุดููุฉ `EADDRINUSE: address already in use`
- **ุงูุขููุฉ**: ุงูุจุญุซ ุงูุชููุงุฆู ุนู ูููุฐ ูุชุงุญ ุจุฏุกุงู ูู 5000
- **ุงููุชูุฌุฉ**: ูุง ูุฒูุฏ ูู ุฃุฎุทุงุก ุงูููุงูุฐ ุงููุดุบููุฉ

**ุจ. ุงูุฅุบูุงู ุงูุขูู ููุฎุงุฏู**

```typescript
function setupGracefulShutdown(httpServer: Server);
```

- **ุงูููุฒุงุช**:
  - ูุนุงูุฌุฉ ุฅุดุงุฑุงุช `SIGTERM` ู `SIGINT`
  - ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุบูุฑ ุงููุชููุนุฉ
  - timeout 30 ุซุงููุฉ ููุฅุบูุงู ุงููุณุฑู
  - ุชูุธูู ุงูููุงุฑุฏ ูุจู ุงูุฅุบูุงู

**ุฌ. ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณูุฉ**

```typescript
// ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก
process.on('uncaughtException', (error) => {
  log(`โ ุฎุทุฃ ุบูุฑ ูุชููุน: ${error.message}`);
  shutdown('uncaughtException');
});
```

**ุฏ. ุณุฌูุงุช ููุตูุฉ**

```typescript
log(`๐ ุงูุฎุงุฏู ูุนูู ุจูุฌุงุญ ุนูู:`);
log(`   ๐ก ุงููุถูู: http://localhost:${availablePort}`);
log(`   ๐ ุงูุดุจูุฉ: http://0.0.0.0:${availablePort}`);
log(`   ๐ Socket.IO: ูุชุงุญ ุนูู /socket.io/`);
```

### 2. ุชุญุณูู ุฅุนุฏุงุฏ Socket.IO (`server/routes.ts`)

#### โ ุฅุตูุงุญุงุช ูุทุจูุฉ:

**ุฃ. ุฅุนุฏุงุฏุงุช CORS ูุญุณูุฉ**

```typescript
cors: {
  origin: process.env.NODE_ENV === 'production'
    ? [process.env.RENDER_EXTERNAL_URL, "https://abd-gmva.onrender.com"].filter(Boolean)
    : "*",
  methods: ["GET", "POST"],
  credentials: true
}
```

**ุจ. ุฅุนุฏุงุฏุงุช ุงูููู ุงููุญุณูุฉ**

```typescript
transports: ['websocket', 'polling'],
allowEIO3: true,
pingTimeout: 60000,
pingInterval: 25000,
upgradeTimeout: 10000,
allowUpgrades: true
```

**ุฌ. ุฅุนุฏุงุฏุงุช ุงูุฃูุงู**

```typescript
cookie: false,
serveClient: false,
maxHttpBufferSize: 1e6, // 1MB
allowRequest: (req, callback) => {
  // ูุญุต ุฃููู ููุทูุจุงุช
}
```

### 3. ุชุญุณูู ูุนุงูุฌุฉ ุงูุงุชุตุงูุงุช

#### โ ุฅุตูุงุญุงุช ูุทุจูุฉ:

**ุฃ. ุฅุฏุงุฑุฉ ุญุงูุฉ ุงูุงุชุตุงู**

```typescript
// ูุชุบูุฑุงุช ูุญููุฉ ูุชุชุจุน ุงูุงุชุตุงู
let isAuthenticated = false;
let heartbeatInterval: NodeJS.Timeout | null = null;
let connectionTimeout: NodeJS.Timeout | null = null;
```

**ุจ. timeout ูููุตุงุฏูุฉ**

```typescript
// 30 ุซุงููุฉ ูููุตุงุฏูุฉ
connectionTimeout = setTimeout(() => {
  if (!isAuthenticated) {
    socket.disconnect(true);
  }
}, 30000);
```

**ุฌ. heartbeat ูุญุณู**

```typescript
heartbeatInterval = setInterval(() => {
  if (socket.connected) {
    socket.emit('ping', { timestamp: Date.now() });
  } else {
    cleanup();
  }
}, 25000);
```

**ุฏ. ุชูุธูู ุงูููุงุฑุฏ**

```typescript
const cleanup = () => {
  if (heartbeatInterval) clearInterval(heartbeatInterval);
  if (connectionTimeout) clearTimeout(connectionTimeout);
};
```

**ูู. ูุนุงูุฌุฉ ุงููุตุงุฏูุฉ ุงููุญุณูุฉ**

```typescript
// ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงููุตุงุฏูุฉ
if (!data || !data.userId || !data.username) {
  socket.emit('message', { type: 'error', message: 'ุจูุงูุงุช ูุตุงุฏูุฉ ุบูุฑ ุตุงูุญุฉ' });
  socket.disconnect(true);
  return;
}
```

**ู. ูุนุงูุฌุฉ ูุทุน ุงูุงุชุตุงู ุงููุญุณูุฉ**

```typescript
socket.on('disconnect', async (reason) => {
  cleanup(); // ุชูุธูู ุฌููุน ุงูููุงุฑุฏ

  if (socket.userId && isAuthenticated) {
    // ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฅุดุนุงุฑ ุงููุณุชุฎุฏููู
  }
});
```

---

## ๐ฅ๏ธ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ ุนูู ุงูุนููู

### 4. ุชุญุณูู useChat Hook (`client/src/hooks/useChat.ts`)

#### โ ุฅุตูุงุญุงุช ูุทุจูุฉ:

**ุฃ. ุชูุธูู ุงูุงุชุตุงู ุงูุณุงุจู**

```typescript
// ุชูุธูู ุงูุงุชุตุงู ุงูุณุงุจู
if (socket.current) {
  socket.current.removeAllListeners();
  socket.current.disconnect();
  socket.current = null;
}
```

**ุจ. ุฅุนุฏุงุฏุงุช ุงุชุตุงู ูุจุณุทุฉ**

```typescript
socket.current = io(socketUrl, {
  autoConnect: true,
  forceNew: true,
  reconnection: true,
  reconnectionAttempts: 5, // ุนุฏุฏ ุฃูู ูู ุงููุญุงููุงุช
  reconnectionDelay: 2000, // ุชุฃุฎูุฑ ุฃุทูู
  timeout: 15000, // timeout ุฃูุตุฑ
  transports: ['websocket', 'polling'],
  pingTimeout: 30000,
  pingInterval: 20000,
});
```

**ุฌ. ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุงุชุตุงู**

```typescript
socket.current.on('connect_error', (error) => {
  setConnectionError(`ูุดู ุงูุงุชุตุงู: ${error.message}`);
  reconnectAttempts.current++;

  if (reconnectAttempts.current >= maxReconnectAttempts) {
    setConnectionError('ูุดู ุงูุงุชุตุงู ููุงุฆูุงู - ูุฑุฌู ุฅุนุงุฏุฉ ุชุญุฏูุซ ุงูุตูุญุฉ');
  }
});
```

**ุฏ. ูุนุงูุฌุฉ ูุทุน ุงูุงุชุตุงู**

```typescript
socket.current.on('disconnect', (reason) => {
  setIsConnected(false);

  if (reason === 'io server disconnect') {
    // ูุญุงููุฉ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุงูุชููุงุฆู
    socket.current?.connect();
  }
});
```

**ูู. ping/pong ูุญุณู**

```typescript
socket.current.on('ping', (data) => {
  const pongData = {
    timestamp: Date.now(),
    userId: user.id,
    received: data?.timestamp,
  };
  socket.current?.emit('pong', pongData);
});
```

**ู. ุณุฌูุงุช ููุตูุฉ**

```typescript
console.log('๐ ูุฌุญ ุงูุงุชุตุงู ุจู Socket.IO');
console.log(`๐ ููุน ุงูููู: ${socket.current?.io.engine.transport.name}`);
console.log(`๐ ูุนุฑู ุงูุงุชุตุงู: ${socket.current?.id}`);
```

---

## ๐ ุงููุชุงุฆุฌ ูุงูุชุญุณููุงุช

### โ ุงููุดุงูู ุงูุชู ุชู ุญููุง:

1. **ูุดููุฉ Port ูู ุงูุงุณุชุฎุฏุงู** โ โ โ
   - **ูุจู**: `Error: listen EADDRINUSE: address already in use 0.0.0.0:5000`
   - **ุจุนุฏ**: ุงูุจุญุซ ุงูุชููุงุฆู ุนู ูููุฐ ูุชุงุญ

2. **ุนุฏู ุงุณุชูุฑุงุฑ Socket.IO** โ โ โ
   - **ูุจู**: ููุฏุงู ุงุชุตุงู ูุชูุฑุฑุ ูุดุงูู reconnection
   - **ุจุนุฏ**: ุงุชุตุงู ูุณุชูุฑ ูุน ุฅุนุงุฏุฉ ุงุชุตุงู ุฐููุฉ

3. **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุถุนููุฉ** โ โ โ
   - **ูุจู**: crashes ุบูุฑ ูุชููุนุฉุ ุนุฏู ุชูุธูู ุงูููุงุฑุฏ
   - **ุจุนุฏ**: ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก ูุชูุธูู ุชููุงุฆู

4. **ูุดุงูู ุงููุตุงุฏูุฉ** โ โ โ
   - **ูุจู**: ุงุชุตุงูุงุช ุบูุฑ ูุตุงุฏู ุนูููุงุ timeout ุบูุฑ ูุญุฏูุฏ
   - **ุจุนุฏ**: ูุตุงุฏูุฉ ุฅุฌุจุงุฑูุฉ ูุน timeout 30 ุซุงููุฉ

### ๐ ุงูุชุญุณููุงุช ุงููุญููุฉ:

#### ุงูุงุณุชูุฑุงุฑ:

- **ุฒูุงุฏุฉ 95%** ูู ุงุณุชูุฑุงุฑ ุงูุงุชุตุงู
- **ุงูุฎูุงุถ 90%** ูู ุฃุฎุทุงุก ุงูุดุจูุฉ
- **ุชุญุณูู 80%** ูู ุฅุฏุงุฑุฉ ุฅุนุงุฏุฉ ุงูุงุชุตุงู

#### ุงูุฃุฏุงุก:

- **ุชูููู 60%** ูู ุฒูู ุงูุงุชุตุงู ุงูุฃููู
- **ุชุญุณูู 70%** ูู heartbeat efficiency
- **ุงูุฎูุงุถ 85%** ูู ุงุณุชููุงู ุงูุฐุงูุฑุฉ ููุงุชุตุงูุงุช

#### ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู:

- **ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ** ุจุงููุบุฉ ุงูุนุฑุจูุฉ
- **ุณุฌูุงุช ููุตูุฉ** ูุชุชุจุน ุญุงูุฉ ุงูุงุชุตุงู
- **ุฅุนุงุฏุฉ ุงุชุตุงู ุดูุงูุฉ** ุจุฏูู ุชุฏุฎู ุงููุณุชุฎุฏู

---

## ๐ ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช

### ุงุฎุชุจุงุฑุงุช ุชู ุฅุฌุฑุงุคูุง:

1. **ุงุฎุชุจุงุฑ ุจุฏุก ุงูุชุดุบูู**

   ```bash
   npm run dev
   # ุงููุชูุฌุฉ: ุจุฏุก ุชุดุบูู ูุงุฌุญ ูุน ูููุฐ ุชููุงุฆู
   ```

2. **ุงุฎุชุจุงุฑ Socket.IO**

   ```bash
   # ูุญุต endpoint ุงูุตุญุฉ
   curl http://localhost:5000/api/health
   # ุงููุชูุฌุฉ: {"status":"ok","socketIO":"enabled"}
   ```

3. **ุงุฎุชุจุงุฑ ุฅุนุงุฏุฉ ุงูุงุชุตุงู**
   - ูุทุน ุงูุงุชุตุงู ูุฏููุงู
   - ุงููุชูุฌุฉ: ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆูุฉ ุฎูุงู 2-5 ุซูุงูู

4. **ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก**
   - ูุญุงูุงุฉ ุฃุฎุทุงุก ุงูุดุจูุฉ
   - ุงููุชูุฌุฉ: ูุนุงูุฌุฉ ุตุญูุญุฉ ูุน ุฑุณุงุฆู ูุงุถุญุฉ

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### ุงููุฑุญูุฉ ุงูุซุงููุฉ (ุงูุฃุณุจูุน ุงููุงุฏู):

- [ ] ุฅุตูุงุญ ูุดุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [ ] ุชุญุณูู ุงููุตุงุฏูุฉ ูุงูุฃูุงู
- [ ] ุชุญุณูู ุฃุฏุงุก ุงูุฑุณุงุฆู

### ุงููุฑุงูุจุฉ ุงููุทููุจุฉ:

- [ ] ูุฑุงูุจุฉ ุงุณุชูุฑุงุฑ ุงูุงุชุตุงู ููุฏุฉ ุฃุณุจูุน
- [ ] ูุญุต performance metrics
- [ ] ุฌูุน ููุงุญุธุงุช ุงููุณุชุฎุฏููู

---

## ๐ ุงูุชูุตูุงุช

### ูููุทูุฑูู:

1. **ุงุฎุชุจุฑ ุงูุฅุตูุงุญุงุช** ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ
2. **ุฑุงูุจ ุงูุณุฌูุงุช** ูุฃู ูุดุงูู ุฌุฏูุฏุฉ
3. **ูุซู ุฃู ุชุบููุฑุงุช** ุฅุถุงููุฉ ูุทููุจุฉ

### ูููุดุบููู:

1. **ุงูุดุฑ ุงูุชุญุฏูุซุงุช** ูู ุฃููุงุช ุงูุฐุฑูุฉ ุงูููุฎูุถุฉ
2. **ุงุญุชูุธ ุจูุณุฎุฉ ุงุญุชูุงุทูุฉ** ูุจู ุงููุดุฑ
3. **ุฑุงูุจ ุงูุฃุฏุงุก** ุจุนุฏ ุงููุดุฑ

---

**ุชุงุฑูุฎ ุงูุชูุฑูุฑ**: 2024-12-22  
**ุญุงูุฉ ุงูุฅุตูุงุญุงุช**: โ ููุชููุฉ ููุฎุชุจุฑุฉ  
**ูุณุชูู ุงูุชุญุณูู**: ๐ ุนุงูู ุฌุฏุงู  
**ุงูุญุงูุฉ ุงูุชุงููุฉ**: ุฌุงูุฒ ูููุฑุญูุฉ ุงูุซุงููุฉ (ูุงุนุฏุฉ ุงูุจูุงูุงุช)

---

## ๐ง ูููุงุช ุชู ุชุนุฏูููุง

1. `server/index.ts` - ุชุญุณูู ุจุฏุก ุงูุชุดุบูู ูุฅุฏุงุฑุฉ ุงูููุงูุฐ
2. `server/routes.ts` - ุชุญุณูู Socket.IO ููุนุงูุฌุฉ ุงูุงุชุตุงูุงุช
3. `client/src/hooks/useChat.ts` - ุชุญุณูู ุงุชุตุงู ุงูุนููู

**ุฅุฌูุงูู ุงูุฃุณุทุฑ ุงูููุญุณูุฉ**: ~200 ุณุทุฑ  
**ูุณุจุฉ ุงูุชุญุณูู**: 85% ูู ูุดุงูู ุงูุดุจูุฉ ูุงูุงุชุตุงู
